<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - í†µê³„</title>
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="statistics.css">

    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="auth.js"></script>
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left"><a href="index.html">
                    <picture>
                        <source srcset="logo.avif" type="image/avif"><img src="logo.png" alt="í•„ë¦¬ì•„í…”ë ˆì½¤ ë¡œê³ "
                            class="header-logo">
                    </picture>
                </a>
            </div>
            <div class="header-center">
                <div class="common-box font-35pt">í†µê³„ ë¶„ì„</div>
            </div>
            <div class="header-right">
                <div class="common-box font-15pt time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div class="statistics-controls">
                <input type="number" id="order-year-input" placeholder="ì˜ˆ: 2025">
                <select id="order-month-select">
                </select>
                <div class="common-box font-15pt clickable-box search-btn" id="search-stats-btn">ì¡°íšŒ</div>
            </div>

            <div id="statistics-result-area">
                <p class="no-data-message" style="text-align: center;">ì¡°íšŒí•  ì£¼ë¬¸ì›”ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
            </div>

        </main>

        <footer class="main-footer">
            <div class="footer-left">
            </div>
            <div class="footer-center">
                <div class="common-box font-15pt clickable-box" id="back-btn"><i class="fas fa-arrow-left"></i></div>
                <div class="common-box font-15pt clickable-box" id="home-btn"><i class="fas fa-home"></i></div>
                <div class="common-box font-15pt clickable-box" id="forward-btn"><i class="fas fa-arrow-right"></i>
                </div>
            </div>
            <div class="footer-right">
            </div>
        </footer>

        <div class="modal-overlay" id="details-modal">
            <div class="modal-window">
                <button class="close-btn" id="close-details-modal-btn">&times;</button>
                <h2 class="modal-title" id="details-modal-title">ìƒì„¸ ë‚´ì—­</h2>

                <div class="modal-content" id="details-modal-content">
                </div>
            </div>
        </div>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const monthSelect = document.getElementById('order-month-select');
            const searchBtn = document.getElementById('search-stats-btn');
            const resultArea = document.getElementById('statistics-result-area');
            const timeDisplay = document.getElementById('current-time');

            // â–¼â–¼â–¼ [ì‹ ê·œ] 'ì£¼ë¬¸ ì—°ë„' ì…ë ¥ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. â–¼â–¼â–¼
            const yearInput = document.getElementById('order-year-input');
            const detailsModal = document.getElementById('details-modal');
            const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
            const detailsModalTitle = document.getElementById('details-modal-title');
            const detailsModalContent = document.getElementById('details-modal-content');

            // --- 2. 'ì£¼ë¬¸ì›”' ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ---
            monthSelect.innerHTML = '<option value="">-ì„ íƒ-</option>';
            for (let i = 1; i <= 12; i++) {
                const monthText = `${i}ì›”ë¶„`;
                monthSelect.innerHTML += `<option value="${monthText}">${monthText}</option>`;
            }

            // â–¼â–¼â–¼ [ì‹ ê·œ] 'ì£¼ë¬¸ ì—°ë„' ê¸°ë³¸ê°’ìœ¼ë¡œ í˜„ì¬ ì—°ë„ ì„¤ì • â–¼â–¼â–¼
            yearInput.value = new Date().getFullYear();

            document.addEventListener('click', async (event) => {

                // [A] 'ì¡°íšŒ' ë²„íŠ¼ í´ë¦­ ì‹œ
                if (event.target === searchBtn) {
                    const selectedMonth = monthSelect.value;
                    const selectedYear = yearInput.value;

                    if (!selectedYear || !selectedMonth) {
                        alert('ì£¼ë¬¸ ì—°ë„ì™€ ì£¼ë¬¸ì›”ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }

                    resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>`;

                    try {
                        const response = await fetch(`http://127.0.0.1:5000/api/statistics/order_month_summary?order_month=${selectedMonth}&year=${selectedYear}`);
                        if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                        const summaryData = await response.json();
                        renderStatisticsTable(summaryData, selectedMonth);
                    } catch (error) {
                        console.error('í†µê³„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                        resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>`;
                    }
                }

                // [B] 'ìƒì„¸' ë²„íŠ¼ í´ë¦­ ì‹œ
                if (event.target.classList.contains('stats-details-btn')) {
                    const button = event.target;
                    const model = button.dataset.model;
                    const year = button.dataset.year;
                    const month = button.dataset.month;
                    openDetailsModal(model, year, month);
                }
            });

            function renderStatisticsTable(data, selectedMonth) {
                if (!data || data.length === 0) {
                    resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">'${selectedMonth}'ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                // â–¼â–¼â–¼ [ìˆ˜ì •] 4ê°œ ì—´ë¡œ ë³€ê²½ (ëª¨ë¸ëª…, ì´ ì£¼ë¬¸, ì‹¤ìƒì‚°, ìƒì„¸) â–¼â–¼â–¼
                let tableHTML = `<table class="editable-table statistics-table">
                    <colgroup>
                        <col style="width: 30%;"> <col style="width: 30%;"> <col style="width: 30%;"> <col style="width: 10%;"> </colgroup>
                    <thead>
                        <tr>
                            <th>ëª¨ë¸ëª…</th>
                            <th>ì´ì£¼ë¬¸ëŸ‰</th>
                            <th>ì‹¤ìƒì‚°ì´í•©</th>
                            <th>ìƒì„¸ë‚´ì—­</th>
                        </tr>
                    </thead>
                    <tbody>`;

                data.forEach(item => {

                    let problemClass = '';
                    if (item.status === 'shortage') {
                        problemClass = 'stats-problem-yellow'; // ë…¸ë€ìƒ‰
                    } else if (item.status === 'imbalance') {
                        problemClass = 'stats-problem-red'; // ë¹¨ê°„ìƒ‰
                    }

                    tableHTML += `
                        <tr>
                            <td>${item.model}</td>
                            <td>${item.totalQuantity.toLocaleString()}</td>
                            <td class="${problemClass}">${item.actualProduction.toLocaleString()}</td>
                            
                            <td><button class="stats-details-btn" 
                                data-model="${item.model}" 
                                data-year="${item.orderYear}" 
                                data-month="${item.orderMonth}">ğŸ”</button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                resultArea.innerHTML = tableHTML;
            }

            async function openDetailsModal(model, year, month) {
                detailsModalTitle.textContent = `${model} (${year}ë…„ ${month}) ìƒì„¸ ë‚´ì—­`;
                detailsModalContent.innerHTML = `<p class="no-data-message" style="text-align: center;">ìƒì„¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>`;
                detailsModal.classList.add('visible');

                try {
                    // 1. ìƒì„¸ ë‚´ì—­ API í˜¸ì¶œ
                    const response = await fetch(`http://127.0.0.1:5000/api/statistics/model_details?model=${encodeURIComponent(model)}&year=${year}&month=${encodeURIComponent(month)}`);
                    if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');

                    const detailsData = await response.json();

                    // 2. ìƒì„¸ ë‚´ì—­ í…Œì´ë¸” ìƒì„±
                    if (detailsData.length === 0) {
                        detailsModalContent.innerHTML = `<p class="no-data-message" style="text-align: center;">ìƒì„¸ ë‚´ì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        return;
                    }

                    let tableHTML = `<table class="editable-table" id="details-modal-table">
                        <thead>
                            <tr>
                                <th>ìƒì‚° ì£¼ì°¨</th>
                                <th>ë¼ì¸</th>
                                <th>T/B</th>
                                <th>ì£¼ë¬¸ëŸ‰(LOT)</th>
                                <th>ì‹¤ìƒì‚°ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    detailsData.forEach(item => {

                        // â–¼â–¼â–¼ [ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§] â–¼â–¼â–¼

                        // 1. "50/100" ë˜ëŠ” "50"ì—ì„œ '/' ì•ì˜ 'ê³„íšëŸ‰'ì„ ìˆ«ìë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                        const lotParts = (item.lot || '0').split('/');
                        const batchQty = parseInt(lotParts[0], 10) || 0;

                        // 2. 'ì‹¤ìƒì‚°ëŸ‰'ì„ ìˆ«ìë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                        const actualProd = parseInt(item.actualProd, 10) || 0;

                        // 3. 'isPair' ì¡°ê±´ ì—†ì´, ì‹¤ìƒì‚°ëŸ‰ì´ ê³„íšëŸ‰(batch)ë³´ë‹¤ ì ìœ¼ë©´ 'ë¬¸ì œ'ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
                        const isProblem = actualProd !== batchQty;
                        const problemClass = isProblem ? 'stats-problem-yellow' : ''; // (statistics.cssì˜ .stats-problem í´ë˜ìŠ¤)

                        // (ë‚ ì§œ í¬ë§·)
                        const prodWeekFormatted = `${String(item.prod_year).slice(-2)}-${item.prod_month}-${item.prod_week}`;
                        const linkURL = `production.html?year=${item.prod_year}&month=${item.prod_month}&week=${item.prod_week}`;
                        tableHTML += `
                            <tr>
                                <td><a href="${linkURL}">${prodWeekFormatted}</a></td>
                                <td>${item.line}</td>
                                <td>${item.tb}</td>
                                <td>${item.lot}</td>
                                <td class="${problemClass}">${item.actualProd}</td>
                            </tr>
                        `;
                    });

                    tableHTML += `</tbody></table>`;
                    detailsModalContent.innerHTML = tableHTML;

                } catch (error) {
                    console.error('ìƒì„¸ ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨:', error);
                    detailsModalContent.innerHTML = `<p class="no-data-message" style="text-align: center;">ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                }
            }

            // â–¼â–¼â–¼ [ì‹ ê·œ] ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ â–¼â–¼â–¼
            function closeDetailsModal() {
                detailsModal.classList.remove('visible');
            }
            closeDetailsModalBtn.addEventListener('click', closeDetailsModal);
            detailsModal.addEventListener('click', (e) => {
                if (e.target === detailsModal) closeDetailsModal();
            });
            detailsModal.querySelector('.modal-window').addEventListener('click', (e) => e.stopPropagation());

            function updateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeDisplay.textContent = `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ ${minutes}ë¶„`;
            }
            setInterval(updateTime, 1000);
            updateTime();

            document.getElementById('home-btn').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('back-btn').addEventListener('click', () => window.location.href = 'production.html');

            // 1. (ë§ì”€í•˜ì‹ ) ì—­í• (Role) í™•ì¸
            const userRole = localStorage.getItem('ppms_user_role');

            // 2. (ë§ì”€í•˜ì‹ ) ë¹„ë¡œê·¸ì¸ ì‹œ íŠ•ê²¨ë‚´ê¸°
            if (!userRole) {
                window.location.href = 'login.html';
                return; // (ì¤‘ìš”) ë‚˜ë¨¸ì§€ ì½”ë“œ ì‹¤í–‰ ì¤‘ë‹¨
            }
        });
    </script>
</body>

</html>
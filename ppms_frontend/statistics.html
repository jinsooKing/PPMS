<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 통계</title>
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="statistics.css">

    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left"><a href="index.html">
                    <picture>
                        <source srcset="logo.avif" type="image/avif"><img src="logo.png" alt="필리아텔레콤 로고"
                            class="header-logo">
                    </picture>
                </a>
            </div>
            <div class="header-center">
                <div class="common-box font-35pt">통계 분석</div>
            </div>
            <div class="header-right">
                <div class="common-box font-15pt time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div class="statistics-controls">
                <input type="number" id="order-year-input" placeholder="예: 2025">
                <select id="order-month-select">
                </select>
                <div class="common-box font-15pt clickable-box search-btn" id="search-stats-btn">조회</div>
            </div>

            <div id="statistics-result-area">
                <p class="no-data-message" style="text-align: center;">조회할 주문월을 선택해 주세요.</p>
            </div>

        </main>

        <footer class="main-footer">
            <div class="footer-left">
            </div>
            <div class="footer-center">
                <div class="common-box font-15pt clickable-box" id="back-btn"><i class="fas fa-arrow-left"></i></div>
                <div class="common-box font-15pt clickable-box" id="home-btn"><i class="fas fa-home"></i></div>
                <div class="common-box font-15pt clickable-box" id="forward-btn"><i class="fas fa-arrow-right"></i>
                </div>
            </div>
            <div class="footer-right">
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. 요소 가져오기 ---
            const monthSelect = document.getElementById('order-month-select');
            const searchBtn = document.getElementById('search-stats-btn');
            const resultArea = document.getElementById('statistics-result-area');
            const timeDisplay = document.getElementById('current-time');

            // ▼▼▼ [신규] '주문 연도' 입력 요소를 가져옵니다. ▼▼▼
            const yearInput = document.getElementById('order-year-input');

            // --- 2. '주문월' 드롭다운 채우기 ---
            monthSelect.innerHTML = '<option value="">-선택-</option>';
            for (let i = 1; i <= 12; i++) {
                const monthText = `${i}월분`;
                monthSelect.innerHTML += `<option value="${monthText}">${monthText}</option>`;
            }

            // ▼▼▼ [신규] '주문 연도' 기본값으로 현재 연도 설정 ▼▼▼
            yearInput.value = new Date().getFullYear();

            // --- 3. '조회' 버튼 이벤트 리스너 ---
            searchBtn.addEventListener('click', async () => {
                const selectedMonth = monthSelect.value;
                // ▼▼▼ [수정] 'yearInput.value'에서 값을 가져옵니다. ▼▼▼
                const selectedYear = yearInput.value;

                if (!selectedYear || !selectedMonth) {
                    alert('주문 연도와 주문월을 모두 선택하세요.');
                    return;
                }

                resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">데이터를 불러오는 중입니다...</p>`;

                try {
                    // 4. 백엔드 통계 API 호출
                    const response = await fetch(`http://127.0.0.1:5000/api/statistics/order_month_summary?order_month=${selectedMonth}&year=${selectedYear}`);

                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }

                    const summaryData = await response.json();

                    // 5. 결과 테이블 생성
                    renderStatisticsTable(summaryData, selectedMonth);

                } catch (error) {
                    console.error('통계 데이터 로딩 실패:', error);
                    resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">데이터 로딩에 실패했습니다. 백엔드 서버를 확인하세요.</p>`;
                }
            });

            // --- 6. 통계 테이블 그리기 함수 ---
            function renderStatisticsTable(data, selectedMonth) {
                if (!data || data.length === 0) {
                    resultArea.innerHTML = `<p class="no-data-message" style="text-align: center;">'${selectedMonth}'에 대한 데이터가 없습니다.</p>`;
                    return;
                }

                // production.css의 .editable-table 스타일 재사용
                let tableHTML = `<table class="editable-table statistics-table">
                    <colgroup>
                        <col style="width: 50%;">
                        <col style="width: 25%;">
                        <col style="width: 25%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>모델명</th>
                            <th>총 주문량</th>
                            <th>실생산총합</th>
                            </tr>
                    </thead>
                    <tbody>`;

                data.forEach(item => {
                    // ▼▼▼ [삭제] 'rate' 계산 삭제 ▼▼▼

                    tableHTML += `
                        <tr>
                            <td>${item.model}</td>
                            <td>${item.totalQuantity.toLocaleString()}</td>
                            <td>${item.actualProduction.toLocaleString()}</td>
                            </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                resultArea.innerHTML = tableHTML;
            }

            // --- (재사용) 시간 및 푸터 내비게이션 ---
            function updateTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeDisplay.textContent = `${year}년 ${month}월 ${day}일 ${hours}시 ${minutes}분`;
            }
            setInterval(updateTime, 1000);
            updateTime();

            document.getElementById('home-btn').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('back-btn').addEventListener('click', () => window.location.href = 'production.html');
        });
    </script>
</body>

</html>
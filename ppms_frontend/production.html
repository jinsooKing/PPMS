<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 생산 일정 관리</title>

    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="production.css">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script src="auth.js"></script>
    <script src="calendar.js"></script>
    <script src="paperlogy-font.js"></script>
    <script src="logo.js"></script>

</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="ppms-logo-placeholder"></a>
                <div id="current-week-display" class="common-box clickable-box">
                    <i class="uil uil-calendar-alt"></i> <span>Loading...</span>
                </div>
            </div>
            <div class="header-center">
                <div class="common-box">PRODUCTION (SMD)</div>
            </div>
            <div class="header-right">
                <div class="common-box time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div id="schedule-display-area"></div>
        </main>

        <footer class="main-footer">
            <div class="footer-left">
                <div class="footer-btn" id="reg-schedule-btn">
                    <i class="uil uil-edit"></i> 일정 등록
                </div>
            </div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right">
                <div class="footer-btn" id="week-picker-btn" style="position: relative;">
                    <i class="uil uil-history"></i> 이전 데이터
                </div>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="week-selector-dropup">
        <div class="modal-window small-modal" style="width:auto; max-width:500px; height:auto; max-height:80vh;">
            <button class="close-btn" id="close-week-modal-btn" onclick="closeWeekSelectorDropup()">&times;</button>
            <h3 class="modal-title">주차 선택</h3>
            <div class="modal-content">
                <div class="grid-container" id="week-selector-grid"
                    style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="schedule-modal">
        <div class="modal-window" style="width: 95vw; max-width: 1600px;">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            <h2 class="modal-title" id="modal-title">생산 일정 등록</h2>

            <nav class="line-tab-nav">
                <button class="line-tab-btn active" data-line-tab="A">A LINE</button>
                <button class="line-tab-btn" data-line-tab="B">B LINE</button>
                <button class="line-tab-btn" data-line-tab="C">C LINE</button>
            </nav>

            <div class="modal-content">

                <section class="line-schedule-section tab-content active" id="tab-content-A" data-line="A">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">A LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-A">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="B">B라인</button>
                                    <button class="import-option-btn" data-source="C">C라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-A">
                            <colgroup>
                                <col style="width:15%">
                                <col style="width:8%">
                                <col style="width:27%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th>
                                    <th>년도</th>
                                    <th>모델명</th>
                                    <th>발주월</th>
                                    <th>T/B</th>
                                    <th>LOT</th>
                                    <th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-A"></tbody>
                        </table>
                    </div>
                </section>

                <section class="line-schedule-section tab-content" id="tab-content-B" data-line="B">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">B LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-B">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="A">A라인</button>
                                    <button class="import-option-btn" data-source="C">C라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-B">
                            <colgroup>
                                <col style="width:15%">
                                <col style="width:8%">
                                <col style="width:27%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th>
                                    <th>년도</th>
                                    <th>모델명</th>
                                    <th>발주월</th>
                                    <th>T/B</th>
                                    <th>LOT</th>
                                    <th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-B"></tbody>
                        </table>
                    </div>
                </section>

                <section class="line-schedule-section tab-content" id="tab-content-C" data-line="C">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">C LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-C">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="A">A라인</button>
                                    <button class="import-option-btn" data-source="B">B라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-C">
                            <colgroup>
                                <col style="width:15%">
                                <col style="width:8%">
                                <col style="width:27%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:10%">
                                <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th>
                                    <th>년도</th>
                                    <th>모델명</th>
                                    <th>발주월</th>
                                    <th>T/B</th>
                                    <th>LOT</th>
                                    <th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-C"></tbody>
                        </table>
                    </div>
                </section>

            </div>
            <div class="modal-footer">
                <div class="common-box reset-btn" id="reset-btn"
                    style="background-color: #8B0000 !important; border-color: #ff4444;"><i
                        class="uil uil-trash-alt"></i> 초기화</div>
                <div class="common-box" id="save-all-btn" style="background-color: var(--accent-blue) !important;"><i
                        class="uil uil-save"></i> 저장하기</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="notes-modal">
        <div class="modal-window" style="height: 70vh; max-width: 800px;">
            <button class="close-btn" id="close-notes-modal-btn">&times;</button>
            <h2 class="modal-title">NOTES / REMARKS</h2>
            <div class="notes-modal-content-container">
                <nav class="notes-tab-nav">
                    <button class="tab-btn active" data-tab="A">A LINE</button>
                    <button class="tab-btn" data-tab="B">B LINE</button>
                    <button class="tab-btn" data-tab="C">C LINE</button>
                </nav>
                <div class="notes-modal-content">
                    <div id="notes-content-A" class="notes-tab-content active"></div>
                    <div id="notes-content-B" class="notes-tab-content"></div>
                    <div id="notes-content-C" class="notes-tab-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="export-choice-modal">
        <div class="modal-window small-modal" style="max-width: 350px; height: auto;">
            <button class="close-btn" id="close-export-modal-btn">&times;</button>
            <h3 class="modal-title">EXPORT AS PDF</h3>
            <div class="modal-content choice-buttons"
                style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
                <div id="export-plan-btn" class="common-box clickable-box" style="justify-content:center;">
                    <i class="uil uil-clipboard-notes"></i> 생산계획서
                </div>
                <div id="export-report-btn" class="common-box clickable-box" style="justify-content:center;">
                    <i class="uil uil-file-check-alt"></i> 생산보고서
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="custom-alert-modal" style="z-index: 11000;">
        <div class="modal-window small-modal" style="max-width: 350px; border-color: var(--point-gold);">
            <div class="modal-content" style="padding: 30px 20px; text-align: center;">
                <i id="alert-icon" class="uil uil-info-circle"
                    style="font-size: 3rem; color: var(--point-gold); display: block; margin-bottom: 15px;"></i>
                <p id="alert-message"
                    style="color: #fff; font-size: 1rem; line-height: 1.5; margin-bottom: 25px; font-family: 'BMJUA';">
                </p>
                <button class="common-box" style="width: 100%; background: var(--accent-blue); border: none;"
                    onclick="closeCustomAlert()">확인</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="new-model-reg-modal">
        <div class="modal-window small-modal" style="max-width: 500px; width: 90vw; height: auto; max-height: 90vh;">
            <button class="close-btn" onclick="closeNewModelModal()">&times;</button>
            <h3 class="modal-title">신규 모델 등록 위치 선택</h3>
            <div class="modal-content"
                style="padding: 20px; overflow: hidden; display: flex; flex-direction: column; gap: 15px;">
                <p style="color: #bbb; font-size: 0.85rem; text-align: center;">
                    '<span id="target-model-name" style="color: var(--point-gold); font-weight: bold;"></span>' 저장 위치 지정
                </p>

                <div id="modal-breadcrumb"
                    style="display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #888; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 5px;">
                </div>

                <div id="folder-selector-list"
                    style="flex: 1; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,235,167,0.1); overflow-y: auto; min-height: 200px;">
                </div>

                <div id="new-folder-input-area"
                    style="display: none; gap: 8px; padding: 10px; background: rgba(255,235,167,0.05); border-radius: 8px; border: 1px dashed var(--point-gold);">
                    <input type="text" id="new-folder-name" class="compact-input" style="flex: 1; text-align: left;"
                        placeholder="새 폴더 이름 입력">
                    <button class="text-btn" style="background: var(--point-gold); color: var(--accent-blue);"
                        onclick="createNewFolderInModal()">생성</button>
                    <button class="text-btn" onclick="toggleNewFolderInput(false)">취소</button>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="text-btn"
                        style="width: 100%; border-color: var(--point-gold); color: var(--point-gold);"
                        onclick="toggleNewFolderInput(true)">
                        <i class="uil uil-folder-plus"></i> 현재 위치에 새 폴더 만들기
                    </button>
                    <div style="display: flex; gap: 10px;">
                        <button class="common-box" style="flex: 1; background: #444; border: none;"
                            onclick="closeNewModelModal()">취소</button>
                        <button class="common-box" style="flex: 2; background: var(--accent-blue); border: none;"
                            id="confirm-model-reg-btn">이 위치에 등록</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <datalist id="model-suggestions-list"></datalist>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 50);

            // --- 기본 초기화 ---
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) { window.location.href = 'login.html'; return; }
            if (typeof setupLogoutButton === 'function') setupLogoutButton();

            if (userRole !== 'admin') {
                if (regScheduleBtn) regScheduleBtn.style.display = 'none';
                if (saveAllBtn) saveAllBtn.style.display = 'none';
                if (resetBtn) resetBtn.style.display = 'none';
            }

            setInterval(updateTime, 1000);
            updateTime();

            const urlParams = new URLSearchParams(window.location.search);
            const pYear = urlParams.get('year'), pMonth = urlParams.get('month'), pWeek = urlParams.get('week');
            if (pYear && pMonth && pWeek) displayScheduleForWeek(parseInt(pYear), parseInt(pMonth), parseInt(pWeek));
            else displayCurrentWeekSchedule();

            setupWeekPicker('week-picker-btn', (y, m, w) => displayScheduleForWeek(y, m, w));

            // Event Listeners
            backBtn.addEventListener('click', goBackView);
            homeBtn.addEventListener('click', () => window.location.href = 'index.html');
            forwardBtn.addEventListener('click', goForwardView);
            if (regScheduleBtn) regScheduleBtn.addEventListener('click', openWeekSelectorDropup);

            weekSelectorDropup.addEventListener('click', (e) => { if (e.target === weekSelectorDropup) closeWeekSelectorDropup(); });
            weekSelectorGrid.addEventListener('click', handleWeekSelection);

            if (saveAllBtn) saveAllBtn.addEventListener('click', saveSchedules);
            if (resetBtn) resetBtn.addEventListener('click', resetSchedules);
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            modalWindow.addEventListener('click', e => e.stopPropagation());

            // [모달 이벤트 수정: 행 추가, 삭제 모드, 라인 가져오기]
            modalWindow.addEventListener('click', function (event) {
                if (localStorage.getItem('ppms_user_role') === 'admin') {

                    // 1. 행 추가
                    if (event.target.closest('.add-row-btn')) {
                        const btn = event.target.closest('.add-row-btn');
                        const section = btn.closest('.line-schedule-section');
                        const line = section.dataset.line;
                        addNewScheduleRow(section.querySelector('tbody'), line);
                    }

                    // 2. 삭제 모드 토글
                    if (event.target.closest('.toggle-delete-btn')) {
                        const btn = event.target.closest('.toggle-delete-btn');
                        const table = btn.closest('.line-schedule-section').querySelector('table');
                        btn.classList.toggle('delete-mode-active');
                        table.classList.toggle('delete-mode');
                    }

                    // 3. 불러오기 메뉴 토글
                    if (event.target.closest('.import-line-btn')) {
                        const btn = event.target.closest('.import-line-btn');
                        const section = btn.closest('.line-schedule-section');
                        const optionsContainer = section.querySelector('.import-options-container');

                        // 다른 섹션의 열린 메뉴 닫기
                        document.querySelectorAll('.import-options-container').forEach(el => {
                            if (el !== optionsContainer) el.classList.remove('active');
                        });

                        // 현재 섹션 메뉴 토글
                        if (optionsContainer) optionsContainer.classList.toggle('active');
                    }

                    // 4. 특정 라인 가져오기 선택 (B라인 등)
                    if (event.target.classList.contains('import-option-btn')) {
                        const sourceLine = event.target.dataset.source;
                        const targetLine = event.target.closest('.line-schedule-section').dataset.line;

                        copyScheduleFromLine(sourceLine, targetLine);

                        // 메뉴 닫기
                        const container = event.target.closest('.import-options-container');
                        if (container) container.classList.remove('active');
                    }

                    // 5. 행 삭제 (삭제 모드일 때)
                    const row = event.target.closest('tr');
                    if (row && row.closest('table').classList.contains('delete-mode')) {
                        handleRowDelete(row);
                    }
                }
            });

            // [모달 이벤트] 탭 전환
            const lineTabNav = document.querySelector('.line-tab-nav');
            if (lineTabNav) {
                lineTabNav.addEventListener('click', (e) => {
                    if (e.target.classList.contains('line-tab-btn')) {
                        // 버튼 활성화 처리
                        lineTabNav.querySelectorAll('.line-tab-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');

                        // 컨텐츠 표시 처리
                        const targetLine = e.target.dataset.lineTab;
                        const modalContent = document.querySelector('#schedule-modal .modal-content');
                        modalContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(`tab-content-${targetLine}`).classList.add('active');

                        // 탭 전환 시 불러오기 메뉴 닫기
                        document.querySelectorAll('.import-options-container').forEach(el => el.classList.remove('active'));
                    }
                });
            }

            const validate = (e, reg, msg) => {
                const val = e.target.value, sanitized = val.replace(reg, '');
                if (val !== sanitized) { e.target.value = sanitized; showValidationMessage(e.target, msg); }
            };
            modalWindow.addEventListener('input', e => { if (e.target.dataset.field === 'lot-modal') validate(e, /[^0-9/]/g, "숫자/' 만 가능"); });
            displayArea.addEventListener('input', e => {
                if (e.target.dataset.field === 'lot') validate(e, /[^0-9/]/g, "숫자/' 만 가능");
                else if (e.target.dataset.field === 'actualProd') validate(e, /[^0-9/]/g, "숫자만 가능");
            });

            displayArea.addEventListener('click', function (e) {
                if (e.target.closest('.period-btn')) {
                    const d = e.target.closest('.period-btn').dataset;
                    navigateToView(d.view, { year: parseInt(d.year), month: parseInt(d.month), weekNum: parseInt(d.week) });
                }
                if (e.target.closest('#open-export-modal-btn')) exportChoiceModal.classList.add('visible');
                if (e.target.closest('#open-notes-modal-btn')) openNotesModal();
            });
            displayArea.addEventListener('change', handleTableInputChange);

            // PDF
            const closeExport = () => exportChoiceModal.classList.remove('visible');
            closeExportModalBtn.addEventListener('click', closeExport);
            exportChoiceModal.addEventListener('click', closeExport);
            exportChoiceModal.querySelector('.modal-window').addEventListener('click', e => e.stopPropagation());
            exportPlanBtn.addEventListener('click', async () => { await generateProductionPdf('plan'); closeExport(); });
            exportReportBtn.addEventListener('click', async () => { await generateProductionPdf('report'); closeExport(); });

            // Notes
            const closeNotes = () => notesModal.classList.remove('visible');
            closeNotesModalBtn.addEventListener('click', closeNotes);
            notesModal.addEventListener('click', e => { if (e.target === notesModal) closeNotes(); });
            notesModal.querySelector('.modal-window').addEventListener('click', e => e.stopPropagation());
            notesTabNav.addEventListener('click', e => {
                if (e.target.classList.contains('tab-btn')) {
                    notesTabNav.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    notesContentContainer.querySelectorAll('.notes-tab-content').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`notes-content-${e.target.dataset.tab}`).classList.add('active');
                }
            });
            notesContentContainer.addEventListener('change', handleNoteSave);
        });

        // --- 전역 변수 ---
        const displayArea = document.getElementById('schedule-display-area');
        const contentArea = document.querySelector('.content-area');
        const backBtn = document.getElementById('back-btn');
        const homeBtn = document.getElementById('home-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const weekDisplay = document.getElementById('current-week-display');
        const regScheduleBtn = document.getElementById('reg-schedule-btn');
        const weekSelectorDropup = document.getElementById('week-selector-dropup');
        const weekSelectorGrid = document.getElementById('week-selector-grid');
        const modalOverlay = document.getElementById('schedule-modal');
        const modalWindow = modalOverlay.querySelector('.modal-window');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveAllBtn = document.getElementById('save-all-btn');
        const resetBtn = document.getElementById('reset-btn');
        const exportChoiceModal = document.getElementById('export-choice-modal');
        const closeExportModalBtn = document.getElementById('close-export-modal-btn');
        const exportPlanBtn = document.getElementById('export-plan-btn');
        const exportReportBtn = document.getElementById('export-report-btn');
        const lineControls = {
            'A': { tableBody: document.getElementById('schedule-table-body-A') },
            'B': { tableBody: document.getElementById('schedule-table-body-B') },
            'C': { tableBody: document.getElementById('schedule-table-body-C') }
        };
        const notesModal = document.getElementById('notes-modal');
        const closeNotesModalBtn = document.getElementById('close-notes-modal-btn');
        const notesTabNav = notesModal.querySelector('.notes-tab-nav');
        const notesContentContainer = notesModal.querySelector('.notes-modal-content');

        let currentView = { mode: 'current_week', data: {} };
        let viewHistory = [], forwardHistory = [], currentSelectedWeekInfo = {};
        let managerList = [], companyList = [];



        function isEditAllowed() {
            const r = localStorage.getItem('ppms_user_role');
            if (r === 'admin') return true;
            if (r === 'user') {
                const d = new Date(), y = d.getFullYear(), m = d.getMonth() + 1, w = getCurrentWeekNumber(d);
                const v = currentView.data;
                if (v.year === y && v.month === m && v.weekNum === w) return true;
            }
            return false;
        }

        function showValidationMessage(target, msg) {
            const p = target.parentElement;
            let m = p.querySelector('.validation-message');
            if (!m) { m = document.createElement('span'); m.className = 'validation-message'; p.appendChild(m); }
            m.textContent = msg; m.classList.add('visible');
            if (m.dataset.tid) clearTimeout(m.dataset.tid);
            m.dataset.tid = setTimeout(() => m.classList.remove('visible'), 2000);
        }

        async function loadMasterData() {
            try {
                const [m, c] = await Promise.all([
                    fetch('http://127.0.0.1:5000/api/production/managers'),
                    fetch('http://127.0.0.1:5000/api/production/companies')
                ]);
                managerList = await m.json(); companyList = await c.json();
            } catch (e) { console.error(e); }
        }

        /* [전체 교체] 에러 핸들링이 강화된 저장 함수 */
        function saveSchedules() {
            if (localStorage.getItem('ppms_user_role') !== 'admin') return alert('권한 없음');

            const scheds = [];
            for (const l in lineControls) {
                lineControls[l].tableBody.querySelectorAll('tr').forEach(r => {
                    const c = r.querySelector('[data-field="company-modal"]').value;
                    const m = r.querySelector('[data-field="model-modal"]').value;
                    const lt = r.querySelector('[data-field="lot-modal"]').value; // 문자열 그대로 전송

                    // 데이터가 있는 행만 수집
                    if (c || m || lt) {
                        let yv = r.querySelector('[data-field="orderYear"]').value;
                        // [보강] 연도가 비어있거나 2자리인 경우 처리
                        let parsedYear = null;
                        if (yv) {
                            if (yv.length === 2) yv = '20' + yv;
                            parsedYear = parseInt(yv);
                        }

                        scheds.push({
                            id: r.dataset.scheduleId ? parseInt(r.dataset.scheduleId) : null,
                            line: l,
                            company: c,
                            model: m,
                            orderYear: parsedYear, // 숫자로 변환된 연도 (또는 null)
                            orderMonth: r.querySelector('[data-field="orderMonth"]').value,
                            tb: r.querySelector('[data-field="tb-modal"]').value,
                            lot: lt, // "100/200" 형태의 문자열
                            manager: null, // 모달에는 담당자 입력란이 없으므로 null 전송 (백엔드 허용)
                            startDate: r.querySelector('.start-date-select').value,
                            endDate: r.querySelector('.end-date-select').value
                        });
                    }
                });
            }

            fetch('http://127.0.0.1:5000/api/production/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weekInfo: currentSelectedWeekInfo, schedules: scheds })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.message) {
                        alert(d.message);
                        closeModal();
                        renderContent();
                    } else {
                        // [수정] 단순 "Error" 대신 서버가 보낸 실제 에러 메시지 출력
                        alert("저장 실패: " + (d.error || "알 수 없는 오류가 발생했습니다."));
                    }
                })
                .catch(err => {
                    alert("서버 통신 오류: " + err);
                });
        }

        // [초기화 버튼: 현재 탭 내용만 비움]
        function resetSchedules() {
            if (localStorage.getItem('ppms_user_role') !== 'admin') return alert('권한 없음');

            const activeSection = document.querySelector('.line-schedule-section.active');
            if (!activeSection) return;

            const line = activeSection.dataset.line;

            if (!confirm(`${line} 라인의 작성중인 내용을 초기화하시겠습니까?`)) return;

            const tbody = activeSection.querySelector('tbody');
            tbody.innerHTML = '';
            addNewScheduleRow(tbody, line); // 빈 행 추가
        }

        function openWeekSelectorDropup() {
            const y = currentView.data.year || new Date().getFullYear();
            const m = currentView.data.month ? currentView.data.month - 1 : new Date().getMonth();
            const weeks = Array.from(getProductionWeeksInMonth(y, m)).sort((a, b) => a - b);
            weekSelectorGrid.innerHTML = '';
            weeks.forEach(w => {
                const d = document.createElement('div'); d.className = 'week-box clickable-box';
                d.textContent = `${m + 1}월 ${w}주차`; d.dataset.year = y; d.dataset.month = m + 1; d.dataset.week = w;
                weekSelectorGrid.appendChild(d);
            });
            weekSelectorDropup.classList.add('visible');
        }
        function closeWeekSelectorDropup() { weekSelectorDropup.classList.remove('visible'); }
        function handleWeekSelection(e) {
            if (e.target.classList.contains('week-box')) {
                const { year, month, week } = e.target.dataset;
                closeWeekSelectorDropup(); openModal({ year: parseInt(year), month: parseInt(month), weekNum: parseInt(week) });
            }
        }

        async function openModal(weekInfo) {
            currentSelectedWeekInfo = weekInfo;
            const role = localStorage.getItem('ppms_user_role');
            modalTitle.textContent = `${weekInfo.month}월 ${weekInfo.weekNum}주차 생산 일정 ${role !== 'admin' ? '(읽기 전용)' : ''}`;
            for (const l in lineControls) lineControls[l].tableBody.innerHTML = '';
            await loadMasterData();
            const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${weekInfo.year}&month=${weekInfo.month}&weekNum=${weekInfo.weekNum}`);
            const data = await res.json();
            if (data.length > 0) data.forEach(d => addNewScheduleRow(lineControls[d.line].tableBody, d.line, d));
            for (const l in lineControls) if (lineControls[l].tableBody.rows.length === 0) addNewScheduleRow(lineControls[l].tableBody, l);
            modalOverlay.classList.add('visible');
        }
        function closeModal() { modalOverlay.classList.remove('visible'); }

        // [행 추가 함수]
        function addNewScheduleRow(target, line, data = {}, after = null) {
            const role = localStorage.getItem('ppms_user_role');
            const ro = role !== 'admin' ? 'disabled' : '';

            const row = after ? target.insertRow(after.rowIndex) : target.insertRow();
            row.classList.add('animate-in');

            row.dataset.scheduleId = data.id || '';
            const opts = (lst, v) => lst.map(i => `<option value="${i.name}" ${v === i.name ? 'selected' : ''}>${i.name}</option>`).join('');
            let mOpts = ''; for (let i = 1; i <= 12; i++) mOpts += `<option value="${i}월분" ${(data.orderMonth || '').trim() === `${i}월분` ? 'selected' : ''}>${i}월분</option>`;

            const fullYear = data.orderYear || currentSelectedWeekInfo.year;
            const shortYear = String(fullYear).slice(-2);

            row.innerHTML = `
                <td><select data-field="company-modal" class="form-select" ${ro}><option value="">-</option>${opts(companyList, data.company)}</select></td>
                <td><input type="number" data-field="orderYear" class="form-input" value="${shortYear}" ${ro}></td>
                <td><input type="text" data-field="model-modal" class="form-input" list="model-suggestions-list" value="${data.model || ''}" ${ro}></td>
                <td><select data-field="orderMonth" class="form-select" ${ro}><option value="">-</option>${mOpts}</select></td>
                <td><select data-field="tb-modal" class="form-select" ${ro}><option value="Top" ${data.tb === 'Top' ? 'selected' : ''}>Top</option><option value="Bot" ${data.tb === 'Bot' ? 'selected' : ''}>Bot</option><option value="T/O" ${data.tb === 'T/O' ? 'selected' : ''}>T/O</option><option value="B/O" ${data.tb === 'B/O' ? 'selected' : ''}>B/O</option></select></td>
                <td><input type="text" data-field="lot-modal" class="form-input" value="${data.lot || ''}" ${ro}></td>
                <td style="display:flex;gap:5px;"><select class="start-date-select form-select" ${ro}></select>~<select class="end-date-select form-select" ${ro}></select></td>
            `;
            populateDateSelectors(currentSelectedWeekInfo, row);

            const startSel = row.querySelector('.start-date-select');
            const endSel = row.querySelector('.end-date-select');
            if (startSel) startSel.value = data.startDate || '';
            if (endSel) endSel.value = data.endDate || '';

            const modelInput = row.querySelector('[data-field="model-modal"]');
            if (modelInput) {
                modelInput.addEventListener('blur', function () {
                    const companyInput = row.querySelector('[data-field="company-modal"]');
                    // 전역에 선언된 handleModelInput 함수 호출
                    handleModelInput(companyInput, this);
                });
            }
            const companySelect = row.querySelector('[data-field="company-modal"]');
            if (companySelect) {
                companySelect.addEventListener('change', function () {
                    updateModelSuggestions(this.value); // 업체 선택 시 추천 리스트 업데이트
                });
            }

            return row;
        }
        /* [신규 추가] 업체별 기존 모델 목록을 가져와 자동완성 리스트 생성 */
        async function updateModelSuggestions(companyName) {
            const datalist = document.getElementById('model-suggestions-list');
            datalist.innerHTML = '';
            if (!companyName) return;

            // 1. 전역 변수 companyList에서 업체 ID 찾기
            const comp = companyList.find(c => c.name === companyName);
            if (!comp) return;

            try {
                // 2. 해당 업체의 모델 데이터를 조회
                const res = await fetch(`http://127.0.0.1:5000/api/production/directory?company_id=${comp.id}&section=common`);
                const data = await res.json();

                // 3. datalist에 옵션 추가 (중복 방지를 위해 Set 사용)
                if (data.models && data.models.length > 0) {
                    data.models.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.name;
                        datalist.appendChild(option);
                    });
                }
            } catch (e) { console.error("추천 리스트 로드 실패:", e); }
        }

        // [삭제 로직]
        function handleRowDelete(row) {
            row.classList.add('animate-out');
            setTimeout(() => {
                const tbody = row.closest('tbody');
                const section = tbody.closest('.line-schedule-section');
                const line = section.dataset.line;

                row.remove();
                // 모두 삭제되었으면 빈 행 추가
                if (tbody.rows.length === 0) {
                    addNewScheduleRow(tbody, line);
                }
            }, 300); // 애니메이션 시간보다 약간 짧게
        }

        // [다른 라인에서 일정 가져오기]
        function copyScheduleFromLine(sourceLine, targetLine) {
            const sourceTbody = document.getElementById(`schedule-table-body-${sourceLine}`);
            const targetTbody = document.getElementById(`schedule-table-body-${targetLine}`);

            if (!sourceTbody || !targetTbody) return;

            const sourceRows = sourceTbody.querySelectorAll('tr');
            if (sourceRows.length === 0) {
                alert(`${sourceLine} 라인에 복사할 데이터가 없습니다.`);
                return;
            }

            // 복사 시작
            sourceRows.forEach(row => {
                const company = row.querySelector('[data-field="company-modal"]').value;
                const model = row.querySelector('[data-field="model-modal"]').value;

                if (company || model) {
                    const data = {
                        company: company,
                        orderYear: row.querySelector('[data-field="orderYear"]').value,
                        model: model,
                        orderMonth: row.querySelector('[data-field="orderMonth"]').value,
                        tb: row.querySelector('[data-field="tb-modal"]').value,
                        lot: row.querySelector('[data-field="lot-modal"]').value,
                        startDate: row.querySelector('.start-date-select').value,
                        endDate: row.querySelector('.end-date-select').value
                    };
                    addNewScheduleRow(targetTbody, targetLine, data);
                }
            });
        }

        function populateDateSelectors(info, row) {
            if (!row || !info.year) return;
            const days = getWeekdaysForWeek(info.year, info.month - 1, info.weekNum);
            const dNames = ['일', '월', '화', '수', '목', '금', '토'];
            const s1 = row.querySelector('.start-date-select'), s2 = row.querySelector('.end-date-select');
            s1.innerHTML = s2.innerHTML = '';
            days.forEach(d => {
                const txt = `${d.month}/${d.day}(${dNames[d.dayOfWeek]})`;
                s1.add(new Option(txt, txt)); s2.add(new Option(txt, txt));
            });
        }

        function renderContent() {
            const { mode, data } = currentView;
            contentArea.className = (mode === 'current_week' || mode === 'schedule_view') ? 'content-area align-top' : 'content-area';
            displayArea.style.marginTop = '5px';
            if (mode === 'current_week' || mode === 'schedule_view') displayScheduleForWeek(data.year, data.month, data.weekNum);
            else if (mode === 'past_weeks') displayPastWeeks();
            else if (mode === 'past_months') displayPastMonths(data.year);
            else if (mode === 'past_years') displayPastYears();
            else if (mode === 'weeks_of_month') displayWeeksForMonth(data.year, data.month);
        }

        function navigateToView(m, d = {}) {
            if (currentView.mode !== m || JSON.stringify(currentView.data) !== JSON.stringify(d)) { viewHistory.push(currentView); forwardHistory = []; }
            currentView = { mode: m, data: d }; renderContent();
        }
        function goBackView() { if (viewHistory.length > 0) { forwardHistory.push(currentView); currentView = viewHistory.pop(); renderContent(); } else history.back(); }
        function goForwardView() { if (forwardHistory.length > 0) { viewHistory.push(currentView); currentView = forwardHistory.pop(); renderContent(); } }

        function handleTableInputChange(e) {
            if (!isEditAllowed()) return alert('권한 없음');
            const row = e.target.closest('tr');
            if (!row || !row.dataset.scheduleId) return;
            const body = {
                manager: row.querySelector('[data-field="manager"]').value,
                company: row.querySelector('[data-field="company"]').value,
                model: row.querySelector('[data-field="model"]').value,
                orderMonth: row.querySelector('[data-field="orderMonth"]').value,
                tb: row.querySelector('[data-field="tb"]').value,
                lot: row.querySelector('[data-field="lot"]').value,
                actualProd: row.querySelector('[data-field="actualProd"]').value,
                prodStart: row.querySelector('[data-field="prodStart"]').value,
                prodEnd: row.querySelector('[data-field="prodEnd"]').value
            };
            if (e.target.dataset.field === 'lot' || e.target.dataset.field === 'actualProd') updateLineProgress(row.dataset.line);
            fetch(`http://127.0.0.1:5000/api/production/schedules/${row.dataset.scheduleId}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            });
        }

        function displayCurrentWeekSchedule() {
            const d = new Date();
            const y = d.getFullYear(), m = d.getMonth() + 1, w = getCurrentWeekNumber(d);
            currentView = { mode: 'current_week', data: { year: y, month: m, weekNum: w } };
            displayScheduleForWeek(y, m, w);
        }

        async function displayScheduleForWeek(y, m, w) {
            currentView = { mode: 'schedule_view', data: { year: y, month: m, weekNum: w } };
            weekDisplay.innerHTML = `<i class="uil uil-calendar-alt"></i> ${y}년 ${m}월 ${w}주차`;
            await loadMasterData();
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${y}&month=${m}&weekNum=${w}`);
                const data = await res.json();
                displayArea.innerHTML = createScheduleTableHTML(data);
                if (data.length > 0) populateDateSelectorsForProductionPage({ year: y, month: m, weekNum: w }, data);
                ['A', 'B', 'C'].forEach(l => updateLineProgress(l));
            } catch (e) { displayArea.innerHTML = '<p class="no-line-data-message">데이터 로딩 실패</p>'; }
        }

        function updateLineProgress(line) {
            const sec = document.querySelector(`.line-schedule-section[data-line="${line}"]`);
            if (!sec) return;
            let tLot = 0, tAct = 0;
            sec.querySelectorAll('tbody tr').forEach(r => {
                tLot += parseInt(r.querySelector('input[data-field="lot"]').value) || 0;
                tAct += parseInt(r.querySelector('input[data-field="actualProd"]').value) || 0;
            });
            const pct = tLot > 0 ? Math.min((tAct / tLot) * 100, 100) : 0;
            const bar = document.getElementById(`progress-bar-${line}`);
            const txt = document.getElementById(`progress-text-${line}`);
            if (bar) bar.style.width = `${pct}%`;
            if (txt) txt.textContent = `${Math.round(pct)}%`;
        }

        function displayPastWeeks() {
            const d = new Date(), w = getCurrentWeekNumber(d);
            let h = `<div class="period-selector-grid">`;
            for (let i = 1; i <= w; i++) h += `<div class="period-btn clickable-box" data-view="schedule_view" data-year="${d.getFullYear()}" data-month="${d.getMonth() + 1}" data-week="${i}">${d.getMonth() + 1}월 ${i}주차</div>`;
            displayArea.innerHTML = h + `</div>`;
        }
        function displayPastMonths(y) {
            const d = new Date(), max = (y === d.getFullYear()) ? d.getMonth() : 11;
            let h = `<div class="period-selector-grid">`;
            for (let i = 0; i <= max; i++) h += `<div class="period-btn clickable-box" data-view="weeks_of_month" data-year="${y}" data-month="${i + 1}">${i + 1}월</div>`;
            displayArea.innerHTML = h + `</div>`;
        }
        function displayPastYears() {
            let h = `<div class="period-selector-grid">`;
            for (let i = 0; i < 3; i++) { const y = new Date().getFullYear() - i; h += `<div class="period-btn clickable-box" data-view="past_months" data-year="${y}">${y}년</div>`; }
            displayArea.innerHTML = h + `</div>`;
        }
        function displayWeeksForMonth(y, m) {
            const w = Array.from(getProductionWeeksInMonth(y, m - 1)).sort((a, b) => a - b);
            let h = `<div class="period-selector-grid">`;
            w.forEach(k => h += `<div class="period-btn clickable-box" data-view="schedule_view" data-year="${y}" data-month="${m}" data-week="${k}">${m}월 ${k}주차</div>`);
            displayArea.innerHTML = h + `</div>`;
        }

        async function openNotesModal() {
            const { year, month, weekNum } = currentView.data;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${year}&month=${month}&weekNum=${weekNum}`);
                const data = await res.json();
                const byLine = { A: [], B: [], C: [] };
                data.forEach(s => { if (byLine[s.line]) byLine[s.line].push(s); });

                ['A', 'B', 'C'].forEach(line => {
                    const el = document.getElementById(`notes-content-${line}`);
                    if (byLine[line].length > 0) {
                        el.innerHTML = byLine[line].map(s => {
                            // [수정됨] 저장된 노트에서 숨김 태그 분리
                            const rawNote = s.notes || '';
                            const isHidden = rawNote.includes('[HIDDEN]');
                            const cleanNote = rawNote.replace('[HIDDEN]', ''); // 텍스트 박스엔 태그 없이 표시

                            return `
                            <div class="note-item" data-schedule-id="${s.id}">
                                <div class="note-header-row">
                                    <h4>${s.company || '-'} / ${s.model || '-'} (LOT:${s.lot})</h4>
                                    <label class="note-toggle-label">
                                        <input type="checkbox" class="hide-icon-cb" ${isHidden ? 'checked' : ''}>
                                        아이콘 숨기기
                                    </label>
                                </div>
                                <textarea placeholder="비고 입력...">${cleanNote}</textarea>
                            </div>
                        `}).join('');
                    } else el.innerHTML = '<p style="color:#666; text-align:center; margin-top:20px;">일정이 없습니다.</p>';
                });
                notesModal.classList.add('visible');
            } catch (e) { alert('오류 발생'); }
        }

        async function handleNoteSave(e) {
            if (!isEditAllowed()) return alert('권한 없음');

            // [수정됨] textarea 또는 checkbox 변경 시 모두 저장 트리거
            const target = e.target;
            if (target.tagName !== 'TEXTAREA' && !target.classList.contains('hide-icon-cb')) return;

            // 부모 요소(.note-item)를 찾아 ID와 값 추출
            const itemWrapper = target.closest('.note-item');
            const id = itemWrapper.dataset.scheduleId;
            const textarea = itemWrapper.querySelector('textarea');
            const checkbox = itemWrapper.querySelector('.hide-icon-cb');

            let noteText = textarea.value;

            // 체크박스가 켜져있으면 태그 붙임
            if (checkbox.checked) {
                noteText = '[HIDDEN]' + noteText;
            }

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules/${id}/notes`, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes: noteText })
                });
                if (res.ok) {
                    console.log('Note Saved');
                    // (선택사항) 메인 화면 즉시 갱신을 원하면 아래 줄 주석 해제
                    displayScheduleForWeek(currentView.data.year, currentView.data.month, currentView.data.weekNum);
                }
            } catch (e) { console.error(e); }
        }

        // [추가] 메인 화면 탭 전환 함수
        function switchMainTab(targetLine) {
            // 1. 모든 탭 컨텐츠 숨기기
            const allContents = document.querySelectorAll('#schedule-display-area .tab-content');
            allContents.forEach(el => el.classList.remove('active'));

            // 2. 선택된 탭 컨텐츠 보이기
            const targetContent = document.getElementById(`main-content-${targetLine}`);
            if (targetContent) targetContent.classList.add('active');

            // 3. 탭 버튼 스타일 업데이트
            const allBtns = document.querySelectorAll('.main-view-tabs .line-tab-btn');
            allBtns.forEach(btn => {
                if (btn.textContent.includes(targetLine + ' LINE')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // [수정됨] 메인 화면을 탭 구조로 생성하는 함수
        function createScheduleTableHTML(schedules) {
            const byLine = { A: [], B: [], C: [] };
            schedules.forEach(s => { if (byLine[s.line]) byLine[s.line].push(s); });

            const ro = isEditAllowed() ? '' : 'disabled';

            // 1. 상단 탭 네비게이션 생성
            let html = `
                <nav class="line-tab-nav main-view-tabs" style="margin-bottom: 0; border-radius: 12px 12px 0 0;">
                    <button class="line-tab-btn active" onclick="switchMainTab('A')">A LINE</button>
                    <button class="line-tab-btn" onclick="switchMainTab('B')">B LINE</button>
                    <button class="line-tab-btn" onclick="switchMainTab('C')">C LINE</button>
                </nav>
            `;

            // 2. 각 라인별 컨텐츠 생성
            for (const line in byLine) {
                // 첫 번째 라인(A)만 보이게 설정
                const isActive = line === 'A' ? 'active' : '';

                // 탭 컨텐츠 래퍼 시작
                html += `<div id="main-content-${line}" class="tab-content ${isActive}" style="width:100%;">`;

                let header = `
                    <div class="line-header" style="border-bottom:none;">
                        <div class="line-title">
                            <span>${line} LINE</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="progress-bar-${line}"></div>
                                <span class="progress-bar-text" id="progress-text-${line}">0%</span>
                            </div>
                        </div>
                        ${line === 'A' ? `<div style="display:flex; gap:5px;">
                            <button id="open-notes-modal-btn" class="icon-btn" title="메모"><i class="uil uil-notes"></i></button>
                            <button id="open-export-modal-btn" class="icon-btn" title="다운로드"><i class="uil uil-import"></i></button>
                        </div>` : ''}
                    </div>`;

                html += `<section class="line-schedule-section" data-line="${line}" style="border-top-left-radius: 0; border-top-right-radius: 0;">${header}`;

                if (byLine[line].length > 0) {
                    const rows = byLine[line].map(s => {
                        const mOpts = managerList.map(m => `<option value="${m.name}" ${s.manager === m.name ? 'selected' : ''}>${m.name}</option>`).join('');
                        const cOpts = companyList.map(c => `<option value="${c.name}" ${s.company === c.name ? 'selected' : ''}>${c.name}</option>`).join('');

                        let moOpts = '';
                        for (let i = 1; i <= 12; i++) {
                            moOpts += `<option value="${i}월분" ${(s.orderMonth || '').trim() === `${i}월분` ? 'selected' : ''}>${i}월분</option>`;
                        }

                        const rawNote = s.notes || '';
                        const isHidden = rawNote.includes('[HIDDEN]');
                        const cleanNote = rawNote.replace('[HIDDEN]', '').trim();
                        const hasNote = cleanNote.length > 0;

                        const noteIcon = (hasNote && !isHidden)
                            ? `<i class="uil uil-comment-alt-notes note-badge-icon" data-tooltip="${cleanNote.replace(/"/g, '&quot;')}"></i>`
                            : '';

                        return `<tr data-schedule-id="${s.id}" data-line="${line}">
                            <td><select class="form-select" data-field="manager" ${ro}><option value="">-</option>${mOpts}</select></td>
                            <td><select class="form-select" data-field="company" ${ro}><option value="">-</option>${cOpts}</select></td>
                            <td>
                                <div class="model-cell-wrapper">
                                    <input type="text" class="form-input" data-field="model" value="${s.model || ''}" ${ro}>
                                    ${noteIcon}
                                </div>
                            </td>
                            <td><select class="form-select" data-field="orderMonth" ${ro}><option value="">-</option>${moOpts}</select></td>
                            <td><select class="form-select" data-field="tb" ${ro}><option value="Top" ${s.tb === 'Top' ? 'selected' : ''}>Top</option><option value="Bot" ${s.tb === 'Bot' ? 'selected' : ''}>Bot</option><option value="T/O" ${s.tb === 'T/O' ? 'selected' : ''}>T/O</option><option value="B/O" ${s.tb === 'B/O' ? 'selected' : ''}>B/O</option></select></td>
                            <td><input type="text" class="form-input" data-field="lot" value="${s.lot || ''}" ${ro}></td>
                            <td><input type="text" class="form-input" data-field="actualProd" value="${s.actualProd || ''}" ${ro}></td>
                            <td><select class="form-select prod-start-date" data-field="prodStart" ${ro}></select></td>
                            <td><select class="form-select prod-end-date" data-field="prodEnd" ${ro}></select></td>
                            <td style="color:var(--point-gold);">${s.startDate}~${s.endDate}</td>
                        </tr>`;
                    }).join('');

                    html += `<div class="table-container">
                        <table class="editable-table">
                            <colgroup>
                                <col style="width:6%"> <col style="width:6%"> <col> 
                                <col style="width:6%"> <col style="width:6%"> <col style="width:8%">
                                <col style="width:6%"> <col style="width:8%"> <col style="width:8%"> <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>담당</th><th>업체</th><th>모델명</th><th>주문월</th><th>T/B</th><th>LOT</th><th>실생산</th><th>시작</th><th>종료</th><th>예정일</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
                } else {
                    html += `<p class="no-line-data-message">일정 없음</p>`;
                }
                html += `</section></div>`; // tab-content 닫기
            }
            return html;
        }

        function populateDateSelectorsForProductionPage(info, scheds) {
            const days = getWeekdaysForWeek(info.year, info.month - 1, info.weekNum);
            const dNames = ['일', '월', '화', '수', '목', '금', '토'];
            document.querySelectorAll('.prod-start-date, .prod-end-date').forEach(s => {
                const row = s.closest('tr'); if (!row) return;
                const id = parseInt(row.dataset.scheduleId);
                const sc = scheds.find(i => i.id === id);
                const val = s.classList.contains('prod-start-date') ? sc.actualStartDate : sc.actualEndDate;
                s.innerHTML = '<option value="-">-</option>';
                days.forEach(d => {
                    const txt = `${d.month}/${d.day}(${dNames[d.dayOfWeek]})`;
                    s.add(new Option(txt, txt, false, txt === val));
                });
            });
        }

        async function generateProductionPdf(reportType) {
            if (typeof addPaperlogyFont !== 'function') { alert("폰트 로드 오류"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const isPlan = reportType === 'plan';

            let year, month, weekNum;
            if (!currentView.data || !currentView.data.year) {
                const d = new Date(); year = d.getFullYear(); month = d.getMonth() + 1; weekNum = getCurrentWeekNumber(d);
            } else { year = currentView.data.year; month = currentView.data.month; weekNum = currentView.data.weekNum; }

            let dbData;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${year}&month=${month}&weekNum=${weekNum}`);
                if (!res.ok) throw new Error();
                dbData = await res.json();
            } catch (e) { alert("데이터 오류"); return; }

            if (!dbData || dbData.length === 0) { alert("데이터 없음"); return; }

            addPaperlogyFont(doc);
            doc.setFont('Paperlogy', 'normal');
            const title = isPlan ? `${year}년 ${month}월 ${weekNum}주차 생산계획서` : `${year}년 ${month}월 ${weekNum}주차 생산보고서`;
            const head = isPlan ? [['업체', '모델명', '주문월', 'T/B', 'LOT', '월', '화', '수', '목', '금']] : [['담당자', '업체', '모델명', '주문월', 'T/B', 'LOT', '실생산', '월', '화', '수', '목', '금']];

            doc.setFontSize(20); doc.text(title, 14, 15);
            const dayColW = 8;
            const colStyles = isPlan ? { 0: { cellWidth: 25 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 13 }, 3: { cellWidth: 17 }, 4: { cellWidth: 20 }, 5: { cellWidth: dayColW }, 6: { cellWidth: dayColW }, 7: { cellWidth: dayColW }, 8: { cellWidth: dayColW }, 9: { cellWidth: dayColW } } : { 0: { cellWidth: 20 }, 1: { cellWidth: 17 }, 2: { cellWidth: 'auto' }, 3: { cellWidth: 13 }, 4: { cellWidth: 17 }, 5: { cellWidth: 20 }, 6: { cellWidth: 13 }, 7: { cellWidth: dayColW }, 8: { cellWidth: dayColW }, 9: { cellWidth: dayColW }, 10: { cellWidth: dayColW }, 11: { cellWidth: dayColW } };

            const byLine = { A: [], B: [], C: [] };
            dbData.forEach(i => { if (byLine[i.line]) byLine[i.line].push(i); });
            const daysOrder = ['월', '화', '수', '목', '금'];
            let lastY = 25;

            ['A', 'B', 'C'].forEach(line => {
                if (byLine[line].length > 0) {
                    if (lastY > 250) { doc.addPage(); lastY = 20; }
                    doc.setFontSize(14); doc.setFont('Paperlogy', 'normal'); doc.text(`${line}라인`, 14, lastY + 10);

                    const body = byLine[line].map(item => {
                        const getDay = (s) => (s && s.match(/\(([^)]+)\)/)) ? s.match(/\(([^)]+)\)/)[1] : null;
                        const start = isPlan ? getDay(item.startDate) : getDay(item.actualStartDate);
                        const end = isPlan ? getDay(item.endDate) : getDay(item.actualEndDate);
                        const sIdx = daysOrder.indexOf(start), eIdx = daysOrder.indexOf(end);
                        const finalE = (sIdx > -1 && eIdx === -1) ? sIdx : eIdx;
                        const flags = daysOrder.map((d, i) => (sIdx > -1 && finalE > -1 && sIdx <= finalE && i >= sIdx && i <= finalE) ? 1 : 0);

                        if (isPlan) return [item.company, item.model, item.orderMonth || '', item.tb || 'Top', item.lot, ...flags];
                        else return [item.manager || '', item.company, item.model, item.orderMonth || '', item.tb || 'Top', item.lot, item.actualProd || '', ...flags];
                    });

                    doc.autoTable({
                        head: head, body: body, startY: lastY + 15, theme: 'grid',
                        styles: { font: 'Paperlogy', fontStyle: 'normal', fontSize: 9, lineWidth: 0.1, lineColor: [150, 150, 150], halign: 'center' },
                        headStyles: { fontStyle: 'normal', fillColor: [200, 200, 200], textColor: 0 },
                        columnStyles: colStyles,
                        didDrawCell: function (data) {
                            const startCol = isPlan ? 5 : 7;
                            if (data.column.index >= startCol && data.cell.section === 'body') {
                                if (data.cell.raw === 1) doc.setFillColor(255, 255, 0); else doc.setFillColor(255, 255, 255);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'FD'); data.cell.text = [''];
                            }
                        }
                    });
                    lastY = doc.autoTable.previous.finalY;
                }
            });
            doc.save(`${year}년-${month}월-${weekNum}주차_${isPlan ? '생산계획서' : '생산보고서'}.pdf`);
        }

        function getWeekdaysForWeek(y, m, w) {
            const d = new Date(y, m, 1); d.setDate(d.getDate() - d.getDay() + (w - 1) * 7);
            const res = [];
            for (let i = 0; i < 7; i++) { const cur = new Date(d); cur.setDate(d.getDate() + i); if (cur.getDay() >= 1 && cur.getDay() <= 5) res.push({ month: cur.getMonth() + 1, day: cur.getDate(), dayOfWeek: cur.getDay() }); }
            return res;
        }
        function getProductionWeeksInMonth(y, m) {
            const s = new Set(); const last = new Date(y, m + 1, 0).getDate();
            for (let i = 1; i <= last; i++) { const d = new Date(y, m, i); if (d.getDay() >= 1 && d.getDay() <= 5) s.add(Math.ceil((i + new Date(y, m, 1).getDay()) / 7)); }
            return s;
        }
        function getCurrentWeekNumber(d) { return Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7); }
        function updateTime() {
            const d = new Date(); document.getElementById('current-time').textContent = `${d.getFullYear()}년 ${(d.getMonth() + 1).toString().padStart(2, '0')}월 ${d.getDate().toString().padStart(2, '0')}일 ${d.getHours().toString().padStart(2, '0')}시 ${d.getMinutes().toString().padStart(2, '0')}분`;
        }
        /* [최종 통합] 커스텀 탐색 모달 제어 및 신규 모델 등록 로직 */
        let pendingModelData = null;
        let modalCurrentPath = []; // 모달 내부의 현재 탐색 경로 저장

        // 1. [누락되었던 함수] 모델 입력 시 존재 여부 체크 및 모달 트리거
        async function handleModelInput(companyInput, modelInput) {
            const companyName = companyInput.value.trim();
            const modelName = modelInput.value.trim();

            if (!companyName || !modelName) return;

            try {
                // 모델 존재 여부 확인 API 호출
                const checkRes = await fetch('http://127.0.0.1:5000/api/production/models/check-and-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: companyName, model: modelName, create: false })
                });
                const checkData = await checkRes.json();

                // 모델이 없는 경우 커스텀 모달 호출
                if (checkData.status === 'missing_model') {
                    pendingModelData = {
                        company: companyName,
                        model: modelName,
                        company_id: checkData.company_id
                    };
                    modalCurrentPath = []; // 경로 초기화
                    openNewModelModal(modelName, checkData.company_id);
                }
            } catch (err) {
                console.error("모델 확인 중 오류:", err);
                showAppAlert("서버 통신 중 오류가 발생했습니다.", "error");
            }
        }

        // 2. 커스텀 알림 제어
        function showAppAlert(message, type = 'info') {
            const modal = document.getElementById('custom-alert-modal');
            const msgEl = document.getElementById('alert-message');
            const iconEl = document.getElementById('alert-icon');

            msgEl.textContent = message;
            iconEl.className = type === 'error' ? 'uil uil-exclamation-octagon' : 'uil uil-check-circle';
            iconEl.style.color = type === 'error' ? '#ff4444' : 'var(--point-gold)';

            modal.classList.add('visible');
        }

        function closeCustomAlert() {
            document.getElementById('custom-alert-modal').classList.remove('visible');
        }

        // 3. 모달 내 폴더 생성 토글 및 실행
        function toggleNewFolderInput(show) {
            document.getElementById('new-folder-input-area').style.display = show ? 'flex' : 'none';
            if (show) document.getElementById('new-folder-name').focus();
        }

        async function createNewFolderInModal() {
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return showAppAlert("폴더 이름을 입력하세요.", "error");

            const parentId = modalCurrentPath.length > 0 ? modalCurrentPath[modalCurrentPath.length - 1].id : null;

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        company_id: pendingModelData.company_id,
                        parent_folder_id: parentId,
                        section: 'common'
                    })
                });

                if (res.ok) {
                    document.getElementById('new-folder-name').value = '';
                    toggleNewFolderInput(false);
                    // 현재 위치 리스트 새로고침
                    openNewModelModal(pendingModelData.model, pendingModelData.company_id, parentId);
                } else {
                    showAppAlert("폴더 생성 실패", "error");
                }
            } catch (e) { showAppAlert("서버 통신 오류", "error"); }
        }

        // 4. 모달 열기 및 폴더 리스트 렌더링
        async function openNewModelModal(modelName, companyId, folderId = null) {
            document.getElementById('target-model-name').textContent = modelName;
            const listContainer = document.getElementById('folder-selector-list');
            const breadcrumbContainer = document.getElementById('modal-breadcrumb');

            listContainer.innerHTML = '<div style="text-align:center; padding:50px; color:#666;"><i class="uil uil-spinner uil-spin" style="font-size:1.5rem;"></i></div>';

            try {
                const url = `http://127.0.0.1:5000/api/production/directory?company_id=${companyId}&folder_id=${folderId || ''}&section=common`;
                const res = await fetch(url);
                const data = await res.json();

                // 브레드크럼 업데이트
                let bcHtml = `<span style="cursor:pointer; color: ${!folderId ? 'var(--point-gold)' : '#888'}" onclick="navigateInModal(null)">Root</span>`;
                modalCurrentPath.forEach((step, idx) => {
                    bcHtml += ` <i class="uil uil-angle-right" style="font-size:0.7rem;"></i> <span style="cursor:pointer; color: ${idx === modalCurrentPath.length - 1 ? 'var(--point-gold)' : '#888'}" onclick="navigateInModal('${step.id}', ${idx})">${step.name}</span>`;
                });
                breadcrumbContainer.innerHTML = bcHtml;

                let html = '';
                if (folderId) {
                    html += `<div style="padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor:pointer; color:#888; font-size:0.85rem;" onclick="navigateInModalBack()"><i class="uil uil-corner-up-left" style="margin-right:8px;"></i> ... 상위 폴더로</div>`;
                }

                html += `<label class="check-item" style="padding: 12px 15px; border-bottom: 1px solid rgba(255,235,167,0.15); cursor:pointer; background: rgba(255,235,167,0.05); display:flex; align-items:center;"><input type="radio" name="target-folder" value="${folderId || 'root'}" checked><i class="uil uil-check-circle" style="margin: 0 10px; color:var(--point-gold); font-size:1.1rem;"></i><span style="color:#fff;">(현재 위치에 등록)</span></label>`;

                if (data.folders && data.folders.length > 0) {
                    data.folders.forEach(f => {
                        html += `<div class="modal-folder-row" style="display:flex; align-items:center; border-bottom: 1px solid rgba(255,255,255,0.03);"><label class="check-item" style="flex:1; padding: 12px 15px; cursor:pointer; display:flex; align-items:center;"><input type="radio" name="target-folder" value="${f.id}"><i class="uil uil-folder" style="margin: 0 10px; color:#fddb72; font-size:1.1rem;"></i><span>${f.name}</span></label><div style="padding: 10px 20px; color:var(--point-gold); cursor:pointer;" onclick="navigateInModal('${f.id}', null, '${f.name}')"><i class="uil uil-arrow-right"></i></div></div>`;
                    });
                }
                listContainer.innerHTML = html;
                document.getElementById('new-model-reg-modal').classList.add('visible');
            } catch (e) { listContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#ff4444;">오류가 발생했습니다.</div>'; }
        }

        // 5. 탐색 및 등록 실행
        function navigateInModal(folderId, index = null, folderName = null) {
            if (folderId === null) modalCurrentPath = [];
            else if (index !== null) modalCurrentPath = modalCurrentPath.slice(0, index + 1);
            else modalCurrentPath.push({ id: folderId, name: folderName });
            openNewModelModal(pendingModelData.model, pendingModelData.company_id, folderId);
        }

        function navigateInModalBack() {
            modalCurrentPath.pop();
            const prevFolderId = modalCurrentPath.length > 0 ? modalCurrentPath[modalCurrentPath.length - 1].id : null;
            openNewModelModal(pendingModelData.model, pendingModelData.company_id, prevFolderId);
        }

        function closeNewModelModal() {
            document.getElementById('new-model-reg-modal').classList.remove('visible');
            pendingModelData = null; modalCurrentPath = [];
        }

        /* [수정] production.html 최하단: 순서 보정으로 Null 에러 해결 */
        document.getElementById('confirm-model-reg-btn').onclick = async () => {
            if (!pendingModelData) return;

            const selectedVal = document.querySelector('input[name="target-folder"]:checked').value;
            const folderId = (selectedVal === 'root') ? null : selectedVal;

            try {
                const createRes = await fetch('http://127.0.0.1:5000/api/production/models/check-and-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company: pendingModelData.company,
                        model: pendingModelData.model,
                        create: true,
                        folder_id: folderId,
                        section: 'common' // 통합 관리 섹션으로 통일
                    })
                });

                const result = await createRes.json();
                if (!createRes.ok) throw new Error(result.error || "Server Error");

                if (result.status === 'created') {
                    // [핵심] 모달을 닫기 전에 알림에 쓸 이름을 미리 변수에 저장합니다.
                    const successModelName = pendingModelData.model;

                    closeNewModelModal(); // 여기서 pendingModelData가 null이 됩니다.

                    // 미리 저장해둔 이름을 사용하여 알림을 띄웁니다.
                    showAppAlert(`'${successModelName}' 모델이 통합 관리 섹션에 등록되었습니다.`);
                }
            } catch (err) {
                showAppAlert("등록 중 오류가 발생했습니다: " + err.message, "error");
            }
        };
    </script>

    <div id="global-tooltip"></div>

    <script>
        /* -------------------------------------------------------------
           전역 툴팁 제어 스크립트 (테이블 밖, 화면 최상위에 표시)
           ------------------------------------------------------------- */
        const globalTooltip = document.getElementById('global-tooltip');

        document.addEventListener('mouseover', function (e) {
            // 아이콘에 마우스가 올라갔을 때
            if (e.target.classList.contains('note-badge-icon')) {
                const text = e.target.getAttribute('data-tooltip');
                if (text) {
                    globalTooltip.textContent = text;
                    globalTooltip.style.display = 'block';

                    const rect = e.target.getBoundingClientRect();

                    // 아이콘의 바로 오른쪽 상단에 위치하도록 계산
                    // (스크롤 위치 포함)
                    globalTooltip.style.top = (rect.top - 30) + 'px';
                    globalTooltip.style.left = (rect.right + 10) + 'px';
                }
            }
        });

        document.addEventListener('mouseout', function (e) {
            // 마우스가 떠나면 숨김
            if (e.target.classList.contains('note-badge-icon')) {
                globalTooltip.style.display = 'none';
            }
        });
    </script>
</body>

</html>
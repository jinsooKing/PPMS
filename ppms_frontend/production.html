<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 생산 일정 관리</title>
    
    <link rel="stylesheet" href="common.css">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <script src="auth.js"></script>
    <script src="calendar.js"></script>
    <script src="paperlogy-font.js"></script>
    <script src="logo.js"></script>
    <style>
        /* --- [1. 테마 변수] --- */
        :root {
            --bg-dark: #1f2029;
            --card-bg: #2a2b38;
            --text-color: #c4c3ca;
            --text-white: #ffffff;
            --point-gold: #ffeba7;
            --accent-blue: #102770;
            --danger-red: #ff4444;
            --border-color: rgba(255, 235, 167, 0.1);
        }
        body { opacity: 0; }

        /* --- [2. 레이아웃] --- */
        body {
            background-color: var(--bg-dark);
            background-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1462889/pat.svg');
            background-position: center;
            background-repeat: repeat;
            background-size: 300%;
            color: var(--text-color);
            font-family: 'Poppins', 'BMDOHYEON', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        a, a:hover { text-decoration: none; color: inherit; }

        .page-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            backdrop-filter: blur(2px);
        }

        .content-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
            width: 100%;
        }

        /* --- [3. 헤더 & 푸터] --- */
        .main-header, .main-footer {
            background: rgba(31, 32, 41, 0.95);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 10px 30px;
            display: flex;
            align-items: center;
            z-index: 100;
            flex-shrink: 0;
            position: relative;
        }

        .main-footer {
            border-top: 1px solid var(--border-color);
            border-bottom: none;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        .header-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            white-space: nowrap;
        }

        .header-right { margin-left: auto; z-index: 2; }

        /* 버튼 스타일 */
        .common-box, .footer-btn {
            background: var(--card-bg) !important;
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 6px 18px;
            font-family: 'BMJUA', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: none;
            white-space: nowrap;
        }

        .common-box:hover, .footer-btn:hover {
            background: var(--point-gold) !important;
            color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(255, 235, 167, 0.4);
            border-color: transparent;
        }

        /* --- [4. 로고] --- */
        .svg-sprite { position: absolute; width: 0; height: 0; }
        .header-logo-wrapper { position: relative; display: flex; align-items: center; transform: translateZ(0); cursor: pointer; flex-shrink: 0; }
        .header-logo { height: 35px; width: auto; fill: var(--point-gold); transition: fill 0.2s ease; filter: drop-shadow(0 0 5px rgba(255, 235, 167, 0.4)); display: block; }
        .header-logo-wrapper.btn-glitch-active .header-logo { fill: #ffffff; -webkit-filter: url('#filter'); filter: url('#filter'); }

        .header-center .common-box { background: transparent !important; border: none; color: var(--point-gold); font-family: 'Poppins', 'BMDOHYEON', sans-serif; font-weight: 800; font-size: 1.8rem; letter-spacing: 2px; text-transform: uppercase; pointer-events: none; }
        .time-display { color: var(--text-color); font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 1rem; background: transparent !important; border: none; }
        .footer-center { display: flex; flex-direction: row; gap: 15px; align-items: center; justify-content: center; }

        /* --- [5. 메인 뷰 테이블] --- */
        #schedule-display-area { width: 100%; max-width: 1600px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .line-schedule-section { background-color: var(--card-bg); border-radius: 10px; padding: 10px 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.05); }
        .line-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 5px; }
        
        .line-title-group { display: flex; align-items: center; gap: 15px; }
        .line-title { font-family: 'BMDOHYEON', sans-serif; font-size: 1.3rem; color: var(--text-white); margin: 0; display: flex; align-items: center; gap: 10px; }
        .line-title::before { content: ''; display: block; width: 4px; height: 16px; background-color: var(--point-gold); border-radius: 2px; }
        
        .table-container { 
            overflow-x: auto; 
            overflow-y: auto; 
            max-height: 60vh; 
            border-radius: 6px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        table.editable-table { width: 100%; border-collapse: collapse; font-family: 'Poppins', 'BMJUA', sans-serif; color: var(--text-color); }
        table.editable-table th, table.editable-table td { padding: 4px 6px; white-space: nowrap; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.85rem; height: 32px; }
        
        table.editable-table th { 
            background-color: #1a1b23; 
            color: var(--point-gold); 
            font-weight: 600; 
            text-transform: uppercase; 
            border-bottom: 2px solid rgba(255, 235, 167, 0.2); 
            position: sticky; 
            top: 0; 
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        table.editable-table tbody tr:hover { background-color: rgba(255, 235, 167, 0.05); }

        .form-input, .form-select { background: transparent; border: 1px solid transparent; color: #fff; font-family: inherit; font-size: 0.85rem; text-align: center; width: 100%; height: 26px; padding: 0 4px; border-radius: 3px; }
        .form-input:focus, .form-select:focus { background-color: #15151a; border-color: var(--point-gold); outline: none; }
        select.form-select { background-color: #2a2b38; }

        .progress-bar-container { width: 120px; height: 10px; background-color: #15151a; border-radius: 5px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--point-gold), #ffbc00); width: 0%; transition: width 0.5s ease; }
        .progress-bar-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 9px; color: #fff; text-shadow: 0 0 3px #000; font-weight: bold; }
        
        /* 헤더 컨트롤 및 버튼 스타일 */
        .header-controls { display: flex; align-items: center; gap: 8px; }
        
        /* 기본 텍스트 버튼 */
        .text-btn { 
            background: #3a3a3c; border: 1px solid #555; color: #fff; 
            font-size: 0.9rem; font-family: 'BMJUA', sans-serif;
            cursor: pointer; padding: 5px 12px; 
            border-radius: 5px; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            height: 32px;
            white-space: nowrap;
        }
        .text-btn:hover { background: #555; color: var(--point-gold); transform: translateY(-2px); }
        
        /* 불러오기 선택 옵션 컨테이너 */
        .import-options-container {
            display: flex;
            gap: 5px;
            overflow: hidden;
            max-width: 0;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none;
        }
        .import-options-container.active { 
            max-width: 300px; 
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
            margin-left: 5px;
        }
        
        .import-option-btn {
            background-color: #15151a; 
            color: #ccc;
            border: 1px solid rgba(255, 235, 167, 0.3); 
            border-radius: 4px;
            padding: 5px 10px;
            font-family: 'BMJUA';
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .import-option-btn:hover { 
            background-color: var(--point-gold); 
            color: var(--accent-blue);
            border-color: var(--point-gold);
            transform: translateY(-1px);
        }

        /* 삭제 모드 스타일 */
        .text-btn.delete-mode-active { 
            background-color: var(--danger-red); 
            border-color: var(--danger-red); 
            color: #fff; 
            animation: pulse-red 2s infinite; 
        }
        .delete-mode tbody tr { cursor: pointer; transition: background-color 0.2s; }
        .delete-mode tbody tr:hover { background-color: rgba(255, 68, 68, 0.2) !important; }
        .delete-mode tbody tr:hover td { color: #ffcccc; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        /* 애니메이션 */
        @keyframes rowFadeIn { 
            from { opacity: 0; transform: translateY(-15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes rowFadeOutNatural { 
            0% { opacity: 1; transform: scale(1); background-color: rgba(255,68,68,0.1); }
            100% { opacity: 0; transform: scale(0.98); background-color: rgba(255,68,68,0.3); } 
        }
        .animate-in { animation: rowFadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .animate-out { animation: rowFadeOutNatural 0.35s ease-out forwards; }

        /* --- [6. 모달 공통 스타일] --- */
        @keyframes fadeInOverlay { from { background-color: rgba(0,0,0,0); } to { background-color: rgba(0,0,0,0.85); } }
        @keyframes modalSlideUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        .modal-overlay.visible { display: flex; animation: fadeInOverlay 0.3s forwards; }
        .modal-overlay.visible .modal-window { animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .modal-window { 
            background-color: #23242d; border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6); color: #fff;
            display: flex; flex-direction: column; 
            max-height: 90vh; border-radius: 12px;
        }
        .modal-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .modal-title { color: var(--point-gold); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 15px; margin: 0; flex-shrink: 0; font-family: 'BMJUA'; }
        .modal-footer { padding: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; display: flex; justify-content: space-between; }
        .close-btn { position: absolute; top: 15px; right: 20px; color: #888; font-size: 2rem; background: none; border: none; cursor: pointer; z-index: 10; }
        .close-btn:hover { color: var(--point-gold); }

        /* --- [7. 일정 등록 모달 (탭 스타일)] --- */
        .line-tab-nav {
            display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); 
            background: #15151a; flex-shrink: 0; 
        }
        .line-tab-btn {
            flex: 1; padding: 15px; background: transparent; border: none; 
            color: #888; cursor: pointer; font-family: 'BMJUA'; font-size: 1.1rem; 
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .line-tab-btn:hover { color: #ddd; background: rgba(255,255,255,0.05); }
        .line-tab-btn.active { 
            color: var(--point-gold); border-bottom-color: var(--point-gold); 
            background: rgba(255, 235, 167, 0.05); 
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        .registration-table th { background-color: #15151a; color: #aaa; padding: 10px; font-size: 0.9rem; }
        .registration-table td { padding: 6px; }
        .registration-table input, .registration-table select { background-color: rgba(255,255,255,0.05); border-radius: 4px; height: 34px; }
        
        .action-btn { border-radius: 4px; width: 24px; height: 24px; line-height: 22px; padding: 0; font-size: 12px; color:white; border:none; cursor: pointer; }
        
        /* --- [8. 비고 모달 UI] --- */
        .notes-modal-content-container { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .notes-tab-nav { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); background: #15151a; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: #888; cursor: pointer; font-family: 'BMJUA'; font-size: 1rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #ddd; }
        .tab-btn.active { color: var(--point-gold); border-bottom-color: var(--point-gold); background: rgba(255, 235, 167, 0.05); }
        .notes-modal-content { flex: 1; overflow-y: auto; padding: 20px; background: #1a1b23; }
        .notes-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .notes-tab-content.active { display: block; }
        .note-item { background: #23242d; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .note-item h4 { margin: 0 0 10px 0; color: var(--point-gold); font-size: 0.95rem; }
        .note-item textarea { width: 100%; min-height: 80px; background: #15151a; border: 1px solid #444; color: #eee; padding: 10px; border-radius: 5px; font-family: 'Poppins', sans-serif; resize: vertical; font-size: 0.9rem; line-height: 1.5; }
        .note-item textarea:focus { border-color: var(--point-gold); outline: none; }

        /* --- [9. 주차 선택 모달 UI] --- */
        #week-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px; }
        .week-box { background: linear-gradient(145deg, #2a2b38, #23242d); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 20px 10px; text-align: center; color: #c4c3ca; font-family: 'BMJUA', sans-serif; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .week-box:hover { background: var(--point-gold); color: var(--accent-blue); transform: translateY(-5px); box-shadow: 0 8px 15px rgba(255, 235, 167, 0.3); border-color: transparent; }
        
        .period-selector-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; }
        .period-btn { background-color: #2a2b38; color: var(--text-white); padding: 15px; border-radius: 10px; text-align: center; font-family: 'BMJUA', sans-serif; font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .period-btn:hover { background-color: var(--point-gold); color: var(--accent-blue); transform: translateY(-2px); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            .main-header { padding: 10px; flex-direction: column; height: auto; gap: 10px; }
            .header-center { position: static; transform: none; order: -1; margin-bottom: 5px; }
            .header-left { width: 100%; justify-content: space-between; }
            .header-right { display: none; }
            .line-schedule-section { padding: 10px; }
        }
    </style>
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="ppms-logo-placeholder"></a>
                <div id="current-week-display" class="common-box clickable-box">
                    <i class="uil uil-calendar-alt"></i> <span>Loading...</span>
                </div>
            </div>
            <div class="header-center">
                <div class="common-box">PRODUCTION (SMD)</div>
            </div>
            <div class="header-right">
                <div class="common-box time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div id="schedule-display-area"></div>
        </main>

        <footer class="main-footer">
            <div class="footer-left">
                <div class="footer-btn" id="reg-schedule-btn">
                    <i class="uil uil-edit"></i> 일정 등록
                </div>
            </div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right">
                <div class="footer-btn" id="week-picker-btn" style="position: relative;">
                    <i class="uil uil-history"></i> 이전 데이터
                </div>
            </div>
        </footer>
    </div>

    <div class="modal-overlay" id="week-selector-dropup">
        <div class="modal-window small-modal" style="width:auto; max-width:500px; height:auto; max-height:80vh;">
            <button class="close-btn" id="close-week-modal-btn" onclick="closeWeekSelectorDropup()">&times;</button>
            <h3 class="modal-title">주차 선택</h3>
            <div class="modal-content">
                <div class="grid-container" id="week-selector-grid" style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="schedule-modal">
        <div class="modal-window" style="width: 95vw; max-width: 1600px;">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            <h2 class="modal-title" id="modal-title">생산 일정 등록</h2>
            
            <nav class="line-tab-nav">
                <button class="line-tab-btn active" data-line-tab="A">A LINE</button>
                <button class="line-tab-btn" data-line-tab="B">B LINE</button>
                <button class="line-tab-btn" data-line-tab="C">C LINE</button>
            </nav>

            <div class="modal-content">
                
                <section class="line-schedule-section tab-content active" id="tab-content-A" data-line="A">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">A LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-A">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="B">B라인</button>
                                    <button class="import-option-btn" data-source="C">C라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-A">
                            <colgroup>
                                <col style="width:15%"> <col style="width:8%"> <col style="width:27%"> <col style="width:10%"> 
                                <col style="width:10%"> <col style="width:10%"> <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th><th>년도</th><th>모델명</th><th>발주월</th>
                                    <th>T/B</th><th>LOT</th><th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-A"></tbody>
                        </table>
                    </div>
                </section>

                <section class="line-schedule-section tab-content" id="tab-content-B" data-line="B">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">B LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-B">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="A">A라인</button>
                                    <button class="import-option-btn" data-source="C">C라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-B">
                            <colgroup>
                                <col style="width:15%"> <col style="width:8%"> <col style="width:27%"> <col style="width:10%"> 
                                <col style="width:10%"> <col style="width:10%"> <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th><th>년도</th><th>모델명</th><th>발주월</th>
                                    <th>T/B</th><th>LOT</th><th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-B"></tbody>
                        </table>
                    </div>
                </section>

                <section class="line-schedule-section tab-content" id="tab-content-C" data-line="C">
                    <div class="line-header">
                        <div class="line-title-group">
                            <h3 class="line-title">C LINE 스케줄</h3>
                            <div class="header-controls" id="header-controls-C">
                                <button class="text-btn import-line-btn" title="다른 라인에서 가져오기">불러오기</button>
                                <div class="import-options-container">
                                    <button class="import-option-btn" data-source="A">A라인</button>
                                    <button class="import-option-btn" data-source="B">B라인</button>
                                </div>
                                <button class="text-btn add-row-btn" title="행 추가">행 추가</button>
                                <button class="text-btn toggle-delete-btn" title="삭제 모드">행 삭제</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="editable-table registration-table" id="table-C">
                            <colgroup>
                                <col style="width:15%"> <col style="width:8%"> <col style="width:27%"> <col style="width:10%"> 
                                <col style="width:10%"> <col style="width:10%"> <col style="width:20%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>업체</th><th>년도</th><th>모델명</th><th>발주월</th>
                                    <th>T/B</th><th>LOT</th><th>생산예정일</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body-C"></tbody>
                        </table>
                    </div>
                </section>

            </div>
            <div class="modal-footer">
                <div class="common-box reset-btn" id="reset-btn" style="background-color: #8B0000 !important; border-color: #ff4444;"><i class="uil uil-trash-alt"></i> 초기화</div>
                <div class="common-box" id="save-all-btn" style="background-color: var(--accent-blue) !important;"><i class="uil uil-save"></i> 저장하기</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="notes-modal">
        <div class="modal-window" style="height: 70vh; max-width: 800px;">
            <button class="close-btn" id="close-notes-modal-btn">&times;</button>
            <h2 class="modal-title">NOTES / REMARKS</h2>
            <div class="notes-modal-content-container">
                <nav class="notes-tab-nav">
                    <button class="tab-btn active" data-tab="A">A LINE</button>
                    <button class="tab-btn" data-tab="B">B LINE</button>
                    <button class="tab-btn" data-tab="C">C LINE</button>
                </nav>
                <div class="notes-modal-content">
                    <div id="notes-content-A" class="notes-tab-content active"></div>
                    <div id="notes-content-B" class="notes-tab-content"></div>
                    <div id="notes-content-C" class="notes-tab-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="export-choice-modal">
        <div class="modal-window small-modal" style="max-width: 350px; height: auto;">
            <button class="close-btn" id="close-export-modal-btn">&times;</button>
            <h3 class="modal-title">EXPORT AS PDF</h3>
            <div class="modal-content choice-buttons" style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
                <div id="export-plan-btn" class="common-box clickable-box" style="justify-content:center;">
                    <i class="uil uil-clipboard-notes"></i> 생산계획서
                </div>
                <div id="export-report-btn" class="common-box clickable-box" style="justify-content:center;">
                    <i class="uil uil-file-check-alt"></i> 생산보고서
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 50);

            // --- 기본 초기화 ---
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) { window.location.href = 'login.html'; return; }
            if (typeof setupLogoutButton === 'function') setupLogoutButton();

            if (userRole !== 'admin') {
                if(regScheduleBtn) regScheduleBtn.style.display='none';
                if(saveAllBtn) saveAllBtn.style.display='none';
                if(resetBtn) resetBtn.style.display='none';
            }

            setInterval(updateTime, 1000);
            updateTime();

            const urlParams = new URLSearchParams(window.location.search);
            const pYear = urlParams.get('year'), pMonth = urlParams.get('month'), pWeek = urlParams.get('week');
            if (pYear && pMonth && pWeek) displayScheduleForWeek(parseInt(pYear), parseInt(pMonth), parseInt(pWeek));
            else displayCurrentWeekSchedule();

            setupWeekPicker('week-picker-btn', (y, m, w) => displayScheduleForWeek(y, m, w));

            // Event Listeners
            backBtn.addEventListener('click', goBackView);
            homeBtn.addEventListener('click', () => window.location.href = 'index.html');
            forwardBtn.addEventListener('click', goForwardView);
            if(regScheduleBtn) regScheduleBtn.addEventListener('click', openWeekSelectorDropup);
            
            weekSelectorDropup.addEventListener('click', (e) => { if(e.target === weekSelectorDropup) closeWeekSelectorDropup(); });
            weekSelectorGrid.addEventListener('click', handleWeekSelection);

            if(saveAllBtn) saveAllBtn.addEventListener('click', saveSchedules);
            if(resetBtn) resetBtn.addEventListener('click', resetSchedules);
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            modalWindow.addEventListener('click', e => e.stopPropagation());

            // [모달 이벤트 수정: 행 추가, 삭제 모드, 라인 가져오기]
            modalWindow.addEventListener('click', function (event) {
                if (localStorage.getItem('ppms_user_role') === 'admin') {
                    
                    // 1. 행 추가
                    if (event.target.closest('.add-row-btn')) {
                        const btn = event.target.closest('.add-row-btn');
                        const section = btn.closest('.line-schedule-section');
                        const line = section.dataset.line;
                        addNewScheduleRow(section.querySelector('tbody'), line);
                    }

                    // 2. 삭제 모드 토글
                    if (event.target.closest('.toggle-delete-btn')) {
                        const btn = event.target.closest('.toggle-delete-btn');
                        const table = btn.closest('.line-schedule-section').querySelector('table');
                        btn.classList.toggle('delete-mode-active');
                        table.classList.toggle('delete-mode');
                    }

                    // 3. 불러오기 메뉴 토글
                    if (event.target.closest('.import-line-btn')) {
                        const btn = event.target.closest('.import-line-btn');
                        const section = btn.closest('.line-schedule-section');
                        const optionsContainer = section.querySelector('.import-options-container');
                        
                        // 다른 섹션의 열린 메뉴 닫기
                        document.querySelectorAll('.import-options-container').forEach(el => {
                            if(el !== optionsContainer) el.classList.remove('active');
                        });

                        // 현재 섹션 메뉴 토글
                        if(optionsContainer) optionsContainer.classList.toggle('active');
                    }

                    // 4. 특정 라인 가져오기 선택 (B라인 등)
                    if (event.target.classList.contains('import-option-btn')) {
                        const sourceLine = event.target.dataset.source;
                        const targetLine = event.target.closest('.line-schedule-section').dataset.line;
                        
                        copyScheduleFromLine(sourceLine, targetLine);
                        
                        // 메뉴 닫기
                        const container = event.target.closest('.import-options-container');
                        if(container) container.classList.remove('active');
                    }

                    // 5. 행 삭제 (삭제 모드일 때)
                    const row = event.target.closest('tr');
                    if (row && row.closest('table').classList.contains('delete-mode')) {
                        handleRowDelete(row);
                    }
                }
            });
            
            // [모달 이벤트] 탭 전환
            const lineTabNav = document.querySelector('.line-tab-nav');
            if(lineTabNav) {
                lineTabNav.addEventListener('click', (e) => {
                    if(e.target.classList.contains('line-tab-btn')) {
                        // 버튼 활성화 처리
                        lineTabNav.querySelectorAll('.line-tab-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        // 컨텐츠 표시 처리
                        const targetLine = e.target.dataset.lineTab;
                        const modalContent = document.querySelector('#schedule-modal .modal-content');
                        modalContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(`tab-content-${targetLine}`).classList.add('active');
                        
                        // 탭 전환 시 불러오기 메뉴 닫기
                        document.querySelectorAll('.import-options-container').forEach(el => el.classList.remove('active'));
                    }
                });
            }

            const validate = (e, reg, msg) => {
                const val = e.target.value, sanitized = val.replace(reg, '');
                if(val !== sanitized) { e.target.value = sanitized; showValidationMessage(e.target, msg); }
            };
            modalWindow.addEventListener('input', e => { if(e.target.dataset.field==='lot-modal') validate(e, /[^0-9/]/g, "숫자/' 만 가능"); });
            displayArea.addEventListener('input', e => {
                if(e.target.dataset.field==='lot') validate(e, /[^0-9/]/g, "숫자/' 만 가능");
                else if(e.target.dataset.field==='actualProd') validate(e, /[^0-9/]/g, "숫자만 가능");
            });

            displayArea.addEventListener('click', function(e) {
                if(e.target.closest('.period-btn')) {
                    const d = e.target.closest('.period-btn').dataset;
                    navigateToView(d.view, {year:parseInt(d.year), month:parseInt(d.month), weekNum:parseInt(d.week)});
                }
                if(e.target.closest('#open-export-modal-btn')) exportChoiceModal.classList.add('visible');
                if(e.target.closest('#open-notes-modal-btn')) openNotesModal();
            });
            displayArea.addEventListener('change', handleTableInputChange);

            // PDF
            const closeExport = () => exportChoiceModal.classList.remove('visible');
            closeExportModalBtn.addEventListener('click', closeExport);
            exportChoiceModal.addEventListener('click', closeExport);
            exportChoiceModal.querySelector('.modal-window').addEventListener('click', e => e.stopPropagation());
            exportPlanBtn.addEventListener('click', async () => { await generateProductionPdf('plan'); closeExport(); });
            exportReportBtn.addEventListener('click', async () => { await generateProductionPdf('report'); closeExport(); });

            // Notes
            const closeNotes = () => notesModal.classList.remove('visible');
            closeNotesModalBtn.addEventListener('click', closeNotes);
            notesModal.addEventListener('click', e => { if(e.target===notesModal) closeNotes(); });
            notesModal.querySelector('.modal-window').addEventListener('click', e => e.stopPropagation());
            notesTabNav.addEventListener('click', e => {
                if(e.target.classList.contains('tab-btn')) {
                    notesTabNav.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                    notesContentContainer.querySelectorAll('.notes-tab-content').forEach(c=>c.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`notes-content-${e.target.dataset.tab}`).classList.add('active');
                }
            });
            notesContentContainer.addEventListener('change', handleNoteSave);
        });

        // --- 전역 변수 ---
        const displayArea = document.getElementById('schedule-display-area');
        const contentArea = document.querySelector('.content-area');
        const backBtn = document.getElementById('back-btn');
        const homeBtn = document.getElementById('home-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const weekDisplay = document.getElementById('current-week-display');
        const regScheduleBtn = document.getElementById('reg-schedule-btn');
        const weekSelectorDropup = document.getElementById('week-selector-dropup');
        const weekSelectorGrid = document.getElementById('week-selector-grid');
        const modalOverlay = document.getElementById('schedule-modal');
        const modalWindow = modalOverlay.querySelector('.modal-window');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveAllBtn = document.getElementById('save-all-btn');
        const resetBtn = document.getElementById('reset-btn');
        const exportChoiceModal = document.getElementById('export-choice-modal');
        const closeExportModalBtn = document.getElementById('close-export-modal-btn');
        const exportPlanBtn = document.getElementById('export-plan-btn');
        const exportReportBtn = document.getElementById('export-report-btn');
        const lineControls = {
            'A': { tableBody: document.getElementById('schedule-table-body-A') },
            'B': { tableBody: document.getElementById('schedule-table-body-B') },
            'C': { tableBody: document.getElementById('schedule-table-body-C') }
        };
        const notesModal = document.getElementById('notes-modal');
        const closeNotesModalBtn = document.getElementById('close-notes-modal-btn');
        const notesTabNav = notesModal.querySelector('.notes-tab-nav');
        const notesContentContainer = notesModal.querySelector('.notes-modal-content');

        let currentView = { mode: 'current_week', data: {} };
        let viewHistory = [], forwardHistory = [], currentSelectedWeekInfo = {};
        let managerList = [], companyList = [];
        
        function isEditAllowed() {
            const r = localStorage.getItem('ppms_user_role');
            if(r==='admin') return true;
            if(r==='user') {
                const d=new Date(), y=d.getFullYear(), m=d.getMonth()+1, w=getCurrentWeekNumber(d);
                const v=currentView.data;
                if(v.year===y && v.month===m && v.weekNum===w) return true;
            }
            return false;
        }

        function showValidationMessage(target, msg) {
            const p = target.parentElement;
            let m = p.querySelector('.validation-message');
            if(!m) { m = document.createElement('span'); m.className='validation-message'; p.appendChild(m); }
            m.textContent = msg; m.classList.add('visible');
            if(m.dataset.tid) clearTimeout(m.dataset.tid);
            m.dataset.tid = setTimeout(()=>m.classList.remove('visible'), 2000);
        }

        async function loadMasterData() {
            try {
                const [m, c] = await Promise.all([
                    fetch('http://127.0.0.1:5000/api/production/managers'),
                    fetch('http://127.0.0.1:5000/api/production/companies')
                ]);
                managerList = await m.json(); companyList = await c.json();
            } catch(e) { console.error(e); }
        }

        function saveSchedules() {
            if(localStorage.getItem('ppms_user_role')!=='admin') return alert('권한 없음');
            const scheds = [];
            for(const l in lineControls) {
                lineControls[l].tableBody.querySelectorAll('tr').forEach(r => {
                    const c = r.querySelector('[data-field="company-modal"]').value, m = r.querySelector('[data-field="model-modal"]').value, lt = r.querySelector('[data-field="lot-modal"]').value;
                    if(c||m||lt) {
                        let yv = r.querySelector('[data-field="orderYear"]').value;
                        if(yv.length===2) yv = '20'+yv;
                        scheds.push({
                            id: r.dataset.scheduleId ? parseInt(r.dataset.scheduleId) : null,
                            line: l, company: c, model: m,
                            orderYear: parseInt(yv),
                            orderMonth: r.querySelector('[data-field="orderMonth"]').value,
                            tb: r.querySelector('[data-field="tb-modal"]').value, lot: lt,
                            startDate: r.querySelector('.start-date-select').value,
                            endDate: r.querySelector('.end-date-select').value
                        });
                    }
                });
            }
            fetch('http://127.0.0.1:5000/api/production/schedules', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ weekInfo: currentSelectedWeekInfo, schedules: scheds })
            }).then(r=>r.json()).then(d=>{ if(d.message){alert(d.message);closeModal();renderContent();}else alert("Error"); });
        }

        // [초기화 버튼: 현재 탭 내용만 비움]
        function resetSchedules() {
            if(localStorage.getItem('ppms_user_role')!=='admin') return alert('권한 없음');
            
            const activeSection = document.querySelector('.line-schedule-section.active');
            if(!activeSection) return;
            
            const line = activeSection.dataset.line;
            
            if(!confirm(`${line} 라인의 작성중인 내용을 초기화하시겠습니까?`)) return;
            
            const tbody = activeSection.querySelector('tbody');
            tbody.innerHTML = '';
            addNewScheduleRow(tbody, line); // 빈 행 추가
        }

        function openWeekSelectorDropup() {
            const y = currentView.data.year || new Date().getFullYear();
            const m = currentView.data.month ? currentView.data.month - 1 : new Date().getMonth();
            const weeks = Array.from(getProductionWeeksInMonth(y,m)).sort((a,b)=>a-b);
            weekSelectorGrid.innerHTML = '';
            weeks.forEach(w => {
                const d = document.createElement('div'); d.className = 'week-box clickable-box';
                d.textContent = `${m+1}월 ${w}주차`; d.dataset.year=y; d.dataset.month=m+1; d.dataset.week=w;
                weekSelectorGrid.appendChild(d);
            });
            weekSelectorDropup.classList.add('visible');
        }
        function closeWeekSelectorDropup() { weekSelectorDropup.classList.remove('visible'); }
        function handleWeekSelection(e) {
            if(e.target.classList.contains('week-box')) {
                const {year,month,week} = e.target.dataset;
                closeWeekSelectorDropup(); openModal({year:parseInt(year), month:parseInt(month), weekNum:parseInt(week)});
            }
        }

        async function openModal(weekInfo) {
            currentSelectedWeekInfo = weekInfo;
            const role = localStorage.getItem('ppms_user_role');
            modalTitle.textContent = `${weekInfo.month}월 ${weekInfo.weekNum}주차 생산 일정 ${role!=='admin'?'(읽기 전용)':''}`;
            for(const l in lineControls) lineControls[l].tableBody.innerHTML='';
            await loadMasterData();
            const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${weekInfo.year}&month=${weekInfo.month}&weekNum=${weekInfo.weekNum}`);
            const data = await res.json();
            if(data.length>0) data.forEach(d=>addNewScheduleRow(lineControls[d.line].tableBody, d.line, d));
            for(const l in lineControls) if(lineControls[l].tableBody.rows.length===0) addNewScheduleRow(lineControls[l].tableBody, l);
            modalOverlay.classList.add('visible');
        }
        function closeModal() { modalOverlay.classList.remove('visible'); }

        // [행 추가 함수]
        function addNewScheduleRow(target, line, data={}, after=null) {
            const role = localStorage.getItem('ppms_user_role');
            const ro = role!=='admin'?'disabled':'';
            
            const row = after ? target.insertRow(after.rowIndex) : target.insertRow();
            row.classList.add('animate-in'); 
            
            row.dataset.scheduleId = data.id||'';
            const opts = (lst,v) => lst.map(i=>`<option value="${i.name}" ${v===i.name?'selected':''}>${i.name}</option>`).join('');
            let mOpts = ''; for(let i=1; i<=12; i++) mOpts+=`<option value="${i}월분" ${(data.orderMonth||'').trim()===`${i}월분`?'selected':''}>${i}월분</option>`;
            
            const fullYear = data.orderYear || currentSelectedWeekInfo.year;
            const shortYear = String(fullYear).slice(-2);

            row.innerHTML = `
                <td><select data-field="company-modal" class="form-select" ${ro}><option value="">-</option>${opts(companyList, data.company)}</select></td>
                <td><input type="number" data-field="orderYear" class="form-input" value="${shortYear}" ${ro}></td>
                <td><input type="text" data-field="model-modal" class="form-input" value="${data.model||''}" ${ro}></td>
                <td><select data-field="orderMonth" class="form-select" ${ro}><option value="">-</option>${mOpts}</select></td>
                <td><select data-field="tb-modal" class="form-select" ${ro}><option value="Top" ${data.tb==='Top'?'selected':''}>Top</option><option value="Bot" ${data.tb==='Bot'?'selected':''}>Bot</option><option value="T/O" ${data.tb==='T/O'?'selected':''}>T/O</option><option value="B/O" ${data.tb==='B/O'?'selected':''}>B/O</option></select></td>
                <td><input type="text" data-field="lot-modal" class="form-input" value="${data.lot||''}" ${ro}></td>
                <td style="display:flex;gap:5px;"><select class="start-date-select form-select" ${ro}></select>~<select class="end-date-select form-select" ${ro}></select></td>
            `;
            populateDateSelectors(currentSelectedWeekInfo, row);
            
            const startSel = row.querySelector('.start-date-select');
            const endSel = row.querySelector('.end-date-select');
            if(startSel) startSel.value = data.startDate||''; 
            if(endSel) endSel.value = data.endDate||'';
            
            return row;
        }

        // [삭제 로직]
        function handleRowDelete(row) {
            row.classList.add('animate-out');
            setTimeout(() => {
                const tbody = row.closest('tbody');
                const section = tbody.closest('.line-schedule-section');
                const line = section.dataset.line;
                
                row.remove();
                // 모두 삭제되었으면 빈 행 추가
                if (tbody.rows.length === 0) {
                    addNewScheduleRow(tbody, line);
                }
            }, 300); // 애니메이션 시간보다 약간 짧게
        }
        
        // [다른 라인에서 일정 가져오기]
        function copyScheduleFromLine(sourceLine, targetLine) {
            const sourceTbody = document.getElementById(`schedule-table-body-${sourceLine}`);
            const targetTbody = document.getElementById(`schedule-table-body-${targetLine}`);
            
            if(!sourceTbody || !targetTbody) return;

            const sourceRows = sourceTbody.querySelectorAll('tr');
            if(sourceRows.length === 0) {
                alert(`${sourceLine} 라인에 복사할 데이터가 없습니다.`);
                return;
            }

            // 복사 시작
            sourceRows.forEach(row => {
                const company = row.querySelector('[data-field="company-modal"]').value;
                const model = row.querySelector('[data-field="model-modal"]').value;
                
                if(company || model) {
                    const data = {
                        company: company,
                        orderYear: row.querySelector('[data-field="orderYear"]').value,
                        model: model,
                        orderMonth: row.querySelector('[data-field="orderMonth"]').value,
                        tb: row.querySelector('[data-field="tb-modal"]').value,
                        lot: row.querySelector('[data-field="lot-modal"]').value,
                        startDate: row.querySelector('.start-date-select').value,
                        endDate: row.querySelector('.end-date-select').value
                    };
                    addNewScheduleRow(targetTbody, targetLine, data);
                }
            });
        }

        function populateDateSelectors(info, row) {
            if(!row || !info.year) return;
            const days = getWeekdaysForWeek(info.year, info.month-1, info.weekNum);
            const dNames = ['일','월','화','수','목','금','토'];
            const s1=row.querySelector('.start-date-select'), s2=row.querySelector('.end-date-select');
            s1.innerHTML=s2.innerHTML='';
            days.forEach(d=>{
                const txt = `${d.month}/${d.day}(${dNames[d.dayOfWeek]})`;
                s1.add(new Option(txt,txt)); s2.add(new Option(txt,txt));
            });
        }

        function renderContent() {
            const {mode, data} = currentView;
            contentArea.className = (mode==='current_week'||mode==='schedule_view') ? 'content-area align-top' : 'content-area';
            displayArea.style.marginTop = '5px';
            if(mode==='current_week'||mode==='schedule_view') displayScheduleForWeek(data.year, data.month, data.weekNum);
            else if(mode==='past_weeks') displayPastWeeks();
            else if(mode==='past_months') displayPastMonths(data.year);
            else if(mode==='past_years') displayPastYears();
            else if(mode==='weeks_of_month') displayWeeksForMonth(data.year, data.month);
        }

        function navigateToView(m, d={}) {
            if(currentView.mode!==m || JSON.stringify(currentView.data)!==JSON.stringify(d)) { viewHistory.push(currentView); forwardHistory=[]; }
            currentView={mode:m, data:d}; renderContent();
        }
        function goBackView() { if(viewHistory.length>0) { forwardHistory.push(currentView); currentView=viewHistory.pop(); renderContent(); } else history.back(); }
        function goForwardView() { if(forwardHistory.length>0) { viewHistory.push(currentView); currentView=forwardHistory.pop(); renderContent(); } }

        function handleTableInputChange(e) {
            if(!isEditAllowed()) return alert('권한 없음');
            const row = e.target.closest('tr');
            if(!row || !row.dataset.scheduleId) return;
            const body = {
                manager: row.querySelector('[data-field="manager"]').value,
                company: row.querySelector('[data-field="company"]').value,
                model: row.querySelector('[data-field="model"]').value,
                orderMonth: row.querySelector('[data-field="orderMonth"]').value,
                tb: row.querySelector('[data-field="tb"]').value,
                lot: row.querySelector('[data-field="lot"]').value,
                actualProd: row.querySelector('[data-field="actualProd"]').value,
                prodStart: row.querySelector('[data-field="prodStart"]').value,
                prodEnd: row.querySelector('[data-field="prodEnd"]').value
            };
            if(e.target.dataset.field==='lot'||e.target.dataset.field==='actualProd') updateLineProgress(row.dataset.line);
            fetch(`http://127.0.0.1:5000/api/production/schedules/${row.dataset.scheduleId}`, {
                method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
            });
        }

        function displayCurrentWeekSchedule() {
            const d = new Date();
            const y=d.getFullYear(), m=d.getMonth()+1, w=getCurrentWeekNumber(d);
            currentView = {mode:'current_week', data:{year:y, month:m, weekNum:w}};
            displayScheduleForWeek(y, m, w);
        }

        async function displayScheduleForWeek(y, m, w) {
            currentView = {mode:'schedule_view', data:{year:y, month:m, weekNum:w}};
            weekDisplay.innerHTML = `<i class="uil uil-calendar-alt"></i> ${y}년 ${m}월 ${w}주차`;
            await loadMasterData();
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${y}&month=${m}&weekNum=${w}`);
                const data = await res.json();
                displayArea.innerHTML = createScheduleTableHTML(data);
                if(data.length>0) populateDateSelectorsForProductionPage({year:y, month:m, weekNum:w}, data);
                ['A','B','C'].forEach(l=>updateLineProgress(l));
            } catch(e) { displayArea.innerHTML = '<p class="no-line-data-message">데이터 로딩 실패</p>'; }
        }

        function updateLineProgress(line) {
            const sec = document.querySelector(`.line-schedule-section[data-line="${line}"]`);
            if(!sec) return;
            let tLot=0, tAct=0;
            sec.querySelectorAll('tbody tr').forEach(r=>{
                tLot += parseInt(r.querySelector('input[data-field="lot"]').value)||0;
                tAct += parseInt(r.querySelector('input[data-field="actualProd"]').value)||0;
            });
            const pct = tLot>0 ? Math.min((tAct/tLot)*100, 100) : 0;
            const bar = document.getElementById(`progress-bar-${line}`);
            const txt = document.getElementById(`progress-text-${line}`);
            if(bar) bar.style.width=`${pct}%`;
            if(txt) txt.textContent=`${Math.round(pct)}%`;
        }

        function displayPastWeeks() {
            const d = new Date(), w = getCurrentWeekNumber(d);
            let h = `<div class="period-selector-grid">`;
            for(let i=1; i<=w; i++) h+=`<div class="period-btn clickable-box" data-view="schedule_view" data-year="${d.getFullYear()}" data-month="${d.getMonth()+1}" data-week="${i}">${d.getMonth()+1}월 ${i}주차</div>`;
            displayArea.innerHTML = h + `</div>`;
        }
        function displayPastMonths(y) {
            const d = new Date(), max = (y===d.getFullYear()) ? d.getMonth() : 11;
            let h = `<div class="period-selector-grid">`;
            for(let i=0; i<=max; i++) h+=`<div class="period-btn clickable-box" data-view="weeks_of_month" data-year="${y}" data-month="${i+1}">${i+1}월</div>`;
            displayArea.innerHTML = h + `</div>`;
        }
        function displayPastYears() {
            let h = `<div class="period-selector-grid">`;
            for(let i=0; i<3; i++) { const y = new Date().getFullYear()-i; h+=`<div class="period-btn clickable-box" data-view="past_months" data-year="${y}">${y}년</div>`; }
            displayArea.innerHTML = h + `</div>`;
        }
        function displayWeeksForMonth(y, m) {
            const w = Array.from(getProductionWeeksInMonth(y, m-1)).sort((a,b)=>a-b);
            let h = `<div class="period-selector-grid">`;
            w.forEach(k => h+=`<div class="period-btn clickable-box" data-view="schedule_view" data-year="${y}" data-month="${m}" data-week="${k}">${m}월 ${k}주차</div>`);
            displayArea.innerHTML = h + `</div>`;
        }

        async function openNotesModal() {
            const {year, month, weekNum} = currentView.data;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${year}&month=${month}&weekNum=${weekNum}`);
                const data = await res.json();
                const byLine = {A:[], B:[], C:[]};
                data.forEach(s=>{ if(byLine[s.line]) byLine[s.line].push(s); });
                
                ['A', 'B', 'C'].forEach(line => {
                    const el = document.getElementById(`notes-content-${line}`);
                    if(byLine[line].length > 0) {
                        el.innerHTML = byLine[line].map(s => `
                            <div class="note-item">
                                <h4>${s.company||'-'} / ${s.model||'-'} (LOT:${s.lot})</h4>
                                <textarea data-note-id="${s.id}" placeholder="비고 입력...">${s.notes||''}</textarea>
                            </div>
                        `).join('');
                    } else el.innerHTML = '<p style="color:#666; text-align:center; margin-top:20px;">일정이 없습니다.</p>';
                });
                notesModal.classList.add('visible');
            } catch (e) { alert('오류 발생'); }
        }
        async function handleNoteSave(e) {
            if(!isEditAllowed()) return alert('권한 없음');
            if(e.target.tagName!=='TEXTAREA') return;
            const id = e.target.dataset.noteId;
            const notes = e.target.value;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules/${id}/notes`, {
                    method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({notes})
                });
                if(res.ok) console.log('Note Saved');
            } catch(e) { console.error(e); }
        }

        function createScheduleTableHTML(schedules) {
            const byLine = {A:[], B:[], C:[]};
            schedules.forEach(s=>{ if(byLine[s.line]) byLine[s.line].push(s); });
            const ro = isEditAllowed()?'':'disabled';
            let html='';
            for(const line in byLine) {
                let header = `
                    <div class="line-header" style="border-bottom:none;">
                        <div class="line-title">
                            <span>${line} LINE</span>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progress-bar-${line}"></div><span class="progress-bar-text" id="progress-text-${line}">0%</span></div>
                        </div>
                        ${line==='A'?`<div style="display:flex; gap:5px;"><button id="open-notes-modal-btn" class="icon-btn" title="메모"><i class="uil uil-notes"></i></button><button id="open-export-modal-btn" class="icon-btn" title="다운로드"><i class="uil uil-import"></i></button></div>`:''}
                    </div>`;
                html+=`<section class="line-schedule-section" data-line="${line}">${header}`;
                if(byLine[line].length>0) {
                    const rows = byLine[line].map(s => {
                        const mOpts = managerList.map(m=>`<option value="${m.name}" ${s.manager===m.name?'selected':''}>${m.name}</option>`).join('');
                        const cOpts = companyList.map(c=>`<option value="${c.name}" ${s.company===c.name?'selected':''}>${c.name}</option>`).join('');
                        let moOpts = ''; for(let i=1;i<=12;i++) moOpts+=`<option value="${i}월분" ${(s.orderMonth||'').trim()===`${i}월분`?'selected':''}>${i}월분</option>`;
                        return `<tr data-schedule-id="${s.id}" data-line="${line}">
                            <td><select class="form-select" data-field="manager" ${ro}><option value="">-</option>${mOpts}</select></td>
                            <td><select class="form-select" data-field="company" ${ro}><option value="">-</option>${cOpts}</select></td>
                            <td><input type="text" class="form-input" data-field="model" value="${s.model||''}" ${ro}></td>
                            <td><select class="form-select" data-field="orderMonth" ${ro}><option value="">-</option>${moOpts}</select></td>
                            <td><select class="form-select" data-field="tb" ${ro}><option value="Top" ${s.tb==='Top'?'selected':''}>Top</option><option value="Bot" ${s.tb==='Bot'?'selected':''}>Bot</option><option value="T/O" ${s.tb==='T/O'?'selected':''}>T/O</option><option value="B/O" ${s.tb==='B/O'?'selected':''}>B/O</option></select></td>
                            <td><input type="text" class="form-input" data-field="lot" value="${s.lot||''}" ${ro}></td>
                            <td><input type="text" class="form-input" data-field="actualProd" value="${s.actualProd||''}" ${ro}></td>
                            <td><select class="form-select prod-start-date" data-field="prodStart" ${ro}></select></td>
                            <td><select class="form-select prod-end-date" data-field="prodEnd" ${ro}></select></td>
                            <td style="color:var(--point-gold);">${s.startDate}~${s.endDate}</td>
                        </tr>`;
                    }).join('');
                    html+=`<div class="table-container"><table class="editable-table">
                        <colgroup><col style="width:6%"><col style="width:6%"><col><col style="width:6%"><col style="width:6%"><col style="width:8%"><col style="width:6%"><col style="width:8%"><col style="width:8%"><col style="width:20%"></colgroup>
                        <thead><tr><th>담당</th><th>업체</th><th>모델명</th><th>주문월</th><th>T/B</th><th>LOT</th><th>실생산</th><th>시작</th><th>종료</th><th>예정일</th></tr></thead>
                        <tbody>${rows}</tbody></table></div>`;
                } else html+=`<p class="no-line-data-message">일정 없음</p>`;
                html+=`</section>`;
            }
            return html;
        }

        function populateDateSelectorsForProductionPage(info, scheds) {
            const days = getWeekdaysForWeek(info.year, info.month-1, info.weekNum);
            const dNames = ['일','월','화','수','목','금','토'];
            document.querySelectorAll('.prod-start-date, .prod-end-date').forEach(s => {
                const row = s.closest('tr'); if(!row) return;
                const id = parseInt(row.dataset.scheduleId);
                const sc = scheds.find(i=>i.id===id);
                const val = s.classList.contains('prod-start-date') ? sc.actualStartDate : sc.actualEndDate;
                s.innerHTML = '<option value="-">-</option>';
                days.forEach(d => {
                    const txt = `${d.month}/${d.day}(${dNames[d.dayOfWeek]})`;
                    s.add(new Option(txt, txt, false, txt===val));
                });
            });
        }

        async function generateProductionPdf(reportType) {
            if (typeof addPaperlogyFont !== 'function') { alert("폰트 로드 오류"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const isPlan = reportType === 'plan';
            
            let year, month, weekNum;
            if (!currentView.data || !currentView.data.year) {
                const d = new Date(); year=d.getFullYear(); month=d.getMonth()+1; weekNum=getCurrentWeekNumber(d);
            } else { year=currentView.data.year; month=currentView.data.month; weekNum=currentView.data.weekNum; }

            let dbData;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/schedules?year=${year}&month=${month}&weekNum=${weekNum}`);
                if (!res.ok) throw new Error();
                dbData = await res.json();
            } catch (e) { alert("데이터 오류"); return; }

            if (!dbData || dbData.length === 0) { alert("데이터 없음"); return; }

            addPaperlogyFont(doc);
            doc.setFont('Paperlogy', 'normal');
            const title = isPlan ? `${year}년 ${month}월 ${weekNum}주차 생산계획서` : `${year}년 ${month}월 ${weekNum}주차 생산보고서`;
            const head = isPlan ? [['업체', '모델명', '주문월', 'T/B', 'LOT', '월', '화', '수', '목', '금']] : [['담당자', '업체', '모델명', '주문월', 'T/B', 'LOT', '실생산', '월', '화', '수', '목', '금']];
            
            doc.setFontSize(20); doc.text(title, 14, 15);
            const dayColW = 8;
            const colStyles = isPlan ? { 0:{cellWidth:25}, 1:{cellWidth:'auto'}, 2:{cellWidth:13}, 3:{cellWidth:17}, 4:{cellWidth:20}, 5:{cellWidth:dayColW}, 6:{cellWidth:dayColW}, 7:{cellWidth:dayColW}, 8:{cellWidth:dayColW}, 9:{cellWidth:dayColW} } : { 0:{cellWidth:20}, 1:{cellWidth:17}, 2:{cellWidth:'auto'}, 3:{cellWidth:13}, 4:{cellWidth:17}, 5:{cellWidth:20}, 6:{cellWidth:13}, 7:{cellWidth:dayColW}, 8:{cellWidth:dayColW}, 9:{cellWidth:dayColW}, 10:{cellWidth:dayColW}, 11:{cellWidth:dayColW} };
            
            const byLine = { A:[], B:[], C:[] };
            dbData.forEach(i => { if(byLine[i.line]) byLine[i.line].push(i); });
            const daysOrder = ['월','화','수','목','금'];
            let lastY = 25;

            ['A','B','C'].forEach(line => {
                if(byLine[line].length > 0) {
                    if(lastY > 250) { doc.addPage(); lastY=20; }
                    doc.setFontSize(14); doc.setFont('Paperlogy', 'normal'); doc.text(`${line}라인`, 14, lastY+10);
                    
                    const body = byLine[line].map(item => {
                        const getDay = (s) => (s && s.match(/\(([^)]+)\)/)) ? s.match(/\(([^)]+)\)/)[1] : null;
                        const start = isPlan ? getDay(item.startDate) : getDay(item.actualStartDate);
                        const end = isPlan ? getDay(item.endDate) : getDay(item.actualEndDate);
                        const sIdx = daysOrder.indexOf(start), eIdx = daysOrder.indexOf(end);
                        const finalE = (sIdx > -1 && eIdx === -1) ? sIdx : eIdx;
                        const flags = daysOrder.map((d, i) => (sIdx > -1 && finalE > -1 && sIdx <= finalE && i >= sIdx && i <= finalE) ? 1 : 0);

                        if(isPlan) return [item.company, item.model, item.orderMonth||'', item.tb||'Top', item.lot, ...flags];
                        else return [item.manager||'', item.company, item.model, item.orderMonth||'', item.tb||'Top', item.lot, item.actualProd||'', ...flags];
                    });

                    doc.autoTable({
                        head: head, body: body, startY: lastY+15, theme: 'grid',
                        styles: { font:'Paperlogy', fontStyle:'normal', fontSize:9, lineWidth:0.1, lineColor:[150,150,150], halign:'center' },
                        headStyles: { fontStyle:'normal', fillColor:[200,200,200], textColor:0 },
                        columnStyles: colStyles,
                        didDrawCell: function(data) {
                            const startCol = isPlan ? 5 : 7;
                            if(data.column.index >= startCol && data.cell.section === 'body') {
                                if(data.cell.raw === 1) doc.setFillColor(255, 255, 0); else doc.setFillColor(255, 255, 255);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'FD'); data.cell.text = [''];
                            }
                        }
                    });
                    lastY = doc.autoTable.previous.finalY;
                }
            });
            doc.save(`${year}년-${month}월-${weekNum}주차_${isPlan?'생산계획서':'생산보고서'}.pdf`);
        }

        function getWeekdaysForWeek(y, m, w) {
            const d = new Date(y, m, 1); d.setDate(d.getDate() - d.getDay() + (w - 1) * 7);
            const res = [];
            for(let i=0; i<7; i++) { const cur = new Date(d); cur.setDate(d.getDate()+i); if(cur.getDay()>=1 && cur.getDay()<=5) res.push({ month: cur.getMonth()+1, day: cur.getDate(), dayOfWeek: cur.getDay() }); }
            return res;
        }
        function getProductionWeeksInMonth(y, m) {
            const s = new Set(); const last = new Date(y, m+1, 0).getDate();
            for(let i=1; i<=last; i++) { const d = new Date(y, m, i); if(d.getDay()>=1 && d.getDay()<=5) s.add(Math.ceil((i + new Date(y, m, 1).getDay()) / 7)); }
            return s;
        }
        function getCurrentWeekNumber(d) { return Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7); }
        function updateTime() {
            const d = new Date(); document.getElementById('current-time').textContent = `${d.getFullYear()}년 ${(d.getMonth()+1).toString().padStart(2,'0')}월 ${d.getDate().toString().padStart(2,'0')}일 ${d.getHours().toString().padStart(2,'0')}시 ${d.getMinutes().toString().padStart(2,'0')}분`;
        }
    </script>
</body>
</html>
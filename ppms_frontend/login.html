<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 로그인</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="login.css">
</head>

<body>

    <div class="section">
        <div class="container">
            <div class="row full-height justify-content-center">
                <div class="col-12 text-center align-self-center py-5">

                    <div class="main-ui-wrapper">

                        <h3 class="ui-title">PPMS Log-In</h3>

                        <h6 class="mb-0 pb-3">
                            <span>일반</span>
                            <span>관리</span>
                        </h6>

                        <input class="checkbox" type="checkbox" id="reg-log" name="reg-log" />
                        <label for="reg-log"></label>

                    </div>
                    <div class="card-3d-wrap mx-auto">
                        <div class="card-3d-wrapper">

                            <div class="card-front">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">일반 로그인</h4>
                                        <div class="form-group">
                                            <input type="password" class="form-style" placeholder="비밀번호"
                                                id="user-password" autocomplete="current-password">
                                            <i class="input-icon uil uil-lock-alt"></i>
                                        </div>
                                        <a href="#" class="btn mt-4" id="btn-user-login">SUBMIT</a>
                                    </div>
                                </div>
                            </div>

                            <div class="card-back">
                                <div class="center-wrap">
                                    <div class="section text-center">
                                        <h4 class="mb-4 pb-3">관리자 로그인</h4>
                                        <div class="form-group">
                                            <input type="password" class="form-style" placeholder="관리자 비밀번호"
                                                id="admin-password" autocomplete="current-password">
                                            <i class="input-icon uil uil-lock-alt"></i>
                                        </div>
                                        <a href="#" class="btn mt-4" id="btn-admin-login">SUBMIT</a>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <p class="mb-0 mt-4 text-center" id="login-status"
                        style="color: #ffeba7; font-weight: 500; min-height: 24px;"></p>

                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userBtn = document.getElementById('btn-user-login');
            const adminBtn = document.getElementById('btn-admin-login');
            const userPassInput = document.getElementById('user-password');
            const adminPassInput = document.getElementById('admin-password');
            const loginStatus = document.getElementById('login-status');
            const checkbox = document.getElementById('reg-log');

            // [수정] 카드를 회전시키기 위해 요소를 선택합니다.
            const cardWrapper = document.querySelector('.card-3d-wrapper');

            // 초기 포커스
            userPassInput.focus();

            // [수정] 체크박스 변경 시 동작 (카드 뒤집기 + 포커스 이동)
            checkbox.addEventListener('change', () => {
                loginStatus.textContent = ''; // 메시지 초기화

                if (checkbox.checked) {
                    // 1. 관리자 모드 (체크됨) -> 카드 180도 회전
                    cardWrapper.style.transform = 'rotateY(180deg)';

                    // 2. 입력창 포커스
                    setTimeout(() => adminPassInput.focus(), 300);
                } else {
                    // 1. 일반 모드 (체크 해제) -> 카드 원위치 (0도)
                    cardWrapper.style.transform = 'rotateY(0deg)';

                    // 2. 입력창 포커스
                    setTimeout(() => userPassInput.focus(), 300);
                }
            });

            // 로그인 함수 (기존 동일)
            async function performLogin(role, password) {
                if (!password) {
                    loginStatus.textContent = '비밀번호를 입력하세요.';
                    return;
                }
                loginStatus.textContent = '로그인 중...';

                try {
                    const response = await fetch('http://127.0.0.1:5000/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: role,
                            password: password
                        }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('ppms_user_role', data.role || 'user');
                        // 1. body에 fade-out 클래스를 추가하여 투명하게 만듦
                        document.body.classList.add('fade-out');

                        // 2. CSS transition 시간(0.5초)만큼 기다렸다가 페이지 이동
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 500); // 500ms = 0.5초
                    } else {
                        loginStatus.textContent = data.message || '로그인 실패';
                    }
                } catch (error) {
                    console.error('로그인 오류:', error);
                    loginStatus.textContent = '서버 연결 오류';
                }
            }

            userBtn.addEventListener('click', (e) => { e.preventDefault(); performLogin('user', userPassInput.value); });
            adminBtn.addEventListener('click', (e) => { e.preventDefault(); performLogin('admin', adminPassInput.value); });
            userPassInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') userBtn.click(); });
            adminPassInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') adminBtn.click(); });
        });
    </script>
</body>

</html>
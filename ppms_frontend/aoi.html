<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - AOI 검사 기록</title>

    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="aoi.css">

    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="auth.js"></script>
    <script src="logo.js"></script>
    <script src="calendar_day.js"></script>
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="header-logo-wrapper btn-glitch">
                    <div class="ppms-logo-placeholder"></div>
                </a>
            </div>
            <div class="header-center">
                <div class="common-box font-35pt">AOI 검사 기록</div>
            </div>
            <div class="header-right">
                <div class="common-box font-15pt time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div class="line-schedule-section">

                <div class="aoi-header">
                    <div class="aoi-title" id="main-table-title">검사 현황</div>

                    <div class="header-command-bar">
                        <i class="uil uil-keyboard cmd-icon"></i>
                        <input type="text" id="command-input" placeholder="명령어 입력 (예: 미삽 1)" autocomplete="off">
                    </div>

                    <div class="header-btn-group">
                        <button id="pin-mode-btn" class="header-btn" title="모델 고정 모드">
                            <i class="uil uil-map-pin-alt"></i> <span>고정</span>
                        </button>

                        <button id="toggle-view-btn" class="header-btn">
                            <i class="uil uil-eye"></i> <span>자세히 보기</span>
                        </button>

                        <button id="manage-btn" class="header-btn">
                            <i class="uil uil-cog"></i> <span>관리</span>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="aoi-table" id="aoi-table-main">
                        <colgroup>
                            <col style="width: 200px;">

                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-basic">
                            <col style="width: clamp(70px, 6vw, 120px);">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-basic">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-basic good-col">
                            <col style="width: clamp(70px, 6vw, 120px);">
                            <col style="width: clamp(70px, 6vw, 120px);" class="group-sum-col">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-a">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-a">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-a">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-a">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-a">

                            <col style="width: clamp(70px, 6vw, 120px);" class="group-sum-col">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-b">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-b">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-b">

                            <col style="width: clamp(70px, 6vw, 120px);" class="group-sum-col">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-c">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-c">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-c">

                            <col style="width: clamp(70px, 6vw, 120px);" class="group-sum-col">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-d">
                            <col style="width: clamp(70px, 6vw, 120px);" class="detail-col group-d">
                        </colgroup>
                        <thead>
                            <tr>
                                <th rowspan="2" class="model-name-ellipsis group-toggle-header"
                                    onclick="toggleGroup('basic')" style="text-align:center;">
                                    모델명 <i class="uil uil-angle-right"></i>
                                </th>
                                <th rowspan="2" class="detail-col group-basic">Point</th>

                                <th rowspan="2">수량</th>

                                <th rowspan="2" class="detail-col group-basic">진행도</th>
                                <th rowspan="2" class="detail-col group-basic good-col">양품</th>

                                <th rowspan="2" class="defect-total-col">총불량</th>

                                <th class="sum-header">실장오류</th>
                                <th colspan="5" class="detail-col group-a group-header-box">실장오류</th>

                                <th class="sum-header">부품결함</th>
                                <th colspan="3" class="detail-col group-b group-header-box">부품결함</th>

                                <th class="sum-header">납땜불량</th>
                                <th colspan="3" class="detail-col group-c group-header-box">납땜불량</th>

                                <th class="sum-header">기타</th>
                                <th colspan="2" class="detail-col group-d group-header-box">기타</th>
                            </tr>
                            <tr>
                                <th class="group-sum-col"></th>

                                <th class="detail-col group-a group-start">미삽</th>
                                <th class="detail-col group-a">오삽</th>
                                <th class="detail-col group-a">역삽</th>
                                <th class="detail-col group-a">틀어짐</th>
                                <th class="detail-col group-a group-end">뒤집힘</th>

                                <th class="group-sum-col"></th>
                                <th class="detail-col group-b group-start">파손</th>
                                <th class="detail-col group-b">맨하탄</th>
                                <th class="detail-col group-b group-end">이탈</th>

                                <th class="group-sum-col"></th>
                                <th class="detail-col group-c group-start">냉납</th>
                                <th class="detail-col group-c">미납</th>
                                <th class="detail-col group-c group-end">쇼트</th>

                                <th class="group-sum-col"></th>
                                <th class="detail-col group-d group-start">원자재</th>
                                <th class="detail-col group-d group-end">DIP</th>
                            </tr>
                        </thead>
                        <tbody id="aoi-list-body"></tbody>
                    </table>
                </div>

                <div id="no-record-msg"
                    style="display:none; flex:1; flex-direction:column; align-items:center; justify-content:center; color:#666; font-size:1.1rem; min-height:300px;">
                    <i class="uil uil-file-slash" style="font-size:3rem; margin-bottom:15px; color:#444;"></i>
                    <span>등록된 기록이 없습니다.</span>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-left">
                <div class="common-box clickable-box aoi-add-btn" id="add-model-btn"
                    style="background-color:var(--accent-blue);">
                    <i class="uil uil-plus-circle"></i> 모델추가
                </div>
            </div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right">
                <div class="footer-btn" id="date-picker-btn" style="position: relative;">
                    <i class="uil uil-calendar-alt"></i> 날짜 선택
                </div>
            </div>
        </footer>
    </div>

    <div id="toast-container"></div>

    <div class="modal-overlay model-list-modal">
        <div class="modal-window">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); width: 100%; box-sizing: border-box;">

                <h3
                    style="margin:0; color:var(--point-gold); display:flex; align-items:center; gap:10px; font-size: 1.3rem; white-space: nowrap;">
                    <i class="uil uil-list-ul"></i> 생산 완료 모델 선택
                </h3>

                <div style="display:flex; align-items:center; gap:20px;">
                    <div class="date-range-wrapper" style="display: flex; align-items: center; gap: 5px;">
                        <select id="start-year" class="period-select year-select"></select>
                        <select id="start-month" class="period-select month-select"></select>
                        <span class="range-separator">~</span>
                        <select id="end-year" class="period-select year-select"></select>
                        <select id="end-month" class="period-select month-select"></select>
                        <button id="refresh-model-list-btn" class="refresh-btn" title="새로고침">
                            <i class="uil uil-sync"></i>
                        </button>
                    </div>
                    <button class="close-modal-btn"
                        style="background:none; border:none; color:#bbb; font-size:1.8rem; cursor:pointer; line-height: 1; padding: 0; transition: color 0.2s;">
                        <i class="uil uil-multiply"></i>
                    </button>
                </div>
            </div>

            <div class="modal-content"
                style="padding:20px; max-height:80vh; overflow-y:auto; width: 100%; box-sizing: border-box;">
                <div class="model-list-container"></div>
            </div>
        </div>
    </div>

    <div id="global-tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ----------------------------------------------------------------
            // [초기 설정]
            // ----------------------------------------------------------------
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) { /* window.location.href = 'login.html'; */ }
            setTimeout(() => { document.body.style.opacity = '1'; }, 50);

            if (typeof setupLogoutButton === 'function') setupLogoutButton();
            if (typeof PPMS_LOGO !== 'undefined' && PPMS_LOGO.init) PPMS_LOGO.init();

            // 날짜 선택기
            if (typeof setupDatePicker === 'function') {
                setupDatePicker('date-picker-btn', (dateStr) => { loadRecordsByDate(dateStr); });
            }

            // 네비게이션
            const backBtn = document.getElementById('back-btn');
            const homeBtn = document.getElementById('home-btn');
            const forwardBtn = document.getElementById('forward-btn');
            if (backBtn) backBtn.addEventListener('click', () => history.back());
            if (homeBtn) homeBtn.addEventListener('click', () => window.location.href = 'index.html');
            if (forwardBtn) forwardBtn.addEventListener('click', () => history.forward());

            // 전역 변수
            let pinnedRowId = null;
            let isPinMode = false;
            let isDeleteMode = false;
            let isDetailMode = false;
            const expandedGroups = new Set();
            let currentSelectedDate = new Date().toISOString().split('T')[0];

            // DOM 요소
            const commandInput = document.getElementById('command-input');
            const table = document.querySelector('.aoi-table');
            const pinModeBtn = document.getElementById('pin-mode-btn');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const manageBtn = document.getElementById('manage-btn');

            // ----------------------------------------------------------------
            // [1] 데이터 로드
            // ----------------------------------------------------------------
            async function loadRecordsByDate(dateStr) {
                currentSelectedDate = dateStr;

                const titleEl = document.getElementById('main-table-title');
                const shortDate = dateStr.slice(2);
                titleEl.textContent = `${shortDate} 검사기록`;

                const tbody = document.getElementById('aoi-list-body');
                const tableContainer = document.querySelector('.table-container');
                const noRecordMsg = document.getElementById('no-record-msg');

                if (tableContainer) tableContainer.style.display = 'block';
                if (noRecordMsg) noRecordMsg.style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="30" style="padding:30px; text-align:center;">데이터 조회 중...</td></tr>';

                try {
                    const res = await fetch(`http://127.0.0.1:5000/api/aoi/records?date=${dateStr}`);
                    const records = await res.json();
                    renderTableRows(records);
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="30" style="padding:30px; text-align:center; color:var(--danger-red);">로드 실패</td></tr>';
                    console.error(e);
                }
            }

            // ----------------------------------------------------------------
            // [2] 진행도 UI 업데이트
            // ----------------------------------------------------------------
            function updateProgressUI(upperRow, newTodayQty) {
                if (!upperRow) return;

                const lotQty = parseInt(upperRow.dataset.lot) || 0;
                const baseCumulative = parseInt(upperRow.dataset.baseCumulative) || 0;
                const newTotal = baseCumulative + newTodayQty;

                let percent = 0;
                if (lotQty > 0) percent = (newTotal / lotQty) * 100;
                if (percent > 100) percent = 100;

                const isCompleted = lotQty > 0 && newTotal >= lotQty;

                const barEl = upperRow.querySelector('.qty-progress-fill');
                if (barEl) {
                    barEl.style.width = `${percent}%`;
                    if (isCompleted) barEl.classList.add('completed');
                    else barEl.classList.remove('completed');
                }

                const accTextEl = upperRow.querySelector('.acc-val');
                if (accTextEl) accTextEl.textContent = newTotal;

                const textContainer = upperRow.querySelector('.qty-info-text');
                if (textContainer) {
                    if (isCompleted) textContainer.classList.add('completed');
                    else textContainer.classList.remove('completed');
                }
            }

            document.getElementById('aoi-list-body').addEventListener('input', (e) => {
                if (e.target.classList.contains('qty-input-visible')) {
                    const val = parseInt(e.target.value) || 0;
                    const upperRow = e.target.closest('tr.upper-row');
                    updateProgressUI(upperRow, val);
                }
            });

            // ----------------------------------------------------------------
            // [3] DB 업데이트
            // ----------------------------------------------------------------
            window.updateRecord = async function (id, field, value) {
                if (isDeleteMode) return;

                let inputVal = 0;
                if (field !== 'inspection_point' && !field.endsWith('_ref')) {
                    inputVal = parseInt(value) || 0;
                } else {
                    inputVal = value;
                }

                const upperRow = document.querySelector(`tr.upper-row[data-id="${id}"]`);
                const lowerRow = document.querySelector(`tr.lower-row[data-id="${id}"]`);

                if (field === 'inspection_qty' && upperRow) {
                    updateProgressUI(upperRow, inputVal);
                }

                try {
                    const payload = {}; payload[field] = inputVal;
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/records/${id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const res = await response.json();

                    if (res.success && upperRow) {
                        const updated = res.updated_record;
                        const totalDefectWrapper = upperRow.querySelector('.defect-total-col .row-span-wrapper');
                        const goodQtyWrapper = upperRow.querySelector('.good-col .row-span-wrapper');

                        if (totalDefectWrapper) totalDefectWrapper.textContent = updated.total_defect;
                        if (goodQtyWrapper) {
                            goodQtyWrapper.textContent = updated.good_qty;
                            goodQtyWrapper.style.color = updated.good_qty < 0 ? 'var(--danger-red)' : 'var(--success-green)';
                        }
                        updateGroupSums(upperRow, lowerRow);
                    }
                } catch (e) { console.error(e); showToast('저장 실패', 'error'); }
            };

            function updateGroupSums(upperRow, lowerRow) {
                if (!upperRow || !lowerRow) return;
                const getVal = (cls) => {
                    const input = lowerRow.querySelector(`input[onchange*="'${cls}'"]`) ||
                        upperRow.querySelector(`input[onchange*="'${cls}'"]`);
                    return input ? (parseInt(input.value) || 0) : 0;
                };
                const sumA = getVal('missing') + getVal('wrong') + getVal('reverse') + getVal('skewed') + getVal('flipped');
                const sumB = getVal('damaged') + getVal('manhattan') + getVal('detached');
                const sumC = getVal('cold') + getVal('unsoldered') + getVal('short');
                const sumD = getVal('material') + getVal('dip');

                const sumWrappers = upperRow.querySelectorAll('.group-sum-cell .row-span-wrapper');
                if (sumWrappers.length >= 4) {
                    sumWrappers[0].textContent = sumA;
                    sumWrappers[1].textContent = sumB;
                    sumWrappers[2].textContent = sumC;
                    sumWrappers[3].textContent = sumD;
                }
            }

            // ----------------------------------------------------------------
            // [4] 스마트 간편 입력 (Smart Parsing & Merge)
            // ----------------------------------------------------------------

            // 불량 유형 매핑 (사용자 테이블의 필드명과 일치해야 함)
            const CMD_MAP = {
                '포인트': 'inspection_point', '포': 'inspection_point', 'ㅍ': 'inspection_point', 'point': 'inspection_point',
                '수량': 'inspection_qty', '수': 'inspection_qty', 'ㅅㄹ': 'inspection_qty', 'qty': 'inspection_qty',
                '미삽': 'missing', 'ㅁㅅ': 'missing',
                '오삽': 'wrong', 'ㅇㅅ': 'wrong',
                '역삽': 'reverse', 'ㅇㅇ': 'reverse', '역': 'reverse',
                '틀어짐': 'skewed', 'ㅌㅇ': 'skewed',
                '뒤집힘': 'flipped', 'ㄷㅈ': 'flipped', '뒤': 'flipped',
                '파손': 'damaged', 'ㅍㅅ': 'damaged',
                '맨하탄': 'manhattan', 'ㅁㅎ': 'manhattan', '맨': 'manhattan',
                '이탈': 'detached', 'ㅇㅌ': 'detached',
                '냉납': 'cold', 'ㄴㄴ': 'cold',
                '미납': 'unsoldered', 'ㅁㄴ': 'unsoldered',
                '쇼트': 'short', 'ㅅㅌ': 'short',
                '원자재': 'material', 'ㅇㅈ': 'material', '원': 'material',
                'dip': 'dip', '딮': 'dip', 'ㄷ': 'dip',
            };

            /**
             * 간편 입력 문자열 파싱 (예: "C102 미삽 1")
             */
            function parseSimpleInput(inputString) {
                const parts = inputString.trim().toUpperCase().split(/\s+/).filter(p => p);
                if (parts.length < 2) return null;

                let ref = null;
                let defectKey = null;
                let qty = 1;

                for (const part of parts) {
                    // 1. Defect Type 확인
                    let foundType = false;
                    for (const key in CMD_MAP) {
                        if (part === key.toUpperCase()) {
                            defectKey = CMD_MAP[key];
                            foundType = true;
                            break;
                        }
                    }
                    if (foundType) continue;

                    // 2. 숫자 확인 (수량)
                    const num = parseInt(part);
                    if (!isNaN(num)) {
                        qty = num;
                        continue;
                    }

                    // 3. 나머지 (레퍼런스)
                    ref = part;
                }

                if (!defectKey) return null;
                return { ref, defectKey, qty };
            }

            /**
             * 레퍼런스 문자열 지능형 병합
             */
            function mergeReference(currentRefString, newRefName, addedQty) {
                if (!newRefName) return currentRefString; // 레퍼런스 없으면 유지

                const refMap = new Map();
                const refParts = currentRefString.split(',').map(s => s.trim()).filter(s => s);
                const refRegex = /^([A-Z0-9-]+)\s*(\d+)\s*EA$/i;
                const upperNewRefName = newRefName.toUpperCase();

                // 기존 파싱
                for (const part of refParts) {
                    const match = part.match(refRegex);
                    if (match) {
                        refMap.set(match[1].toUpperCase(), parseInt(match[2]));
                    } else {
                        refMap.set(part, -1); // 포맷 안 맞는 건 -1로 표시
                    }
                }

                // 병합 또는 추가
                if (refMap.has(upperNewRefName)) {
                    const currentQty = refMap.get(upperNewRefName);
                    if (currentQty !== -1) {
                        refMap.set(upperNewRefName, currentQty + addedQty);
                    }
                } else {
                    refMap.set(upperNewRefName, addedQty);
                }

                // 문자열 재조립
                const newRefParts = [];
                refMap.forEach((q, name) => {
                    if (q === -1) newRefParts.push(name);
                    else newRefParts.push(`${name} ${q}EA`);
                });

                return newRefParts.join(', ');
            }

            function triggerChange(el) {
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }

            // 간편 입력 이벤트 리스너
            if (commandInput) {
                commandInput.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!pinnedRowId) { showToast('고정된 모델이 없습니다.', 'error'); return; }

                        const text = commandInput.value.trim();
                        if (!text) return;

                        const parsed = parseSimpleInput(text);

                        // 1. 일반 숫자 입력 모드 (예: "미삽 1") - 기존 로직 유지
                        if (!parsed || !parsed.ref) {
                            const parts = text.split(' ');
                            if (parts.length < 2) { showToast('형식 오류 (예: 미삽 1)', 'error'); return; }

                            const typeKey = parts[0];
                            const inputVal = parseInt(parts[1]);
                            const dbField = CMD_MAP[typeKey];

                            if (!dbField) { showToast(`알 수 없는 명령어: ${typeKey}`, 'error'); return; }
                            if (isNaN(inputVal)) { showToast('숫자를 입력해주세요.', 'error'); return; }

                            const upperRow = document.querySelector(`tr.upper-row[data-id="${pinnedRowId}"]`);
                            const lowerRow = document.querySelector(`tr.lower-row[data-id="${pinnedRowId}"]`);
                            if (!upperRow || !lowerRow) return;

                            let input;
                            if (dbField === 'inspection_qty' || dbField === 'inspection_point') {
                                input = upperRow.querySelector(`input[onchange*="'${dbField}'"]`);
                            } else {
                                input = lowerRow.querySelector(`input[onchange*="'${dbField}'"]`);
                            }

                            if (input) {
                                if (dbField === 'inspection_point' || dbField === 'inspection_qty') {
                                    input.value = inputVal;
                                    showToast(`${typeKey} -> ${inputVal} 변경됨`);
                                } else {
                                    const currentVal = parseInt(input.value) || 0;
                                    input.value = currentVal + inputVal;
                                    showToast(`${typeKey} +${inputVal} 처리됨`);
                                }
                                triggerChange(input);
                                if (dbField === 'inspection_qty') input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                        // 2. 스마트 레퍼런스 입력 모드 (예: "C102 미삽 1")
                        else {
                            const { ref, defectKey, qty } = parsed;

                            const upperRow = document.querySelector(`tr.upper-row[data-id="${pinnedRowId}"]`);
                            const lowerRow = document.querySelector(`tr.lower-row[data-id="${pinnedRowId}"]`);

                            if (!upperRow || !lowerRow) return;

                            // (1) Ref 입력칸 찾기 (상단 행)
                            const refInput = upperRow.querySelector(`input[onchange*="'${defectKey}_ref'"]`);
                            // (2) Qty 입력칸 찾기 (하단 행)
                            const qtyInput = lowerRow.querySelector(`input[onchange*="'${defectKey}'"]`);

                            if (refInput && qtyInput) {
                                // Ref 병합 및 업데이트
                                const newRefString = mergeReference(refInput.value, ref, qty);
                                refInput.value = newRefString;
                                triggerChange(refInput);

                                // 수량 업데이트
                                const currentQty = parseInt(qtyInput.value) || 0;
                                qtyInput.value = currentQty + qty;
                                triggerChange(qtyInput);

                                showToast(`[${ref}] ${Object.keys(CMD_MAP).find(k => CMD_MAP[k] === defectKey)} +${qty} 처리됨`);
                            } else {
                                showToast('해당 항목을 찾을 수 없습니다.', 'error');
                            }
                        }

                        commandInput.value = '';
                    }
                });
            }

            // ----------------------------------------------------------------
            // [5] 렌더링 함수
            // ----------------------------------------------------------------
            function renderTableRows(records) {
                const tbody = document.getElementById('aoi-list-body');
                const tableContainer = document.querySelector('.table-container');
                const noRecordMsg = document.getElementById('no-record-msg');

                if (!records || records.length === 0) {
                    if (tableContainer) tableContainer.style.display = 'none';
                    if (noRecordMsg) noRecordMsg.style.display = 'flex';
                    tbody.innerHTML = '';
                    return;
                }
                if (tableContainer) tableContainer.style.display = 'block';
                if (noRecordMsg) noRecordMsg.style.display = 'none';

                // 현재 펼쳐진 그룹 확인 함수
                const getVis = (group) => expandedGroups.has(group) ? 'visible' : '';

                tbody.innerHTML = records.map(r => {
                    const safe = (v) => v || 0;
                    const lotQty = r.lot || 0;
                    const todayQty = safe(r.inspection_qty);
                    const totalQty = (r.cumulative_qty !== undefined) ? r.cumulative_qty : todayQty;
                    const baseCumulative = totalQty - todayQty;
                    let percent = lotQty > 0 ? (totalQty / lotQty) * 100 : 0;
                    if (percent > 100) percent = 100;

                    const isCompleted = lotQty > 0 && totalQty >= lotQty;
                    const barClass = isCompleted ? 'qty-progress-fill completed' : 'qty-progress-fill';
                    const textClass = isCompleted ? 'qty-info-text completed' : 'qty-info-text';
                    const rowTitle = `[${r.model}] LOT: ${lotQty} / 누적: ${totalQty}`;

                    const sumA = safe(r.missing) + safe(r.wrong) + safe(r.reverse) + safe(r.skewed) + safe(r.flipped);
                    const sumB = safe(r.damaged) + safe(r.manhattan) + safe(r.detached);
                    const sumC = safe(r.cold) + safe(r.unsoldered) + safe(r.short);
                    const sumD = safe(r.material) + safe(r.dip);
                    const goodColor = r.good_qty < 0 ? 'var(--danger-red)' : 'var(--success-green)';

                    return `
            <tr class="upper-row" data-id="${r.id}" data-lot="${lotQty}" data-base-cumulative="${baseCumulative}">
                <td class="merge-top" style="cursor:pointer;">
                    <div class="row-span-wrapper model-text" data-tooltip="${rowTitle}">${r.model}</div>
                </td>
                
                <td class="detail-col group-basic ${getVis('basic')} merge-top"><div class="row-span-wrapper"><input type="number" value="${safe(r.inspection_point)}" onchange="updateRecord(${r.id}, 'inspection_point', this.value)"></div></td>
                
                <td class="merge-top"><div class="row-span-wrapper"><input type="number" class="qty-input-visible" value="${todayQty}" placeholder="0" onchange="updateRecord(${r.id}, 'inspection_qty', this.value)"></div></td>
                
                <td class="detail-col group-basic ${getVis('basic')} merge-top"><div class="row-span-wrapper" style="flex-direction:column; padding:0 5px;"><div class="progress-cell-wrapper"><div class="qty-progress-track" title="달성률: ${parseInt(percent)}%"><div class="${barClass}" style="width: ${percent}%;"></div></div><div class="${textClass}"><span class="acc-val">${totalQty}</span><span class="lot-val">/ ${lotQty}</span></div></div></div></td>
                
                <td class="detail-col group-basic ${getVis('basic')} good-col merge-top"><div class="row-span-wrapper" style="color:${goodColor}; font-weight:bold;">${safe(r.good_qty)}</div></td>
                
                <td class="defect-total-col merge-top"><div class="row-span-wrapper" style="color:var(--danger-red); font-weight:bold;">${safe(r.total_defect)}</div></td>

                <td class="group-sum-cell merge-top"><div class="row-span-wrapper">${sumA}</div></td>
                <td class="detail-col group-a ${getVis('a')} ref-cell group-start"><input type="text" class="defect-ref-input" value="${r.missing_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'missing_ref', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} ref-cell"><input type="text" class="defect-ref-input" value="${r.wrong_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'wrong_ref', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} ref-cell"><input type="text" class="defect-ref-input" value="${r.reverse_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'reverse_ref', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} ref-cell"><input type="text" class="defect-ref-input" value="${r.skewed_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'skewed_ref', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} ref-cell group-end"><input type="text" class="defect-ref-input" value="${r.flipped_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'flipped_ref', this.value)"></td>

                <td class="group-sum-cell merge-top"><div class="row-span-wrapper">${sumB}</div></td>
                <td class="detail-col group-b ${getVis('b')} ref-cell group-start"><input type="text" class="defect-ref-input" value="${r.damaged_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'damaged_ref', this.value)"></td>
                <td class="detail-col group-b ${getVis('b')} ref-cell"><input type="text" class="defect-ref-input" value="${r.manhattan_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'manhattan_ref', this.value)"></td>
                <td class="detail-col group-b ${getVis('b')} ref-cell group-end"><input type="text" class="defect-ref-input" value="${r.detached_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'detached_ref', this.value)"></td>

                <td class="group-sum-cell merge-top"><div class="row-span-wrapper">${sumC}</div></td>
                <td class="detail-col group-c ${getVis('c')} ref-cell group-start"><input type="text" class="defect-ref-input" value="${r.cold_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'cold_ref', this.value)"></td>
                <td class="detail-col group-c ${getVis('c')} ref-cell"><input type="text" class="defect-ref-input" value="${r.unsoldered_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'unsoldered_ref', this.value)"></td>
                <td class="detail-col group-c ${getVis('c')} ref-cell group-end"><input type="text" class="defect-ref-input" value="${r.short_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'short_ref', this.value)"></td>

                <td class="group-sum-cell merge-top"><div class="row-span-wrapper">${sumD}</div></td>
                <td class="detail-col group-d ${getVis('d')} ref-cell group-start"><input type="text" class="defect-ref-input" value="${r.material_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'material_ref', this.value)"></td>
                <td class="detail-col group-d ${getVis('d')} ref-cell group-end"><input type="text" class="defect-ref-input" value="${r.dip_ref || ''}" placeholder="Ref" onchange="updateRecord(${r.id}, 'dip_ref', this.value)"></td>
            </tr>

            <tr class="lower-row" data-id="${r.id}">
                <td class="merge-bottom"></td>
                
                <td class="detail-col group-basic ${getVis('basic')} merge-bottom"></td>
                <td class="merge-bottom"></td>
                <td class="detail-col group-basic ${getVis('basic')} merge-bottom"></td>
                <td class="detail-col group-basic ${getVis('basic')} good-col merge-bottom"></td>
                <td class="defect-total-col merge-bottom"></td>

                <td class="group-sum-cell merge-bottom"></td>
                <td class="detail-col group-a ${getVis('a')} qty-cell group-start"><input type="number" class="defect-qty-input" value="${safe(r.missing)}" onchange="updateRecord(${r.id}, 'missing', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} qty-cell"><input type="number" class="defect-qty-input" value="${safe(r.wrong)}" onchange="updateRecord(${r.id}, 'wrong', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} qty-cell"><input type="number" class="defect-qty-input" value="${safe(r.reverse)}" onchange="updateRecord(${r.id}, 'reverse', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} qty-cell"><input type="number" class="defect-qty-input" value="${safe(r.skewed)}" onchange="updateRecord(${r.id}, 'skewed', this.value)"></td>
                <td class="detail-col group-a ${getVis('a')} qty-cell group-end"><input type="number" class="defect-qty-input" value="${safe(r.flipped)}" onchange="updateRecord(${r.id}, 'flipped', this.value)"></td>

                <td class="group-sum-cell merge-bottom"></td>
                <td class="detail-col group-b ${getVis('b')} qty-cell group-start"><input type="number" class="defect-qty-input" value="${safe(r.damaged)}" onchange="updateRecord(${r.id}, 'damaged', this.value)"></td>
                <td class="detail-col group-b ${getVis('b')} qty-cell"><input type="number" class="defect-qty-input" value="${safe(r.manhattan)}" onchange="updateRecord(${r.id}, 'manhattan', this.value)"></td>
                <td class="detail-col group-b ${getVis('b')} qty-cell group-end"><input type="number" class="defect-qty-input" value="${safe(r.detached)}" onchange="updateRecord(${r.id}, 'detached', this.value)"></td>

                <td class="group-sum-cell merge-bottom"></td>
                <td class="detail-col group-c ${getVis('c')} qty-cell group-start"><input type="number" class="defect-qty-input" value="${safe(r.cold)}" onchange="updateRecord(${r.id}, 'cold', this.value)"></td>
                <td class="detail-col group-c ${getVis('c')} qty-cell"><input type="number" class="defect-qty-input" value="${safe(r.unsoldered)}" onchange="updateRecord(${r.id}, 'unsoldered', this.value)"></td>
                <td class="detail-col group-c ${getVis('c')} qty-cell group-end"><input type="number" class="defect-qty-input" value="${safe(r.short)}" onchange="updateRecord(${r.id}, 'short', this.value)"></td>

                <td class="group-sum-cell merge-bottom"></td>
                <td class="detail-col group-d ${getVis('d')} qty-cell group-start"><input type="number" class="defect-qty-input" value="${safe(r.material)}" onchange="updateRecord(${r.id}, 'material', this.value)"></td>
                <td class="detail-col group-d ${getVis('d')} qty-cell group-end"><input type="number" class="defect-qty-input" value="${safe(r.dip)}" onchange="updateRecord(${r.id}, 'dip', this.value)"></td>
            </tr>`;
                }).join('');

                updateViewMode();
                adjustTableScrollbar();
            }



            // ----------------------------------------------------------------
            // [6] 기타 UI 기능 (토글, 핀, 모달 등)
            // ----------------------------------------------------------------
            function adjustTableScrollbar() {
                const container = document.querySelector('.table-container');
                const thead = document.querySelector('.aoi-table thead');
                if (!container || !thead) return;
                const scrollbarWidth = container.offsetWidth - container.clientWidth;
                const lastTh = thead.querySelector('tr:first-child th:last-child');
                if (lastTh) lastTh.style.paddingRight = scrollbarWidth > 0 ? `${scrollbarWidth}px` : '0';
            }
            window.addEventListener('resize', adjustTableScrollbar);

            window.toggleGroup = function (groupName) {
                const cols = document.querySelectorAll(`.detail-col.group-${groupName}`);
                if (cols.length === 0) return;
                const isOpened = cols[0].classList.contains('visible');
                if (isOpened) {
                    expandedGroups.delete(groupName);
                    cols.forEach(col => col.classList.remove('visible'));
                } else {
                    expandedGroups.add(groupName);
                    cols.forEach(col => col.classList.add('visible'));
                }
                adjustTableScrollbar();
            };

            if (toggleViewBtn) {
                toggleViewBtn.addEventListener('click', () => {
                    isDetailMode = !isDetailMode;
                    updateViewMode();
                    adjustTableScrollbar();
                });
            }

            // ----------------------------------------------------------------
            // [6] 화면 모드 제어 (수정: 자세히 보기 시 모델명 세부열 제외, 불량 상세 그룹만 펼침)
            // ----------------------------------------------------------------
            function updateViewMode() {
                const table = document.getElementById('aoi-table-main');
                const btnIcon = toggleViewBtn.querySelector('i');
                const btnText = toggleViewBtn.querySelector('span');

                // 그룹 목록 정의
                const allGroups = ['basic', 'a', 'b', 'c', 'd'];
                // 자세히 보기 시 자동으로 펼쳐질 그룹 (모델명 세부열 'basic' 제외)
                const defectGroups = ['a', 'b', 'c', 'd'];
                const modelDetailGroup = 'basic'; // 모델명 세부열(Point, 진행도, 양품)

                // 1. [안전장치] 고정 헤더들은 무조건 rowspan="2" 유지 (밀림 방지)
                const firstRowHeaders = table.querySelectorAll('thead tr:first-child th');
                firstRowHeaders.forEach(th => {
                    if (!th.classList.contains('sum-header') && !th.classList.contains('group-header-box')) {
                        th.setAttribute('rowspan', '2');
                    }
                });

                // 2. 동적 스타일 초기화
                const allDynamicEls = table.querySelectorAll('.sum-header, .group-sum-cell, .group-sum-col, .detail-col');
                allDynamicEls.forEach(el => el.style.display = '');

                if (isDetailMode) {
                    // --- [자세히 보기 모드] ---
                    table.classList.remove('simple-view-mode');
                    toggleViewBtn.classList.add('active');
                    btnIcon.className = 'uil uil-eye-slash';
                    btnText.textContent = '간편 보기';

                    // 1. 불량 상세 그룹('a', 'b', 'c', 'd')만 강제로 펼칩니다.
                    //    'basic' (모델명 세부열)은 추가하지 않으므로 클릭해야만 열립니다.
                    defectGroups.forEach(g => expandedGroups.add(g));

                    // 2. DOM에 .visible 클래스 적용
                    //    expandedGroups에 있는 것들만 보여줌 (basic은 사용자가 열지 않았다면 숨겨짐)
                    allGroups.forEach(g => {
                        const shouldBeVisible = expandedGroups.has(g);
                        table.querySelectorAll(`.detail-col.group-${g}`).forEach(col => {
                            col.classList.toggle('visible', shouldBeVisible);
                        });
                    });

                    // 3. 대분류 합계 헤더(숨겨짐)는 rowspan 제거
                    table.querySelectorAll('.sum-header').forEach(el => el.removeAttribute('rowspan'));

                } else {
                    // --- [간편 보기 모드] ---
                    table.classList.add('simple-view-mode');
                    toggleViewBtn.classList.remove('active');
                    btnIcon.className = 'uil uil-eye';
                    btnText.textContent = '자세히 보기';

                    // 간편 보기로 돌아갈 때는 모두 닫고, DOM에서도 숨김
                    expandedGroups.clear();
                    table.querySelectorAll('.detail-col').forEach(el => el.classList.remove('visible'));

                    // 대분류 합계 헤더(보임)는 2줄 차지
                    table.querySelectorAll('.sum-header').forEach(el => el.setAttribute('rowspan', '2'));
                }

                // 토글 아이콘 상태 업데이트 (모델명 헤더만: basic 그룹)
                const header = document.querySelector(`.group-toggle-header[onclick*="toggleGroup('${modelDetailGroup}')"] i`);
                if (header) {
                    header.className = expandedGroups.has(modelDetailGroup) ? 'uil uil-angle-down' : 'uil uil-angle-right';
                }

                adjustTableScrollbar();
            }

            if (pinModeBtn) {
                pinModeBtn.addEventListener('click', () => {
                    if (isDeleteMode) return;
                    isPinMode = !isPinMode;
                    if (isPinMode) {
                        pinModeBtn.classList.add('active');
                        commandInput.placeholder = "모델명을 클릭하여 고정하세요.";
                    } else {
                        pinModeBtn.classList.remove('active');
                        commandInput.placeholder = "명령어 입력 (예: 미삽 1)";
                        if (pinnedRowId) {
                            document.querySelectorAll(`tr[data-id="${pinnedRowId}"]`).forEach(r => r.classList.remove('pinned-row'));
                            pinnedRowId = null;
                        }
                    }
                });
            }

            document.getElementById('aoi-list-body').addEventListener('click', (e) => {
                if (isDeleteMode) {
                    const row = e.target.closest('tr');
                    if (!row) return;
                    const id = row.dataset.id;
                    const upperRow = document.querySelector(`tr.upper-row[data-id="${id}"]`);
                    const modelName = upperRow ? upperRow.querySelector('.model-text').textContent.trim() : '모델';
                    if (confirm(`[${modelName}] 기록을 삭제하시겠습니까?`)) {
                        fetch(`http://127.0.0.1:5000/api/aoi/records/${id}`, { method: 'DELETE' })
                            .then(res => res.json())
                            .then(res => {
                                if (res.success) document.querySelectorAll(`tr[data-id="${id}"]`).forEach(r => r.remove());
                                else alert('삭제 실패');
                            }).catch(() => alert('오류 발생'));
                    }
                    return;
                }

                if (isPinMode) {
                    const target = e.target;
                    const cell = target.closest('td');
                    if (cell && (cell.cellIndex === 0 || cell.querySelector('.row-span-wrapper.model-text'))) {
                        const row = cell.closest('tr');
                        if (!row) return;
                        const clickedId = row.dataset.id;

                        if (pinnedRowId && pinnedRowId !== clickedId) {
                            document.querySelectorAll(`tr[data-id="${pinnedRowId}"]`).forEach(r => r.classList.remove('pinned-row'));
                        }
                        pinnedRowId = clickedId;
                        document.querySelectorAll(`tr[data-id="${clickedId}"]`).forEach(r => r.classList.add('pinned-row'));

                        const upperRow = document.querySelector(`tr.upper-row[data-id="${clickedId}"]`);
                        const modelName = upperRow ? upperRow.querySelector('.model-text').textContent.trim() : '모델';
                        commandInput.placeholder = `[${modelName}] 고정됨 - 명령어 입력`;
                        commandInput.focus();
                        e.stopPropagation();
                    }
                }
            });

            if (manageBtn) {
                manageBtn.addEventListener('click', () => {
                    isDeleteMode = !isDeleteMode;
                    const tableEl = document.querySelector('.aoi-table');
                    if (isDeleteMode) {
                        manageBtn.classList.add('active');
                        manageBtn.innerHTML = '<i class="uil uil-check"></i> 완료';
                        tableEl.classList.add('delete-mode');
                        if (isPinMode) pinModeBtn.click();
                    } else {
                        manageBtn.classList.remove('active');
                        manageBtn.innerHTML = '<i class="uil uil-cog"></i> 관리';
                        tableEl.classList.remove('delete-mode');
                    }
                });
            }

            function showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast-msg ${type}`;
                toast.innerText = msg;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }

            function updateTime() {
                const now = new Date();
                const str = `${now.getFullYear()}년 ${now.getMonth() + 1}월 ${now.getDate()}일 ${now.getHours()}시 ${now.getMinutes()}분`;
                const el = document.getElementById('current-time');
                if (el) el.textContent = str;
            }
            setInterval(updateTime, 1000);
            updateTime();

            // 모델 추가 모달
            const addModelBtn = document.getElementById('add-model-btn');
            const modelModal = document.querySelector('.model-list-modal');
            const closeModalBtn = document.querySelector('.close-modal-btn');
            const modelListContainer = document.querySelector('.model-list-container');
            const sYearSel = document.getElementById('start-year'), sMonthSel = document.getElementById('start-month');
            const eYearSel = document.getElementById('end-year'), eMonthSel = document.getElementById('end-month');
            const refreshBtn = document.getElementById('refresh-model-list-btn');

            // ----------------------------------------------------------------
            // [모달 초기화] 날짜 드롭다운 설정 (수정: 전월 ~ 익월 기본 선택)
            // ----------------------------------------------------------------
            function initDateDropdowns() {
                const now = new Date();
                const curYear = now.getFullYear();

                // 1. 연도 옵션 생성 (작년 ~ 내년)
                let yearOpts = '';
                for (let y = curYear + 1; y >= curYear - 1; y--) {
                    yearOpts += `<option value="${y}">${y}년</option>`;
                }
                sYearSel.innerHTML = yearOpts;
                eYearSel.innerHTML = yearOpts;

                // 2. 월 옵션 생성 (1~12월)
                let monthOpts = '';
                for (let m = 1; m <= 12; m++) {
                    monthOpts += `<option value="${m}">${m}월</option>`;
                }
                sMonthSel.innerHTML = monthOpts;
                eMonthSel.innerHTML = monthOpts;

                // 3. [수정] 기본 범위 설정: (이전 달) ~ (다음 달)
                // Date 생성자에서 월에 -1이나 +1을 넣으면 자동으로 연도까지 계산됩니다.
                // 예: 1월에서 -1을 하면 작년 12월이 됩니다.
                const startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);

                sYearSel.value = startDate.getFullYear();
                sMonthSel.value = startDate.getMonth() + 1;

                eYearSel.value = endDate.getFullYear();
                eMonthSel.value = endDate.getMonth() + 1;
            }

            initDateDropdowns();

            if (addModelBtn) addModelBtn.addEventListener('click', () => { modelModal.classList.add('visible'); loadModelList(); });

            // [수정 사항: 기간 드롭다운 변경 시 즉시 업데이트되는 이벤트 리스너를 제거했습니다.]
            // [sYearSel, sMonthSel, eYearSel, eMonthSel].forEach(el => el.addEventListener('change', loadModelList)); // <--- 이 코드를 삭제합니다.

            if (refreshBtn) refreshBtn.addEventListener('click', loadModelList); // <--- 새로고침 버튼 클릭 시에만 업데이트됩니다.
            if (closeModalBtn) closeModalBtn.addEventListener('click', () => modelModal.classList.remove('visible'));


            // [수정된 함수] 모델 리스트 로드 (완료 가능 상태 시각화 포함)
            async function loadModelList() {
                modelListContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">로딩 중...</div>';
                try {
                    const query = `start_year=${sYearSel.value}&start_month=${sMonthSel.value}&end_year=${eYearSel.value}&end_month=${eMonthSel.value}`;
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/available_models?${query}`);
                    const data = await response.json();

                    if (!data || data.length === 0) {
                        modelListContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">검사 대기 중인 모델이 없습니다.</div>';
                        return;
                    }

                    const fullHtml = data.map(group => {
                        const modelsHtml = group.models.map(item => {
                            // 1. 수량 파싱
                            const aoiQty = parseInt(item.aoi_qty) || 0;
                            const recvQty = parseInt(item.recv_qty) || 0;
                            const lotQty = parseInt(item.lot) || 0;

                            // 2. 완료 가능 조건 확인 (AOI검사 == 입고 == LOT)
                            const isReadyToComplete = (lotQty > 0) && (recvQty === lotQty) && (aoiQty === lotQty);

                            // 3. 스타일 및 상태 설정
                            const cardStyle = isReadyToComplete
                                ? 'border: 2px solid var(--success-green); background: rgba(0, 230, 118, 0.1);'
                                : '';
                            const statusBadge = isReadyToComplete
                                ? '<div style="background:var(--success-green); color:#000; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">검사완료 (클릭하여 마감)</div>'
                                : '';

                            return `
                    <div class="model-select-card" 
                         data-group-id="${item.id}"
                         data-model="${item.model}" 
                         data-year="${item.year}" 
                         data-month="${item.month}" 
                         data-lot="${item.lot}"
                         data-ready="${isReadyToComplete}"
                         style="flex-direction: column; align-items: flex-start; gap: 8px; ${cardStyle}">
                        
                        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                            <div class="model-name" style="font-size:1.1rem;">${item.model}</div>
                            ${statusBadge}
                        </div>
                        
                        <div class="model-info" style="width:100%; display:flex; justify-content:space-between; align-items:center; font-size:0.85rem; color:#ccc;">
                            <span style="color:#aaa;">${item.year}.${item.month}</span>
                            <div style="display:flex; gap:15px; font-family:'Roboto Mono', monospace;">
                                <span style="color:#ffeb3b;" title="AOI 완료">AOI: ${aoiQty}</span>
                                <span style="color:#00e676;" title="DIP 입고">입고: ${recvQty}</span>
                                <span class="model-lot" title="LOT">LOT: ${item.lot}</span>
                            </div>
                        </div>
                        
                        <div style="width:100%; display:flex; gap:2px; height:4px; margin-top:2px;">
                            <div style="flex:1; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden;" title="입고율">
                                <div style="width:${Math.min((recvQty / lotQty) * 100, 100)}%; height:100%; background-color:#00e676;"></div>
                            </div>
                            <div style="flex:1; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden;" title="검사율">
                                <div style="width:${Math.min((aoiQty / lotQty) * 100, 100)}%; height:100%; background-color:#ffeb3b;"></div>
                            </div>
                        </div>
                    </div>`;
                        }).join('');

                        return `<div class="company-section">
                    <div class="company-title">
                        <span><i class="uil uil-building"></i> ${group.company} (${group.models.length})</span>
                        <i class="uil uil-angle-down"></i>
                    </div>
                    <div class="accordion-wrapper"><div class="model-grid">${modelsHtml}</div></div>
                </div>`;
                    }).join('');

                    modelListContainer.innerHTML = fullHtml;
                } catch (e) {
                    console.error(e);
                    modelListContainer.innerHTML = '<div style="text-align:center; color:#ff4444;">로드 실패</div>';
                }
            }

            // [수정된 이벤트 리스너] 클릭 시 동작 분기 (추가 vs 완료)
            modelListContainer.addEventListener('click', async (e) => {
                const target = e.target;

                // 1. 아코디언 토글
                if (target.closest('.company-title')) {
                    const titleEl = target.closest('.company-title');
                    titleEl.classList.toggle('active');
                    titleEl.nextElementSibling.classList.toggle('open');
                }
                // 2. 모델 카드 클릭
                else if (target.closest('.model-select-card')) {
                    const card = target.closest('.model-select-card');
                    const { groupId, model, year, month, lot, ready } = card.dataset;
                    const isReady = (ready === 'true');

                    // [CASE A] 검사 완료 처리 (리스트에서 숨김)
                    if (isReady) {
                        if (confirm(`[${model}] 모든 수량이 일치합니다.\n검사 완료 처리하여 리스트에서 숨기시겠습니까?`)) {
                            try {
                                const res = await fetch(`http://127.0.0.1:5000/api/aoi/groups/${groupId}/complete`, {
                                    method: 'POST'
                                });
                                const json = await res.json();
                                if (json.success) {
                                    alert('완료 처리되었습니다.');
                                    loadModelList(); // 리스트 새로고침 (해당 모델 사라짐)
                                } else {
                                    alert('오류: ' + json.message);
                                }
                            } catch (e) { alert('통신 오류 발생'); }
                        }
                    }
                    // [CASE B] 일반 추가 (검사 기록 생성)
                    else {
                        if (confirm(`[${model}] 모델을 추가하시겠습니까?`)) {
                            try {
                                const targetDate = currentSelectedDate;
                                const res = await fetch('http://127.0.0.1:5000/api/aoi/records', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        model,
                                        year: parseInt(year),
                                        month: parseInt(month),
                                        lot,
                                        date: targetDate
                                    })
                                });
                                if (res.ok) {
                                    alert('추가되었습니다.');
                                    modelModal.classList.remove('visible');
                                    loadRecordsByDate(targetDate);
                                }
                            } catch (e) { alert('오류 발생'); }
                        }
                    }
                }
            });
            const initToday = new Date().toISOString().split('T')[0];
            loadRecordsByDate(initToday);

            // =========================================================================
            // [7] 확장형 에디터 & 툴팁 (Editor & Tooltip)
            // =========================================================================
            const editorContainer = document.getElementById('global-tooltip');
            let activeInput = null;

            if (editorContainer && !document.getElementById('editor-textarea')) {
                editorContainer.innerHTML = '<textarea id="editor-textarea" spellcheck="false"></textarea>';
            }
            const editorTextarea = document.getElementById('editor-textarea');

            function updateEditorPosition() {
                if (!activeInput || editorContainer.style.display === 'none') return;
                const rect = activeInput.getBoundingClientRect();
                if (rect.width === 0 && rect.height === 0) return;

                editorContainer.classList.remove('pos-right', 'pos-left');
                const editorWidth = 250, screenWidth = window.innerWidth;
                const targetCenterY = rect.top + window.scrollY + (rect.height / 2);
                const topPos = targetCenterY - 26;

                let leftPos;
                if (rect.right + editorWidth + 20 < screenWidth) {
                    leftPos = rect.right + 12; editorContainer.classList.add('pos-right');
                } else {
                    leftPos = rect.left - editorWidth - 12; editorContainer.classList.add('pos-left');
                }
                editorContainer.style.top = `${topPos}px`;
                editorContainer.style.left = `${leftPos}px`;
            }

            function openEditor(targetEl) {
                if (!editorContainer || !editorTextarea) return;
                activeInput = targetEl;
                editorTextarea.value = targetEl.value.replace(/,\s*/g, '\n');
                editorContainer.style.display = 'block';
                updateEditorPosition();
                requestAnimationFrame(() => editorTextarea.focus());
            }

            function closeEditor() {
                if (editorContainer) editorContainer.style.display = 'none';
            }

            window.addEventListener('resize', updateEditorPosition);
            window.addEventListener('scroll', updateEditorPosition, true);

            document.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('defect-ref-input')) openEditor(e.target);
            });

            if (editorTextarea) {
                editorTextarea.addEventListener('input', (e) => {
                    if (activeInput) {
                        const lines = e.target.value.split('\n').map(l => l.trim()).filter(l => l);
                        activeInput.value = lines.join(', ');
                    }
                });

                editorTextarea.addEventListener('keydown', (e) => {
                    if (!activeInput) return;
                    // Shift + Enter: 저장 후 수량 셀로 이동
                    if (e.shiftKey && e.key === 'Enter') {
                        e.preventDefault();
                        triggerChange(activeInput);
                        closeEditor();

                        const currentTr = activeInput.closest('tr');
                        const nextTr = currentTr.nextElementSibling;
                        if (nextTr && nextTr.classList.contains('lower-row')) {
                            const refInputs = Array.from(currentTr.querySelectorAll('.defect-ref-input'));
                            const idx = refInputs.indexOf(activeInput);
                            const qtyInputs = nextTr.querySelectorAll('.defect-qty-input');
                            if (qtyInputs[idx]) qtyInputs[idx].focus();
                        }
                    }
                });

                editorTextarea.addEventListener('blur', () => {
                    setTimeout(() => {
                        closeEditor();
                        if (activeInput) { triggerChange(activeInput); activeInput = null; }
                    }, 100);
                });
            }

            // 모델명 툴팁
            const modelTooltip = document.getElementById('model-tooltip-simple') || document.createElement('div');
            modelTooltip.id = 'model-tooltip-simple';
            if (!document.getElementById('model-tooltip-simple')) document.body.appendChild(modelTooltip);
            modelTooltip.style.cssText = `position:fixed; display:none; background:#333; color:#fff; padding:5px 10px; border-radius:4px; z-index:10000; font-size:0.85rem; pointer-events:none; border:1px solid var(--point-gold);`;

            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('.model-text');
                if (target) {
                    const text = target.getAttribute('data-tooltip');
                    if (text) {
                        modelTooltip.textContent = text;
                        modelTooltip.style.display = 'block';
                        const rect = target.getBoundingClientRect();
                        modelTooltip.style.top = (rect.top + 30) + 'px';
                        modelTooltip.style.left = (rect.right + 10) + 'px';
                    }
                }
            });
            document.addEventListener('mouseout', (e) => {
                if (e.target.closest('.model-text')) modelTooltip.style.display = 'none';
            });

        });
    </script>
</body>

</html>
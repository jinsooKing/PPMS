<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - AOI 검사 기록</title>

    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="aoi.css">

    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="auth.js"></script>
    <script src="logo.js"></script>
    <script src="calendar.js"></script>
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="header-logo-wrapper btn-glitch">
                    <div class="ppms-logo-placeholder"></div>
                </a>
            </div>
            <div class="header-center">
                <div class="common-box font-35pt">AOI 검사 기록</div>
            </div>
            <div class="header-right">
                <div class="common-box font-15pt time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div class="line-schedule-section">
                <div class="aoi-header">
                    <div class="aoi-title">금일 검사 현황</div>
                    
                    <div class="header-command-bar">
                        <i class="uil uil-keyboard cmd-icon"></i>
                        <input type="text" id="command-input" placeholder="명령어 입력 (예: 미삽 1)" autocomplete="off">
                    </div>

                    <div class="header-btn-group">
                        <button id="pin-mode-btn" class="header-btn" title="모델 고정 모드">
                            <i class="uil uil-map-pin-alt"></i> <span>고정</span>
                        </button>

                        <button id="toggle-view-btn" class="header-btn">
                            <i class="uil uil-eye"></i> <span>자세히 보기</span>
                        </button>
    
                        <button id="manage-btn" class="header-btn">
                            <i class="uil uil-cog"></i> <span>관리</span>
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="aoi-table">
                        <colgroup>
                            <col style="width: 200px;"> 
                            <col style="width: 80px;" class="detail-col group-basic">
                            <col style="width: 80px;" class="detail-col group-basic">
                            <col style="width: 80px;" class="detail-col group-basic">
                            <col style="width: 80px;" class="detail-col group-basic">
                            
                            <col class="group-sum-col" style="width: 80px;"> 
                            <col style="width: 60px;" span="5" class="detail-col group-a"> 
                            
                            <col class="group-sum-col" style="width: 80px;"> 
                            <col style="width: 60px;" span="3" class="detail-col group-b"> 
                            
                            <col class="group-sum-col" style="width: 80px;"> 
                            <col style="width: 60px;" span="3" class="detail-col group-c"> 
                            
                            <col class="group-sum-col" style="width: 80px;"> 
                            <col style="width: 60px;" span="2" class="detail-col group-d">
                            
                            <col class="spacer-col" style="width: auto;">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="model-name-ellipsis" style="text-align:center;">모델명</th>
                                <th class="detail-col group-basic">Point</th>
                                <th class="detail-col group-basic">수량</th>
                                <th class="detail-col group-basic">양품</th>
                                <th class="detail-col group-basic">총불량</th>
                                
                                <th class="sum-header">실장오류</th>
                                <th class="detail-col group-a">미삽</th>
                                <th class="detail-col group-a">오삽</th>
                                <th class="detail-col group-a">역삽</th>
                                <th class="detail-col group-a">틀어짐</th>
                                <th class="detail-col group-a">뒤집힘</th>
                                
                                <th class="sum-header">부품결함</th>
                                <th class="detail-col group-b">파손</th>
                                <th class="detail-col group-b">맨하탄</th>
                                <th class="detail-col group-b">이탈</th>
                                
                                <th class="sum-header">납땜불량</th>
                                <th class="detail-col group-c">냉납</th>
                                <th class="detail-col group-c">미납</th>
                                <th class="detail-col group-c">쇼트</th>
                                
                                <th class="sum-header">기타</th>
                                <th class="detail-col group-d">원자재</th>
                                <th class="detail-col group-d">DIP</th>
                                
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="aoi-list-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-left"></div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right">
                <div class="common-box clickable-box aoi-add-btn" id="add-model-btn" style="background-color:var(--accent-blue);">
                    <i class="uil uil-plus-circle"></i> 모델추가
                </div>
            </div>
        </footer>
    </div>

    <div id="toast-container"></div>

    <div class="modal-overlay model-list-modal">
        <div class="modal-window">
            <div class="modal-header" style="justify-content: space-between;">
                <h3 style="margin:0; color:var(--point-gold); display:flex; align-items:center; gap:10px;">
                    <i class="uil uil-list-ul"></i> 생산 완료 모델 선택
                </h3>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="date-range-wrapper">
                        <select id="start-year" class="period-select year-select"></select>
                        <select id="start-month" class="period-select month-select"></select>
                        <span class="range-separator">~</span>
                        <select id="end-year" class="period-select year-select"></select>
                        <select id="end-month" class="period-select month-select"></select>
                        <button id="refresh-model-list-btn" class="refresh-btn" title="새로고침"><i class="uil uil-sync"></i></button>
                    </div>
                    <button class="close-modal-btn" style="background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer; line-height: 1; padding: 0;"><i class="uil uil-multiply"></i></button>
                </div>
            </div>
            <div class="modal-content" style="padding:20px; max-height:80vh; overflow-y:auto;">
                <div class="model-list-container"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) { window.location.href = 'login.html'; return; }
            setTimeout(() => { document.body.style.opacity = '1'; }, 50);
            setupLogoutButton();
            if (typeof PPMS_LOGO !== 'undefined' && PPMS_LOGO.init) PPMS_LOGO.init();

            document.getElementById('back-btn').addEventListener('click', () => history.back());
            document.getElementById('home-btn').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('forward-btn').addEventListener('click', () => history.forward());

            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const pinModeBtn = document.getElementById('pin-mode-btn');
            const manageBtn = document.getElementById('manage-btn');
            const commandInput = document.getElementById('command-input');
            const table = document.querySelector('.aoi-table');
            
            let isDetailMode = false;
            let isPinMode = false;
            let isDeleteMode = false;
            let pinnedRowId = null;

            if (toggleViewBtn) {
                toggleViewBtn.addEventListener('click', () => {
                    isDetailMode = !isDetailMode; 
                    updateViewMode();
                    if(typeof adjustTableScrollbar === 'function') adjustTableScrollbar();
                });
            }

            function updateViewMode() {
                const btnIcon = toggleViewBtn.querySelector('i');
                const btnText = toggleViewBtn.querySelector('span');
                const defectGroups = ['a', 'b', 'c', 'd'];
                const basicGroupCols = document.querySelectorAll('.detail-col.group-basic');
                const sumCols = table.querySelectorAll('colgroup .group-sum-col');
                const sumHeaders = table.querySelectorAll('thead .sum-header');
                const sumCells = table.querySelectorAll('tbody .group-sum-cell');
                const spacerCol = document.querySelector('col.spacer-col');

                if (isDetailMode) {
                    toggleViewBtn.classList.add('active'); 
                    btnIcon.className = 'uil uil-eye-slash';
                    btnText.textContent = '간편 보기';
                    
                    sumCols.forEach(el => el.style.display = 'none');
                    sumHeaders.forEach(el => el.style.display = 'none');
                    sumCells.forEach(el => el.style.display = 'none');

                    basicGroupCols.forEach(col => col.classList.add('visible'));
                    defectGroups.forEach(g => {
                        document.querySelectorAll(`.detail-col.group-${g}`).forEach(col => col.classList.add('visible'));
                    });
                    
                    table.style.width = 'max-content';
                    if(spacerCol) spacerCol.style.width = '0px';

                } else {
                    toggleViewBtn.classList.remove('active');
                    btnIcon.className = 'uil uil-eye';
                    btnText.textContent = '자세히 보기';
                    
                    sumCols.forEach(el => {
                        el.style.display = 'table-column';
                        el.style.width = 'auto'; 
                    });
                    sumHeaders.forEach(el => el.style.display = 'table-cell');
                    sumCells.forEach(el => el.style.display = 'table-cell');
                    
                    basicGroupCols.forEach(col => col.classList.remove('visible'));
                    defectGroups.forEach(g => {
                        document.querySelectorAll(`.detail-col.group-${g}`).forEach(col => col.classList.remove('visible'));
                    });

                    table.style.width = '100%';
                    if(spacerCol) spacerCol.style.width = '0px';
                }
            }

            if (pinModeBtn) {
                pinModeBtn.addEventListener('click', () => {
                    if (isDeleteMode) return;
                    isPinMode = !isPinMode;
                    if (isPinMode) {
                        pinModeBtn.classList.add('active');
                        commandInput.placeholder = "모델명을 클릭하여 고정하세요.";
                    } else {
                        pinModeBtn.classList.remove('active');
                        commandInput.placeholder = "명령어 입력 (예: 미삽 1)";
                        pinnedRowId = null;
                        document.querySelectorAll('.pinned-row').forEach(row => row.classList.remove('pinned-row'));
                    }
                });
            }

            if (manageBtn) {
                manageBtn.addEventListener('click', () => {
                    if (isPinMode) pinModeBtn.click();
                    isDeleteMode = !isDeleteMode;
                    const tableEl = document.querySelector('.aoi-table');
                    if (isDeleteMode) {
                        manageBtn.classList.add('active');
                        manageBtn.querySelector('span').textContent = '완료';
                        manageBtn.querySelector('i').className = 'uil uil-check';
                        tableEl.classList.add('delete-mode');
                    } else {
                        manageBtn.classList.remove('active');
                        manageBtn.querySelector('span').textContent = '관리';
                        manageBtn.querySelector('i').className = 'uil uil-cog';
                        tableEl.classList.remove('delete-mode');
                    }
                });
            }

            document.getElementById('aoi-list-body').addEventListener('click', async (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                const id = row.dataset.id;
                const modelNameTarget = e.target.closest('.model-name-ellipsis');

                if (isDeleteMode) {
                    const modelName = row.querySelector('.model-name-ellipsis').textContent;
                    if (confirm(`[${modelName}] 기록을 삭제하시겠습니까?`)) {
                        await deleteAoiRecord(id, row);
                    }
                    return;
                }

                if (modelNameTarget) {
                    if (isPinMode) {
                        if (pinnedRowId !== id) {
                            document.querySelectorAll('.pinned-row').forEach(r => r.classList.remove('pinned-row'));
                            row.classList.add('pinned-row');
                            pinnedRowId = id;
                            const name = modelNameTarget.textContent;
                            commandInput.placeholder = `[${name}] 입력 대기...`;
                            commandInput.focus();
                        }
                    } else {
                        toggleGroup('basic');
                    }
                }
            });

            const cmdMap = {
                '미삽': 'missing', 'ㅁㅅ': 'missing',
                '오삽': 'wrong', 'ㅇㅅ': 'wrong',
                '역삽': 'reverse', 'ㅇㅇ': 'reverse', '역': 'reverse',
                '틀어짐': 'skewed', 'ㅌㅇ': 'skewed',
                '뒤집힘': 'flipped', 'ㄷㅈ': 'flipped', '뒤': 'flipped',
                '파손': 'damaged', 'ㅍㅅ': 'damaged',
                '맨하탄': 'manhattan', 'ㅁㅎ': 'manhattan', '맨': 'manhattan',
                '이탈': 'detached', 'ㅇㅌ': 'detached',
                '냉납': 'cold', 'ㄴㄴ': 'cold',
                '미납': 'unsoldered', 'ㅁㄴ': 'unsoldered',
                '쇼트': 'short', 'ㅅㅌ': 'short',
                '원자재': 'material', 'ㅇㅈ': 'material', '원': 'material',
                'dip': 'dip', '딮': 'dip', 'ㄷ': 'dip',
            };

            commandInput.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!pinnedRowId) {
                        showToast('고정된 모델이 없습니다.', 'error');
                        return;
                    }
                    const text = commandInput.value.trim();
                    if (!text) return;
                    const parts = text.split(' ');
                    if (parts.length < 2) {
                        showToast('형식 오류 (예: 미삽 1)', 'error');
                        return;
                    }
                    const typeKey = parts[0];
                    const qty = parseInt(parts[1]);
                    const dbField = cmdMap[typeKey];
                    if (!dbField) {
                        showToast(`알 수 없는 유형: ${typeKey}`, 'error');
                        return;
                    }
                    if (isNaN(qty)) return;

                    const row = document.querySelector(`tr[data-id="${pinnedRowId}"]`);
                    const input = row.querySelector(`input[onchange*="'${dbField}'"]`);
                    if (!input) return;
                    const currentVal = parseInt(input.value) || 0;
                    const newVal = currentVal + qty;
                    await window.updateRecord(pinnedRowId, dbField, newVal);
                    commandInput.value = '';
                    commandInput.focus();
                    showToast(`${typeKey} +${qty} 처리됨`);
                }
            });

            function showToast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast-msg ${type}`;
                toast.innerText = msg;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }

            async function deleteAoiRecord(id, rowElement) {
                try {
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/records/${id}`, { method: 'DELETE' });
                    const res = await response.json();
                    if (res.success) {
                        rowElement.remove();
                        if(pinnedRowId === id) {
                            pinnedRowId = null;
                            commandInput.placeholder = "명령어 입력";
                        }
                    } else alert('삭제 실패');
                } catch (e) { alert('오류 발생'); }
            }

            function adjustTableScrollbar() {
                const container = document.querySelector('.table-container');
                const table = document.querySelector('.aoi-table');
                const thead = table.querySelector('thead');
                if (!container || !thead) return;
                const scrollbarWidth = container.offsetWidth - container.clientWidth;
                const lastTh = thead.querySelector('tr:first-child th:last-child');
                if (lastTh) {
                    lastTh.style.paddingRight = scrollbarWidth > 0 ? `${scrollbarWidth}px` : '0';
                }
            }
            window.addEventListener('resize', adjustTableScrollbar);

            renderAoiTable();
            setInterval(updateTime, 1000);
            updateTime();

            const modelAddBtn = document.querySelector('.aoi-add-btn');
            const modelModal = document.querySelector('.model-list-modal');
            const closeModalBtn = document.querySelector('.close-modal-btn');
            const modelListContainer = document.querySelector('.model-list-container');
            const sYearSel = document.getElementById('start-year');
            const sMonthSel = document.getElementById('start-month');
            const eYearSel = document.getElementById('end-year');
            const eMonthSel = document.getElementById('end-month');
            const refreshBtn = document.getElementById('refresh-model-list-btn');

            function initDateDropdowns() {
                const now = new Date();
                const curYear = now.getFullYear();
                let yearOpts = ''; for(let y=curYear+1; y>=curYear-1; y--) yearOpts+=`<option value="${y}">${y}년</option>`;
                sYearSel.innerHTML = yearOpts; eYearSel.innerHTML = yearOpts;
                let monthOpts = ''; for(let m=1; m<=12; m++) monthOpts+=`<option value="${m}">${m}월</option>`;
                sMonthSel.innerHTML = monthOpts; eMonthSel.innerHTML = monthOpts;
                const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
                const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
                sYearSel.value = prev.getFullYear(); sMonthSel.value = prev.getMonth()+1;
                eYearSel.value = next.getFullYear(); eMonthSel.value = next.getMonth()+1;
            }
            initDateDropdowns();

            if (modelAddBtn) {
                modelAddBtn.addEventListener('click', () => { modelModal.classList.add('visible'); loadModelList(); });
            }
            function onRangeChange() { loadModelList(); }
            [sYearSel, sMonthSel, eYearSel, eMonthSel].forEach(el => el.addEventListener('change', onRangeChange));
            if(refreshBtn) refreshBtn.addEventListener('click', loadModelList);

            async function loadModelList() {
                modelListContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">로딩 중...</div>';
                try {
                    const query = `start_year=${sYearSel.value}&start_month=${sMonthSel.value}&end_year=${eYearSel.value}&end_month=${eMonthSel.value}`;
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/available_models?${query}`);
                    const data = await response.json();
                    renderModelListUI(data);
                } catch(e) { modelListContainer.innerHTML = '<div style="text-align:center;">로드 실패</div>'; }
            }

            function renderModelListUI(listData) {
                modelListContainer.innerHTML = '';
                if(!listData || listData.length===0) { modelListContainer.innerHTML='<div style="text-align:center;">데이터 없음</div>'; return; }
                listData.forEach(group => {
                    const section = document.createElement('div'); section.className='company-section';
                    const title = document.createElement('div'); title.className='company-title';
                    title.innerHTML=`<span><i class="uil uil-building"></i> ${group.company} (${group.models.length})</span> <i class="uil uil-angle-down"></i>`;
                    const wrapper = document.createElement('div'); wrapper.className='accordion-wrapper';
                    const grid = document.createElement('div'); grid.className='model-grid';
                    title.addEventListener('click', ()=>{ title.classList.toggle('active'); wrapper.classList.toggle('open'); });
                    group.models.forEach(item => {
                        const card = document.createElement('div'); card.className='model-select-card';
                        card.innerHTML=`<div class="model-name">${item.model}</div><div class="model-info"><span>${item.year}.${item.month}</span><span>LOT: ${item.lot}</span></div>`;
                        card.addEventListener('click', async (e)=>{
                            e.stopPropagation();
                            if(confirm('추가하시겠습니까?')) await createAoiRecord(item);
                        });
                        grid.appendChild(card);
                    });
                    wrapper.appendChild(grid); section.appendChild(title); section.appendChild(wrapper);
                    modelListContainer.appendChild(section);
                });
            }
            closeModalBtn.addEventListener('click', () => modelModal.classList.remove('visible'));

            async function createAoiRecord(item) {
                try {
                    const res = await fetch('http://127.0.0.1:5000/api/aoi/records', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({model:item.model, year:item.year, month:item.month, lot:item.lot})
                    });
                    if(res.ok) { alert('추가됨'); modelModal.classList.remove('visible'); renderAoiTable(); }
                } catch(e) { alert('오류'); }
            }

            async function renderAoiTable() {
                const tbody = document.getElementById('aoi-list-body');
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/aoi/records');
                    const records = await response.json();
                    if (!records || records.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="20" style="padding:30px; color:#666;">기록 없음</td></tr>`;
                        return;
                    }
                    tbody.innerHTML = records.map(r => {
                        const safe = (v) => v || 0;
                        const goodColor = r.good_qty < 0 ? 'var(--danger-red)' : 'var(--success-green)';
                        const sumA = safe(r.missing) + safe(r.wrong) + safe(r.reverse) + safe(r.skewed) + safe(r.flipped);
                        const sumB = safe(r.damaged) + safe(r.manhattan) + safe(r.detached);
                        const sumC = safe(r.cold) + safe(r.unsoldered) + safe(r.short);
                        const sumD = safe(r.material) + safe(r.dip);

                        return `
                        <tr data-id="${r.id}">
                            <td class="model-name-ellipsis" title="${r.model}">${r.model}</td>
                            
                            <td class="detail-col group-basic"><input type="number" value="${safe(r.inspection_point)}" onchange="updateRecord(${r.id}, 'inspection_point', this.value)"></td>
                            <td class="detail-col group-basic"><input type="number" value="${safe(r.inspection_qty)}" onchange="updateRecord(${r.id}, 'inspection_qty', this.value)"></td>
                            <td class="detail-col group-basic good-col" style="color:${goodColor}; font-weight:bold;">${safe(r.good_qty)}</td>
                            <td class="detail-col group-basic defect-total-col" style="color:var(--danger-red); font-weight:bold;">${safe(r.total_defect)}</td>
                            
                            <td class="group-sum-cell">${sumA}</td>
                            <td class="detail-col group-a"><input type="number" value="${safe(r.missing)}" onchange="updateRecord(${r.id}, 'missing', this.value)"></td>
                            <td class="detail-col group-a"><input type="number" value="${safe(r.wrong)}" onchange="updateRecord(${r.id}, 'wrong', this.value)"></td>
                            <td class="detail-col group-a"><input type="number" value="${safe(r.reverse)}" onchange="updateRecord(${r.id}, 'reverse', this.value)"></td>
                            <td class="detail-col group-a"><input type="number" value="${safe(r.skewed)}" onchange="updateRecord(${r.id}, 'skewed', this.value)"></td>
                            <td class="detail-col group-a"><input type="number" value="${safe(r.flipped)}" onchange="updateRecord(${r.id}, 'flipped', this.value)"></td>
                            
                            <td class="group-sum-cell">${sumB}</td>
                            <td class="detail-col group-b"><input type="number" value="${safe(r.damaged)}" onchange="updateRecord(${r.id}, 'damaged', this.value)"></td>
                            <td class="detail-col group-b"><input type="number" value="${safe(r.manhattan)}" onchange="updateRecord(${r.id}, 'manhattan', this.value)"></td>
                            <td class="detail-col group-b"><input type="number" value="${safe(r.detached)}" onchange="updateRecord(${r.id}, 'detached', this.value)"></td>
                            
                            <td class="group-sum-cell">${sumC}</td>
                            <td class="detail-col group-c"><input type="number" value="${safe(r.cold)}" onchange="updateRecord(${r.id}, 'cold', this.value)"></td>
                            <td class="detail-col group-c"><input type="number" value="${safe(r.unsoldered)}" onchange="updateRecord(${r.id}, 'unsoldered', this.value)"></td>
                            <td class="detail-col group-c"><input type="number" value="${safe(r.short)}" onchange="updateRecord(${r.id}, 'short', this.value)"></td>
                            
                            <td class="group-sum-cell">${sumD}</td>
                            <td class="detail-col group-d"><input type="number" value="${safe(r.material)}" onchange="updateRecord(${r.id}, 'material', this.value)"></td>
                            <td class="detail-col group-d"><input type="number" value="${safe(r.dip)}" onchange="updateRecord(${r.id}, 'dip', this.value)"></td>
                            
                            <td></td>
                        </tr>`;
                    }).join('');
                    updateViewMode();
                    adjustTableScrollbar();
                } catch(e) { console.error(e); }
            }

            window.toggleGroup = function(groupName) {
                const cols = document.querySelectorAll(`.detail-col.group-${groupName}`);
                const isOpened = cols[0].classList.contains('visible');
                cols.forEach(col => {
                    if (isOpened) col.classList.remove('visible');
                    else col.classList.add('visible');
                });
                adjustTableScrollbar();
            };

            window.updateRecord = async function (id, field, value) {
                if (isDeleteMode) return;
                try {
                    const payload = {}; payload[field] = parseInt(value) || 0;
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/records/${id}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    if (res.success) {
                        renderAoiTable();
                    }
                } catch (e) { console.error(e); }
            };

            function updateTime() {
                const now = new Date();
                const str = `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일 ${now.getHours()}시 ${now.getMinutes()}분`;
                const el = document.getElementById('current-time');
                if (el) el.textContent = str;
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - AOI 검사 기록</title>

    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="aoi.css">

    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmjua.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="auth.js"></script>
    <script src="logo.js"></script>
    <script src="calendar.js"></script>
</head>

<body>
    <div class="page-container">
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="header-logo-wrapper btn-glitch">
                    <div class="ppms-logo-placeholder"></div>
                </a>
            </div>
            <div class="header-center">
                <div class="common-box font-35pt">AOI 검사 기록</div>
            </div>
            <div class="header-right">
                <div class="common-box font-15pt time-display" id="current-time"></div>
            </div>
        </header>

        <main class="content-area">
            <div class="line-schedule-section">
                <div class="aoi-header">
                    <div class="aoi-title">금일검사현황</div>
                </div>

                <div class="table-container">
                    <table class="aoi-table">
                        <colgroup>
                            <col style="width:200px">
                            <col style="width: 120px;">
                            <col style="width: 120px;">
                            <col style="width: 60px;">
                            <col style="width: 60px;">
                            <col style="width: 60px;" span="14">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="model-name-ellipsis">모델명</th>
                                <th>검사포인트</th>
                                <th>검사수량</th>
                                <th>양품</th>
                                <th>불량</th>
                                <th>역삽</th>
                                <th>미삽</th>
                                <th>오삽</th>
                                <th>틀어짐</th>
                                <th>뒤집힘</th>
                                <th>미납</th>
                                <th>파손</th>
                                <th>맨하탄</th>
                                <th>쇼트</th>
                                <th>냉납</th>
                                <th>들뜸</th>
                                <th>이탈</th>
                                <th>원자재</th>
                                <th>DIP</th>
                            </tr>
                        </thead>
                        <tbody id="aoi-list-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-left"></div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right">
                <div class="common-box clickable-box aoi-add-btn" id="add-model-btn"
                    style="background-color:var(--accent-blue);">
                    <i class="uil uil-plus-circle"></i> 모델추가
                </div>
            </div>
        </footer>
    </div>

    <div class="modal-overlay model-list-modal">
        <div class="modal-window">
            <div class="modal-header" style="justify-content: space-between;">
                <h3 style="margin:0; color:var(--point-gold); display:flex; align-items:center; gap:10px;">
                    <i class="uil uil-list-ul"></i> 생산 완료 모델 선택
                </h3>

                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="date-range-wrapper">
                        <select id="start-year" class="period-select year-select"></select>
                        <select id="start-month" class="period-select month-select"></select>

                        <span class="range-separator">~</span>

                        <select id="end-year" class="period-select year-select"></select>
                        <select id="end-month" class="period-select month-select"></select>

                        <button id="refresh-model-list-btn" class="refresh-btn" title="새로고침">
                            <i class="uil uil-sync"></i>
                        </button>
                    </div>

                    <button class="close-modal-btn"
                        style="background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer; line-height: 1; padding: 0;">
                        <i class="uil uil-multiply"></i>
                    </button>
                </div>
            </div>

            <div class="modal-content" style="padding:20px; max-height:80vh; overflow-y:auto;">
                <div class="model-list-container">
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // [초기화] 1. 로그인 체크
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) {
                window.location.href = 'login.html';
                return;
            }

            // [초기화] 2. UI 설정
            setTimeout(() => { document.body.style.opacity = '1'; }, 50);

            setupLogoutButton(); // 로그아웃 기능 연결

            if (typeof PPMS_LOGO !== 'undefined' && PPMS_LOGO.init) PPMS_LOGO.init();

            // 네비게이션
            document.getElementById('back-btn').addEventListener('click', () => history.back());
            document.getElementById('home-btn').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('forward-btn').addEventListener('click', () => history.forward());

            // [초기화] 3. 메인 데이터 로드
            renderAoiTable();
            setInterval(updateTime, 1000);
            updateTime();

            // -----------------------------------------------------------
            // [기능 1] 모델 추가 모달 & 기간 선택 (드롭다운)
            // -----------------------------------------------------------
            const modelAddBtn = document.querySelector('.aoi-add-btn');
            const modelModal = document.querySelector('.model-list-modal');
            const closeModalBtn = document.querySelector('.close-modal-btn');
            const modelListContainer = document.querySelector('.model-list-container');

            // 드롭다운 요소
            const sYearSel = document.getElementById('start-year');
            const sMonthSel = document.getElementById('start-month');
            const eYearSel = document.getElementById('end-year');
            const eMonthSel = document.getElementById('end-month');
            const refreshBtn = document.getElementById('refresh-model-list-btn');

            // (A) 드롭다운 초기화
            function initDateDropdowns() {
                const now = new Date();
                const curYear = now.getFullYear();

                // 연도 옵션: 작년 ~ 내년
                let yearOpts = '';
                for (let y = curYear + 1; y >= curYear - 1; y--) {
                    yearOpts += `<option value="${y}">${y}년</option>`;
                }
                sYearSel.innerHTML = yearOpts;
                eYearSel.innerHTML = yearOpts;

                // 월 옵션: 1~12월
                let monthOpts = '';
                for (let m = 1; m <= 12; m++) {
                    monthOpts += `<option value="${m}">${m}월</option>`;
                }
                sMonthSel.innerHTML = monthOpts;
                eMonthSel.innerHTML = monthOpts;

                // 기본값: 현재월 - 1개월 ~ 현재월 + 1개월
                const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const next = new Date(now.getFullYear(), now.getMonth() + 1, 1);

                sYearSel.value = prev.getFullYear();
                sMonthSel.value = prev.getMonth() + 1;
                eYearSel.value = next.getFullYear();
                eMonthSel.value = next.getMonth() + 1;
            }

            initDateDropdowns(); // 실행

            // (B) 모델 추가 버튼 클릭
            if (modelAddBtn) {
                modelAddBtn.addEventListener('click', () => {
                    modelModal.classList.add('visible');
                    loadModelList();
                });
            }

            // (C) 변경 시 자동 로드
            function onRangeChange() {
                const sDate = new Date(sYearSel.value, sMonthSel.value - 1);
                const eDate = new Date(eYearSel.value, eMonthSel.value - 1);

                if (sDate > eDate) {
                    alert("시작 기간이 종료 기간보다 늦을 수 없습니다.");
                    eYearSel.value = sYearSel.value;
                    eMonthSel.value = sMonthSel.value;
                }
                loadModelList();
            }

            [sYearSel, sMonthSel, eYearSel, eMonthSel].forEach(el => {
                el.addEventListener('change', onRangeChange);
            });
            if (refreshBtn) refreshBtn.addEventListener('click', loadModelList);

            // (D) 모델 리스트 로드 함수
            async function loadModelList() {
                modelListContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">데이터 조회 중...</div>';

                try {
                    const query = `start_year=${sYearSel.value}&start_month=${sMonthSel.value}&end_year=${eYearSel.value}&end_month=${eMonthSel.value}`;
                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/available_models?${query}`);

                    if (!response.ok) throw new Error('서버 응답 오류');

                    const data = await response.json();
                    renderModelListUI(data);
                } catch (error) {
                    console.error(error);
                    modelListContainer.innerHTML = '<div style="text-align:center; color:var(--danger-red);">데이터 로드 실패 (서버 확인 필요)</div>';
                }
            }

            // (E) UI 그리기 (아코디언)
            function renderModelListUI(listData) {
                modelListContainer.innerHTML = '';
                if (!listData || listData.length === 0) {
                    modelListContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">해당 기간에 생산된 모델이 없습니다.</div>';
                    return;
                }

                listData.forEach(group => {
                    const section = document.createElement('div');
                    section.className = 'company-section';

                    const title = document.createElement('div');
                    title.className = 'company-title';
                    title.innerHTML = `<span><i class="uil uil-building"></i> ${group.company} (${group.models.length})</span> <i class="uil uil-angle-down"></i>`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'accordion-wrapper';
                    const grid = document.createElement('div');
                    grid.className = 'model-grid';

                    title.addEventListener('click', () => {
                        title.classList.toggle('active');
                        wrapper.classList.toggle('open');
                    });

                    group.models.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'model-select-card';
                        card.innerHTML = `
                            <div class="model-name">${item.model}</div>
                            <div class="model-info">
                                <span>${item.year}.${item.month}</span>
                                <span class="model-lot">LOT: ${item.lot}</span>
                            </div>
                        `;
                        card.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (confirm(`[${item.model}] 검사 기록을 추가하시겠습니까?`)) {
                                await createAoiRecord(item);
                            }
                        });
                        grid.appendChild(card);
                    });

                    wrapper.appendChild(grid);
                    section.appendChild(title);
                    section.appendChild(wrapper);
                    modelListContainer.appendChild(section);
                });
            }

            closeModalBtn.addEventListener('click', () => modelModal.classList.remove('visible'));


            // -----------------------------------------------------------
            // [기능 2] AOI 레코드 생성 (모델 선택 시)
            // -----------------------------------------------------------
            async function createAoiRecord(item) {
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/aoi/records', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: item.model,
                            year: item.year,
                            month: item.month,
                            lot: item.lot
                        })
                    });
                    const res = await response.json();
                    if (res.success) {
                        alert('추가되었습니다.');
                        modelModal.classList.remove('visible');
                        renderAoiTable();
                    } else {
                        alert('실패: ' + res.message);
                    }
                } catch (e) { alert('서버 오류'); }
            }


            // -----------------------------------------------------------
            // [기능 3] 메인 테이블 렌더링 (19개 열)
            // -----------------------------------------------------------
            async function renderAoiTable() {
                const tbody = document.getElementById('aoi-list-body');
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/aoi/records');
                    const records = await response.json();

                    if (!Array.isArray(records) || records.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="19" style="padding:30px; color:#666;">금일 검사 기록이 없습니다.</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = records.map(r => {
                        const safe = (v) => v || 0;
                        const goodColor = r.good_qty < 0 ? 'var(--danger-red)' : 'var(--success-green)';

                        return `
                        <tr data-id="${r.id}">
                            <td style="font-weight:bold; color:#fff;" class="model-name-ellipsis" title="${r.model}">${r.model}</td>
                            
                            <td><input type="number" value="${safe(r.inspection_point)}" onchange="updateRecord(${r.id}, 'inspection_point', this.value)"></td>
                            <td><input type="number" value="${safe(r.inspection_qty)}" onchange="updateRecord(${r.id}, 'inspection_qty', this.value)"></td>
                            
                            <td class="good-col" style="color:${goodColor}; font-weight:bold;">${safe(r.good_qty)}</td>
                            <td class="defect-total-col" style="color:var(--danger-red); font-weight:bold;">${safe(r.total_defect)}</td>
                            
                            <td><input type="number" value="${safe(r.reverse)}" onchange="updateRecord(${r.id}, 'reverse', this.value)"></td>
                            <td><input type="number" value="${safe(r.missing)}" onchange="updateRecord(${r.id}, 'missing', this.value)"></td>
                            <td><input type="number" value="${safe(r.wrong)}" onchange="updateRecord(${r.id}, 'wrong', this.value)"></td>
                            <td><input type="number" value="${safe(r.skewed)}" onchange="updateRecord(${r.id}, 'skewed', this.value)"></td>
                            <td><input type="number" value="${safe(r.flipped)}" onchange="updateRecord(${r.id}, 'flipped', this.value)"></td>
                            <td><input type="number" value="${safe(r.unsoldered)}" onchange="updateRecord(${r.id}, 'unsoldered', this.value)"></td>
                            <td><input type="number" value="${safe(r.damaged)}" onchange="updateRecord(${r.id}, 'damaged', this.value)"></td>
                            <td><input type="number" value="${safe(r.manhattan)}" onchange="updateRecord(${r.id}, 'manhattan', this.value)"></td>
                            <td><input type="number" value="${safe(r.short)}" onchange="updateRecord(${r.id}, 'short', this.value)"></td>
                            <td><input type="number" value="${safe(r.cold)}" onchange="updateRecord(${r.id}, 'cold', this.value)"></td>
                            <td><input type="number" value="${safe(r.lifted)}" onchange="updateRecord(${r.id}, 'lifted', this.value)"></td>
                            <td><input type="number" value="${safe(r.detached)}" onchange="updateRecord(${r.id}, 'detached', this.value)"></td>
                            <td><input type="number" value="${safe(r.material)}" onchange="updateRecord(${r.id}, 'material', this.value)"></td>
                            <td><input type="number" value="${safe(r.dip)}" onchange="updateRecord(${r.id}, 'dip', this.value)"></td>
                        </tr>`;
                    }).join('');
                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = `<tr><td colspan="19">데이터 로드 실패</td></tr>`;
                }
            }

            // [기능 4] 인라인 수정
            window.updateRecord = async function (id, field, value) {
                try {
                    const payload = {};
                    payload[field] = parseInt(value) || 0;

                    const response = await fetch(`http://127.0.0.1:5000/api/aoi/records/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    if (res.success) {
                        const row = document.querySelector(`tr[data-id="${id}"]`);
                        if (row) {
                            const updated = res.updated_record;
                            row.querySelector('.defect-total-col').textContent = updated.total_defect;
                            const goodCol = row.querySelector('.good-col');
                            goodCol.textContent = updated.good_qty;
                            goodCol.style.color = updated.good_qty < 0 ? 'var(--danger-red)' : 'var(--success-green)';
                        }
                    }
                } catch (e) { console.error(e); }
            };

            function updateTime() {
                const now = new Date();
                const str = `${now.getFullYear()}년 ${now.getMonth() + 1}월 ${now.getDate()}일 ${now.getHours()}시 ${now.getMinutes()}분`;
                const el = document.getElementById('current-time');
                if (el) el.textContent = str;
            }
        });
    </script>
</body>

</html>
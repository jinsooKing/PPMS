<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 공정 데이터 관리</title>

    <link rel="stylesheet" href="common.css">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="auth.js"></script>
    <script src="logo.js"></script>

    <style>
        /* [추가] 통계 분석 서브 뷰 전용 스타일 */
        .analysis-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .stat-tab-group {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.2);
            padding: 3px;
            border-radius: 8px;
        }

        .stat-tab-btn {
            padding: 6px 15px;
            color: #888;
            border-radius: 6px;
            font-family: 'BMDOHYEON';
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-tab-btn.active {
            background: var(--point-gold);
            color: #1a1b21;
        }

        .statistics-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .statistics-table th {
            background: #15151a;
            color: var(--point-gold);
            padding: 12px;
            border-bottom: 2px solid var(--point-gold);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .statistics-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            color: #fff;
        }

        .stats-clickable-val {
            color: var(--point-gold);
            text-decoration: underline;
            cursor: pointer;
        }

        .stats-problem-yellow {
            color: #FF3D00 !important;
        }

        .stats-problem-red {
            color: #EA00FF !important;
        }

        .manager-fit-modal {
            width: fit-content !important;
            min-width: 400px;
            /* 너무 좁아지지 않도록 최소폭 확보 */
            max-width: 600px;
            height: auto !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background-color: #2a2b38;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* 2. 모달 바디 정렬 */
        .center-align-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* 3. [핵심 수정] 직급/부서 한 줄(Row) 배치 레이아웃 */
        .input-row {
            display: flex;
            flex-direction: row;
            /* 가로 배치 명시 */
            gap: 15px;
            /* 사이 간격 */
            width: 100%;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* 4. [핵심 수정] 입력 그룹이 공간을 공평하게 나눠가지도록 설정 */
        .input-row .input-group {
            flex: 1;
            /* 남은 공간을 1:1로 나눠가짐 */
            width: auto;
            /* 100% 강제 해제 */
            min-width: 0;
            /* Flex 자식 넘침 방지 */
        }

        /* 일반 입력 그룹 (한 줄에 하나 있는 경우) */
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--point-gold);
            font-size: 0.9rem;
            font-weight: normal;
            /* 라벨은 너무 굵지 않게 */
        }

        /* 5. 입력창 및 드롭다운 스타일 */
        #manager-info-modal .luxury-input {
            background-color: #1f2029 !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 235, 167, 0.3);
            text-align: center;
            text-align-last: center;
            width: 100%;
            height: 40px;
            /* 높이 고정으로 찌그러짐 방지 */
            border-radius: 6px;
            padding: 5px 10px;
        }

        #manager-info-modal .luxury-input:focus {
            border-color: var(--point-gold);
            outline: none;
        }

        /* 드롭다운 옵션 스타일 */
        #manager-info-modal select.luxury-input option {
            background-color: #2a2b38;
            color: #ffffff;
        }



        .check-item {
            display: flex;
            /* [핵심 1] Flex 자식 요소들을 수직 중앙 정렬 */
            align-items: center;
            gap: 10px;
            color: #bbb;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            /* [핵심 2] 텍스트의 줄 높이를 1로 고정하여 텍스트 상자 자체의 여백 제거 */
            line-height: 1;
        }

        .check-item:hover {
            color: var(--point-gold);
        }

        /* 기본 체크박스 숨기기 */
        .check-item input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border: 1.5px solid rgba(255, 235, 167, 0.3);
            border-radius: 3px;
            background: #1f2029;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin: 0;
            /* 불필요한 마진 완전 제거 */
            flex-shrink: 0;
            /* 텍스트에 밀려 찌그러짐 방지 */

            /* [핵심 3] 폰트(BMDOHYEON) 특성상 텍스트가 살짝 내려앉아 보일 수 있으므로 
       미세한 픽셀 단위 조정을 위해 transform 사용 (필요시 0.5px 단위로 미세조정) */
            transform: translateY(3px);
        }

        .check-item input[type="checkbox"]:checked {
            background: var(--point-gold);
            border-color: var(--point-gold);
            box-shadow: 0 0 8px rgba(255, 235, 167, 0.4);
        }

        /* [중요] 기존에 남아있을 수 있는 가상 요소(V자 표시 등) 완전 제거 */
        .check-item input[type="checkbox"]::after,
        .check-item input[type="checkbox"]::before {
            display: none !important;
        }


        .center-footer {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }



        /* 부장/차장 등 높은 직급은 테두리 강조 */
        .high-rank-border {
            outline: 2px solid var(--point-gold);
            outline-offset: 3px;
        }

        .selection-marquee {
            position: absolute;
            border: 1px solid #0078d7;
            background-color: rgba(0, 120, 215, 0.1);
            z-index: 9999;
            pointer-events: none;
        }

        /* [추가] 부서별 구분 헤더 스타일 */
        .dept-header {
            grid-column: 1 / -1;
            width: 100%;
            color: var(--point-gold);
            font-size: 0.9rem;
            padding: 15px 0 10px 0;
            margin-top: 20px;
            border-bottom: 1px solid rgba(255, 235, 167, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        /* [추가] 최고 직급자 관리자 뱃지 스타일 */
        .rank-badge {
            position: absolute;
            top: -5px;
            right: 15px;
            background: var(--point-gold);
            color: #1a1b21;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }

        /* [중요] 아이콘 깨짐 방지 (전역 bold 설정 무력화) */
        i.uil {
            font-weight: normal !important;
        }

        .manager-circle-wrapper::after {
            display: none !important;
        }

        /* 담당자 아이콘 전용 호버 효과 (원하는 경우 추가) */
        .folder-item[data-type="manager"]:hover .manager-circle-wrapper {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--point-gold);
        }

        /* ============================================================
   [최종 보정] 탭 메뉴 스타일: 계단 현상 및 투명도 해결
   ============================================================ */
        .section-tab-bar {
            display: flex !important;
            flex-direction: row !important;
            justify-content: center !important;
            align-items: center !important;
            /* [핵심] 모든 요소를 세로 정중앙에 고정 */
            background-color: #23242d !important;
            /* 배경색을 명시하여 투명함 해결 */
            border-bottom: 1px solid rgba(255, 235, 167, 0.2) !important;
            padding: 0 20px !important;
            gap: 15px !important;
            height: 55px !important;
            /* 높이를 55px로 강제 고정 */
            z-index: 999 !important;
            flex-shrink: 0 !important;
            width: 100% !important;
        }

        .tab-item {
            position: relative !important;
            padding: 0 25px !important;
            /* 투명도 해결: 밝은 글자색으로 변경하여 시인성 확보 */
            color: rgba(255, 255, 255, 0.8) !important;
            font-size: 1rem !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            /* 아이콘과 텍스트 세로 정렬 */
            justify-content: center !important;
            gap: 8px !important;
            height: 100% !important;
            /* 부모 높이에 맞춤 */
            white-space: nowrap !important;
            /* 줄바꿈 방지 */
            margin: 0 !important;
            /* 계단 현상을 유발하는 외부 여백 제거 */
            /* [주의] GSAP 애니메이션과 충돌할 수 있으므로 transition: all은 제거 권장 */
            transition: color 0.3s ease !important;
        }

        .tab-item:hover {
            color: #ffffff !important;
        }

        .tab-item.active {
            color: var(--point-gold) !important;
            font-weight: 800 !important;
        }

        .tab-item.active::after {
            content: '' !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 3px !important;
            background-color: var(--point-gold) !important;
            border-radius: 3px 3px 0 0 !important;
            box-shadow: 0 -2px 10px rgba(255, 235, 167, 0.5) !important;
        }



        /* [수정] 담당자 모달 (Fit & Center) */
        .manager-fit-modal {
            width: fit-content !important;
            min-width: 400px;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background-color: #2a2b38;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .center-align-body {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-row {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
            margin-bottom: 20px;
        }

        .input-row .input-group {
            flex: 1;
            min-width: 0;
        }

        .input-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        #manager-info-modal .luxury-input {
            text-align: center;
            text-align-last: center;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 20px;
            width: 100%;
            padding: 18px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 235, 167, 0.1);
            border-radius: 10px;
            box-sizing: border-box;
        }

        .center-footer {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        * {
            box-sizing: border-box;
        }

        /* 필요한 경우 body에만 굵기 적용 */
        body {
            font-weight: bold;
        }

        i {
            font-weight: normal !important;
        }

        /* 아이콘은 굵기 해제 */

        /* 필요한 경우 body에만 적용 */

        body {
            overflow: hidden;
            background-color: #1a1b21;
            font-family: 'BMDOHYEON', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .page-container {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            padding: 0 !important;
            position: relative;
            overflow: hidden;
            background-color: #1a1b21;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* [추가] 뷰 섹션 높이 보정 (세로 스크롤 방지) */
        .view-section {
            width: 100%;
            min-height: auto !important;
            /* 100% 강제 해제 */
            padding: 20px;
            display: none;
        }

        /* [수정] 애니메이션 안정성을 위한 그리드 설정 */
        .dashboard-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            grid-template-rows: repeat(2, 1fr) !important;
            gap: clamp(10px, 2vh, 25px) !important;
            padding: clamp(10px, 2vh, 30px) !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 1400px !important;
            margin: 0 auto !important;
            box-sizing: border-box !important;
            /* [추가] 애니메이션 도중 자식 요소가 영역 밖으로 나갈 때 스크롤바 방지 */
            overflow: hidden !important;
            /* [추가] 하드웨어 가속 활용 */
            backface-visibility: hidden;
        }

        .dashboard-card,
        .dept-column,
        .folder-item {
            opacity: 0;
            will-change: transform, opacity;
        }

        /* 기존 스타일 중 애니메이션을 방해하는 !important 속성 제거 또는 수정 */
        .dashboard-card {
            /* 기존의 opacity: 1 !important; 를 삭제하거나 아래와 같이 수정하세요 */
            background: linear-gradient(145deg, #2a2b38, #23242d) !important;
            border: 1px solid rgba(255, 235, 167, 0.15) !important;
            border-radius: clamp(10px, 1.5vh, 20px) !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            height: 100% !important;
            min-height: 0 !important;
        }

        /* 카드 내부 요소 크기도 비율에 맞게 조절 */
        .card-icon {
            font-size: clamp(2.5rem, 5vh, 4.5rem) !important;
            margin-bottom: 1vh !important;
        }

        .card-title {
            font-size: clamp(1rem, 2vh, 1.3rem) !important;
            margin-bottom: 0.5vh !important;
        }

        .card-desc {
            font-size: clamp(0.75rem, 1.3vh, 0.9rem) !important;
            max-width: 80%;
        }

        /* 부모 컨테이너 강제 설정 (스크롤 방지) */
        #main-dashboard-view {
            height: 100% !important;
            overflow: hidden !important;
        }

        /* [Nav Bar] */
        .folder-nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-left-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            color: #888;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breadcrumb-item:hover {
            color: #fff;
        }

        .breadcrumb-item.active {
            color: var(--point-gold);
            cursor: default;
        }

        .breadcrumb-separator {
            color: #555;
            font-size: 0.8rem;
        }

        .nav-back-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-back-btn:hover {
            background: var(--accent-blue);
            color: #fff;
            transform: translateY(-2px);
        }

        .folder-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 5px 15px;
            color: #fff;
            font-family: 'BMDOHYEON';
            width: 250px;
            transition: 0.2s;
        }

        .search-box:focus {
            border-color: var(--point-gold);
            width: 300px;
            outline: none;
        }

        /* [Input UI] */
        .luxury-input-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 5px 5px 5px 25px;
            width: 100%;
            max-width: 500px;
            margin: 0 0 40px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .luxury-input-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--point-gold);
            transform: translateY(-2px);
        }

        .luxury-input {
            flex: 1;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 1rem;
            font-family: 'BMDOHYEON';
            outline: none;
            height: 40px;
        }

        .luxury-add-btn {
            background: linear-gradient(135deg, #1a1b21, #2d2d2d);
            color: #ccc;
            border: 1px solid #444;
            border-radius: 50px;
            padding: 0 25px;
            height: 40px;
            font-family: 'BMDOHYEON';
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .luxury-add-btn:hover {
            background: #000;
            color: var(--point-gold);
            border-color: var(--point-gold);
            transform: scale(1.05);
        }

        /* [Folder/Grid] */
        .grid-section-title {
            color: #888;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 20px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 25px;
            justify-items: center;
            align-items: start;
        }

        .folder-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 120px;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.2s;
            position: relative;
        }



        .folder-item.selected {
            /* 첨부하신 사진의 파란색 강조 효과 반영 */
            background-color: rgba(0, 120, 215, 0.3) !important;
            outline: 1px solid rgba(0, 120, 215, 0.6) !important;
            border-radius: 2px;
            box-shadow: none !important;
            transform: none !important;
            /* 위로 뜨는 효과 제거 (탐색기 스타일) */
        }

        /* 선택된 항목의 파일명은 전체 표시 */
        .folder-item.selected .folder-name {
            white-space: normal;
            overflow: visible;
            word-break: break-all;
            position: relative;
            z-index: 100;
            background: rgba(42, 43, 56, 0.95);
            /* 주변 항목을 가려도 글자가 잘 보이게 배경 추가 */
            border-radius: 4px;
            padding: 5px;
        }

        .folder-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .folder-item:active .folder-3d {
            transform: scale(0.95);
        }

        .folder-3d {
            position: relative;
            width: 90px;
            height: 65px;
            perspective: 600px;
            margin-bottom: 10px;
        }

        .folder-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #d8a044;
            border-radius: 4px;
            border-top-right-radius: 4px;
        }

        .folder-back::after {
            content: '';
            position: absolute;
            bottom: 98%;
            left: 0;
            width: 35px;
            height: 8px;
            background: #d8a044;
            border-radius: 4px 4px 0 0;
        }

        .paper {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 80px;
            height: 55px;
            background: white;
            border-radius: 2px;
            transition: transform 0.3s;
            transform-origin: bottom;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .folder-front {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 55px;
            background: linear-gradient(to bottom, #fddb72, #f3c256);
            border-radius: 0 0 4px 4px;
            border-top-right-radius: 4px;
            transform-origin: bottom;
            transition: transform 0.3s;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .folder-front::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.4);
        }

        .folder-item:hover .folder-front {
            transform: rotateX(-25deg);
        }

        .folder-item:hover .paper {
            transform: translateY(-5px) scale(0.95);
        }

        .folder-name {
            color: #ddd;
            font-size: 0.85rem;
            text-align: center;
            line-height: 1.3;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);

            /* 기본적으로 한 줄로 제한하고 넘치면 ... 표시 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            padding: 0 5px;
            transition: all 0.2s;
        }

        .folder-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Model Icon */
        .file-icon-wrapper {
            width: 80px;
            height: 90px;
            background: #eee;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .file-icon-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            border-top: 20px solid #1a1b21;
            border-left: 20px solid transparent;
            width: 0;
        }

        .file-type-icon {
            font-size: 2.5rem;
            color: #555;
        }

        /* [File Upload] */
        .file-manage-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .file-drop-zone {
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }

        .file-drop-zone:hover {
            border-color: var(--point-gold);
            background: rgba(255, 255, 255, 0.05);
        }

        .zone-icon {
            font-size: 3rem;
            color: #666;
            margin-bottom: 15px;
        }

        /* 브레드크럼 상세 스타일 */
        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breadcrumb-item:hover {
            color: #fff;
        }

        .breadcrumb-item.active {
            color: var(--point-gold);
            font-weight: bold;
            cursor: default;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #555;
        }

        .zone-title {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 5px;
        }

        .zone-desc {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: normal !important;
        }

        .action-btn {
            font-family: 'BMDOHYEON', sans-serif;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .action-btn:hover {
            background: #1a3b8e;
            transform: scale(1.05);
        }

        /* [수정] 모달 헤더: 제목과 X버튼의 완벽한 수평 정렬 */
        .modal-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* [핵심] Y축 중앙 정렬 */
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 235, 167, 0.2);
        }

        .modal-header h3 {
            color: var(--point-gold);
            /* 제목 색상을 금색으로 변경 */
            margin: 0;
            /* 불필요한 마진 제거 */
            font-size: 1.3rem;
            text-shadow: 0 0 10px rgba(255, 235, 167, 0.3);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--point-gold);
        }

        /* [수정] 하단 버튼: 테마에 맞는 고급스러운 디자인 */
        .center-footer {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            font-family: 'BMDOHYEON', sans-serif;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        /* 취소 버튼: 어두운 배경 + 금색 테두리 */
        .action-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #fff;
        }

        /* 저장 버튼: 금색 그라데이션 + 어두운 글자 */
        .action-btn.save {
            background: linear-gradient(135deg, #f3c256, #d8a044);
            color: #1a1b21;
            border: none;
            box-shadow: 0 4px 15px rgba(216, 160, 68, 0.3);
        }

        .action-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(216, 160, 68, 0.5);
            filter: brightness(1.1);
        }

        .current-file-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* [Footer] */
        .main-footer {
            height: 70px;
            background: rgba(31, 32, 41, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 100;
        }

        .footer-center {
            display: flex;
            gap: 20px;
        }

        .footer-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .footer-btn:hover {
            background: var(--accent-blue);
            color: #fff;
            transform: translateY(-2px);
        }

        /* [Context Menu] */
        #context-menu {
            position: absolute;
            z-index: 10000;
            width: 150px;
            background: #2b2c3b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: none;
            overflow: hidden;
        }

        .ctx-item {
            padding: 10px 15px;
            color: #ccc;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctx-item:hover {
            background: var(--accent-blue);
            color: #fff;
        }

        .ctx-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }


        /* 카드 호버 시 투명도 변화 방지 */
        .dashboard-card:hover {
            transform: translateY(-10px) !important;
            border-color: var(--point-gold) !important;
            box-shadow: 0 15px 40px rgba(255, 235, 167, 0.2) !important;
            background: linear-gradient(145deg, #323344, #2a2b38) !important;
        }

        /* 뷰 섹션 컨테이너 보정 */
        #main-dashboard-view {
            width: 100% !important;
            display: block;
            /* switchTab에서 제어 */
            opacity: 1 !important;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--point-gold);
            opacity: 0;
            transition: opacity 0.3s;
        }


        .dashboard-card:hover::before {
            opacity: 1;
        }

        .folder-item.dragging {
            opacity: 0.4 !important;
        }

        /* [추가] 드래그 오버 시 폴더 스타일 */
        .folder-item.drag-over {
            background-color: rgba(255, 235, 167, 0.2) !important;
            outline: 2px dashed var(--point-gold) !important;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
    </style>
</head>

<body>
    <div id="context-menu"></div>

    <div class="page-container">

        <header class="main-header">
            <div class="header-left"><a href="index.html" class="ppms-logo-placeholder"></a></div>
            <div class="header-center">
                <div class="common-box">공정 데이터 관리</div>
            </div>
            <div class="header-right">
                <div class="common-box time-display" id="current-time"></div>
            </div>
        </header>
        <nav class="section-tab-bar">
            <div class="tab-item active" onclick="switchTab('management')">
                <i class="uil uil-setting"></i> <span>통합 관리</span>
            </div>
            <div class="tab-item" onclick="switchTab('production')">
                <i class="uil uil-circuit"></i> <span>생산 공정</span>
            </div>
            <div class="tab-item" onclick="switchTab('aoi')">
                <i class="uil uil-eye"></i> <span>검사 공정</span>
            </div>
            <div class="tab-item" onclick="switchTab('dip')">
                <i class="uil uil-wrench"></i> <span>기능 공정</span>
            </div>
        </nav>

        <main class="admin-content">
            <div class="breadcrumb-area"
                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-shrink: 0; padding-right: 10px;">

                <div style="display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0;">
                    <div class="breadcrumb-list" id="breadcrumb-container"
                        style="display: flex; align-items: center; font-size: 0.95rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    </div>
                </div>

                <div class="search-wrapper" style="margin-left: 20px;">
                    <input type="text" class="search-box" id="folder-search" placeholder="항목 검색..."
                        onkeyup="filterFolderItems()"
                        style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; padding: 5px 15px; color: #fff; font-family: 'BMDOHYEON'; width: 200px;">
                </div>
            </div>
            <div id="view-container" style="flex: 1; position: relative; overflow-y: auto;">

                <div id="main-dashboard-view" class="view-section">
                </div>

                <div id="sub-detail-view" class="view-section" style="display: none;">
                    <div id="sub-view-content"></div>
                </div>

            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-left"></div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right"></div>
        </footer>
    </div>
    <script>
        /** * [PPMS Admin Process Map Script]
         * - 보안 강화(XSS 방지), 경쟁 상태 해결, 에러 핸들링 추가됨
         * - 모델 아이콘 변경: uil-file-alt -> uil-layer-group
         */
        /** * [PPMS Admin Script - Tab Layout Version] 
             * 통합 관리 / 생산 / 검사 / 기능 4개 섹션 지원
             */

        const state = {
            currentPath: [],
            activeTab: 'management',
            selectedIds: new Set(), // 다중 선택된 ID 저장용 [추가]
            clipboard: { action: null, type: null, id: null, name: null }
        };

        let currentRequestId = 0;
        let contextMenu = null;
        let targetItemData = null;

        document.addEventListener('DOMContentLoaded', () => {
            // [추가] admin.html에서 가져온 보안 로직
            const userRole = localStorage.getItem('ppms_user_role');
            if (!userRole) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }
            if (userRole !== 'admin') {
                alert('접근 권한이 없습니다.');
                window.location.href = 'index.html';
                return;
            }

            // [추가] 초기 페이드인 효과 (admin.html 스타일)
            setTimeout(() => { document.body.style.opacity = '1'; }, 50);
            contextMenu = document.getElementById('context-menu');
            setupEvents();
            updateTime(); setInterval(updateTime, 1000);

            // 초기화: 기본 탭 로드
            switchTab('management');

            // 애니메이션 초기화
            gsap.from(".tab-item", { y: -20, opacity: 0, stagger: 0.1, duration: 0.5 });
        });
        /* [전체 교체] 탭 동작 분리: 통합관리는 업체목록, 나머지는 자유 폴더 뷰 */
        window.switchTab = function (tabName) {
            if (tabName === 'statistics') { location.href = 'statistics.html'; return; }
            if (tabName === 'status') { location.href = 'admin_status.html'; return; }

            state.activeTab = tabName;
            state.currentPath = []; // 경로 초기화

            document.getElementById('sub-view-content').innerHTML = '';
            document.querySelectorAll('.tab-item').forEach(el => {
                el.classList.remove('active');
                const onclickAttr = el.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(tabName)) el.classList.add('active');
            });

            updateBreadcrumb();

            // [핵심] 탭 성격에 따른 뷰 전환 분기
            if (tabName === 'management') {
                // 1. 통합 관리: 카드 대시보드 -> 업체 목록으로 이어지는 기존 흐름
                document.getElementById('sub-detail-view').style.display = 'none';
                document.getElementById('main-dashboard-view').style.display = 'block';
                renderRootView();
            } else {
                // 2. 생산/검사/기능: 바로 자유 폴더 뷰 진입 (루트)
                document.getElementById('main-dashboard-view').style.display = 'none';
                document.getElementById('sub-detail-view').style.display = 'block';
                // companyId 없이 섹션 정보만 가지고 루트 조회
                renderRecursiveFolderView({ section: tabName, folderId: null, companyId: null });
            }
        };

        /* [전체 교체] renderRootView: 투명도 및 깜빡임 해결 */
        function renderRootView() {
            const mainView = document.getElementById('main-dashboard-view');
            if (state.activeTab === 'management') {
                mainView.innerHTML = `
            <div class="dashboard-grid">
                <div class="dashboard-card" onclick="navigateTo('company_manager', {section:'common'})">
                    <div class="card-icon"><i class="uil uil-building"></i></div>
                    <div class="card-title">업체 및 모델 통합 관리</div>
                    <div class="card-desc">업체별 모델, BOM, 좌표 데이터 관리</div>
                </div>
                <div class="dashboard-card" onclick="navigateTo('manager_manager')">
                    <div class="card-icon"><i class="uil uil-users-alt"></i></div>
                    <div class="card-title">담당자 관리</div>
                    <div class="card-desc">직원 인사 정보 및 역할 설정</div>
                </div>
                <div class="dashboard-card" onclick="location.href='statistics.html'">
                    <div class="card-icon"><i class="uil uil-analytics"></i></div>
                    <div class="card-title">통계 분석</div>
                    <div class="card-desc">생산 실적 및 AOI 데이터 분석</div>
                </div>
                <div class="dashboard-card" onclick="location.href='admin_status.html'">
                    <div class="card-icon"><i class="uil uil-clipboard-notes"></i></div>
                    <div class="card-title">작업 현황</div>
                    <div class="card-desc">공정별 실시간 작업 상태 현황</div>
                </div>
            </div>`;

                if (typeof gsap !== 'undefined') {
                    gsap.killTweensOf(".dashboard-card");
                    // [수정] fromTo 사용: 0 -> 1 강제 변환
                    gsap.fromTo(".dashboard-card",
                        { opacity: 0, y: 20, scale: 0.95 },
                        {
                            duration: 0.6,
                            opacity: 1,
                            y: 0,
                            scale: 1,
                            stagger: 0.08,
                            ease: "power2.out",
                            clearProps: "transform" // opacity는 유지하고 위치 값만 초기화
                        }
                    );
                }
            }
        }
        /* [수정] 외부 페이지로 완전히 분리된 뷰 호출 로직 제거 */
        async function navigateTo(target, data = {}) {
            const mainView = document.getElementById('main-dashboard-view');
            const subView = document.getElementById('sub-detail-view');

            if (target === 'root') {
                state.currentPath = [];
                switchTab(state.activeTab);
                return;
            }

            // 경로 데이터 설정
            if (target === 'company_manager') state.currentPath = [{ id: 'company_manager', name: '업체 목록' }];
            else if (target === 'manager_manager') state.currentPath = [{ id: target, name: '담당자 관리' }];
            else if (target === 'folder_view') state.currentPath.push(data);
            else if (target === 'file_upload') state.currentPath.push({ id: 'file_view', name: data.modelName });

            updateBreadcrumb();
            mainView.style.display = 'none';
            subView.style.display = 'block';

            // 실제 렌더링 함수 호출 (분리된 파일은 링크로 가므로 여기서는 제외)
            if (target === 'company_manager') await renderCompanyFolderList(data.section || 'common');
            else if (target === 'manager_manager') await renderManagerList();
            else if (target === 'folder_view') await renderRecursiveFolderView(data);
            else if (target === 'file_upload') renderFileUploadUI(data.modelId, data.modelName);
        }
        /* [전체 교체] 통계 분석 UI 및 조회 기능 통합 */
        function renderStatisticsUI() {
            const content = document.getElementById('sub-view-content');
            content.innerHTML = `
        <div class="analysis-toolbar">
            <div class="stat-tab-group">
                <div class="stat-tab-btn active" id="btn-stat-prod">생산 실적</div>
                <div class="stat-tab-btn" id="btn-stat-aoi">AOI 분석</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="stat-year" class="luxury-input" style="width:80px;" value="${new Date().getFullYear()}">
                <select id="stat-month" class="luxury-input" style="width:100px;">
                    ${Array.from({ length: 12 }, (_, i) => `<option value="${i + 1}월분">${i + 1}월</option>`).join('')}
                </select>
                <button class="luxury-add-btn" onclick="fetchProdStatistics()">조회</button>
            </div>
        </div>
        <div id="stat-result-container" style="background:rgba(0,0,0,0.2); border-radius:10px; padding:20px; min-height:400px; overflow:auto;">
            <div style="text-align:center; color:#666; padding-top:150px;">조건을 선택하고 조회를 눌러주세요.</div>
        </div>`;
        }

        /* [추가] 실제 생산 실적 데이터를 가져오는 함수 (statistics.html 로직 이식) */
        async function fetchProdStatistics() {
            const yy = document.getElementById('stat-year').value;
            const mm = document.getElementById('stat-month').value;
            const container = document.getElementById('stat-result-container');

            container.innerHTML = '<div style="text-align:center; padding-top:150px; color:var(--point-gold);">데이터 조회 중...</div>';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/statistics/order_month_summary?order_month=${mm}&year=${yy}`);
                const data = await res.json();

                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding-top:150px; color:#666;">데이터가 없습니다.</div>';
                    return;
                }

                // 2단 레이아웃 테이블 생성 (statistics.html의 로직 활용)
                let html = `<table class="statistics-table"><thead><tr><th>모델명</th><th>LOT/실적</th><th></th><th>모델명</th><th>LOT/실적</th></tr></thead><tbody>`;
                for (let i = 0; i < data.length; i += 2) {
                    html += `<tr>${createStatCell(data[i])} <td style="width:2px; background:rgba(255,235,167,0.2); padding:0;"></td> ${data[i + 1] ? createStatCell(data[i + 1]) : '<td></td><td></td>'}</tr>`;
                }
                html += `</tbody></table>`;
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '조회 실패'; }
        }

        function createStatCell(item) {
            let colorClass = item.status === 'shortage' ? 'stats-problem-yellow' : (item.status === 'imbalance' ? 'stats-problem-red' : '');
            return `<td>${item.model}</td><td><span style="color:#666; font-size:0.8rem;">${item.totalQuantity}</span> / <span class="stats-clickable-val ${colorClass}">${item.actualProduction}</span></td>`;
        }

        /* [추가] 작업 현황 통합 UI (구조 예시) */
        function renderStatusUI() {
            const content = document.getElementById('sub-view-content');
            content.innerHTML = `
        <div style="padding:40px; text-align:center;">
            <i class="uil uil-construction" style="font-size:4rem; color:var(--point-gold);"></i>
            <h2 style="color:#fff; margin-top:20px;">작업 현황 모니터링</h2>
            <p style="color:#888;">실시간 공정별 작업 데이터를 준비 중입니다.</p>
        </div>`;
        }

        // --- Breadcrumb 업데이트 ---
        function updateBreadcrumb() {
            const container = document.getElementById('breadcrumb-container');
            if (!container) return; // 컨테이너가 없으면 실행 중단 (null 에러 방지)

            const tabNames = {
                'management': '통합 관리',
                'production': '생산 공정',
                'aoi': '검사 공정',
                'dip': '기능 공정'
            };

            // 현재 활성화된 탭 이름을 홈으로 설정
            let html = `<div class="breadcrumb-item" onclick="navigateTo('root')"><i class="uil uil-home"></i> ${tabNames[state.activeTab]}</div>`;

            state.currentPath.forEach((step, index) => {
                const safeName = escapeHtml(step.name); // 여기서 escapeHtml을 호출함
                html += `<div class="breadcrumb-separator"><i class="uil uil-angle-right"></i></div>`;
                if (index === state.currentPath.length - 1) {
                    html += `<div class="breadcrumb-item active">${safeName}</div>`;
                } else {
                    html += `<div class="breadcrumb-item" onclick="handleBreadcrumbClick(${index})">${safeName}</div>`;
                }
            });
            container.innerHTML = html;
        }
        // [추가] 특수 문자를 안전하게 변환하는 함수
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // [추가] 뒤로가기 버튼 클릭 시 한 단계 위 디렉토리로 이동
        window.goBackLevel = function () {
            if (state.currentPath.length > 0) {
                // 현재 경로의 마지막 인덱스 바로 앞 단계로 이동
                handleBreadcrumbClick(state.currentPath.length - 2);
            } else {
                // 최상위 루트인 경우 대시보드로 복귀
                navigateTo('root');
            }
        };

        function handleBreadcrumbClick(index) {
            const targetStep = state.currentPath[index];
            state.currentPath = state.currentPath.slice(0, index); // 경로 자르기

            if (index === 0 && targetStep.id === 'company_manager') {
                navigateTo('company_manager', { section: targetStep.section });
            } else {
                // 탭 모드에 따라 분기
                if (state.activeTab !== 'management' && index === -1) { // 루트
                    renderCompanyFolderList(state.activeTab);
                } else {
                    navigateTo('folder_view', targetStep);
                }
            }
        }
        /* [전체 교체] 업체 목록 렌더링: 잔상 제거 및 애니메이션 적용 */
        async function renderCompanyFolderList(section) {
            const requestId = ++currentRequestId;
            const content = document.getElementById('sub-view-content');

            // [핵심] API 요청 전에 화면을 먼저 비움 (이전 화면 잔상 제거)
            content.innerHTML = '';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/companies?section=${section}`);
                if (requestId !== currentRequestId) return;
                if (!res.ok) throw new Error("Server Error");
                const companies = await res.json();

                let html = `<div style="margin-bottom:20px;"></div>`;

                if (companies.length === 0) {
                    html += `
            <div style="text-align:center; color:#666; margin-top:80px;">
                <i class="uil uil-info-circle" style="font-size:3rem; display:block; margin-bottom:15px; opacity:0.3;"></i>
                등록된 업체가 없습니다.<br>
                배경 영역을 <strong style="color:var(--point-gold);">우클릭</strong>하여 새 업체를 추가하세요.
            </div>`;
                } else {
                    html += `<div class="folder-grid">`;
                    companies.forEach(comp => {
                        const safeName = escapeHtml(comp.name);
                        html += `
                <div class="folder-item filter-target" onclick="enterCompany(this)" 
                     data-name="${safeName}" data-id="${comp.id}" data-type="company" 
                     data-company-id="${comp.id}" data-section="${section}">
                    <div class="folder-3d">
                        <div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div>
                        <span class="folder-count">${comp.model_count || 0}</span>
                    </div>
                    <div class="folder-name">${safeName}</div>
                </div>`;
                    });
                    html += `</div>`;
                }
                content.innerHTML = html;

                if (typeof gsap !== 'undefined') {
                    gsap.killTweensOf(".folder-item");
                    gsap.fromTo(".folder-item",
                        { opacity: 0, scale: 0.5, y: 10 },
                        { duration: 0.5, opacity: 1, scale: 1, y: 0, stagger: 0.05, ease: "back.out(1.5)", clearProps: "transform" }
                    );
                }
            } catch (e) {
                if (requestId === currentRequestId) {
                    content.innerHTML = `<div style="text-align:center; padding:50px; color:#ff6b6b;">데이터 로드 실패</div>`;
                }
            }
        }
        window.enterCompany = (el) => {
            const id = el.dataset.id;
            const name = el.dataset.name;
            const section = el.dataset.section;
            navigateTo('folder_view', { companyId: id, folderId: null, name: name, section: section });
        };

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            if (['pdf', 'doc', 'docx', 'txt', 'xlsx', 'xls'].includes(ext)) return 'uil-file-alt'; // 문서
            if (['mp4', 'avi', 'mov'].includes(ext)) return 'uil-camera-video'; // 동영상
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'uil-image'; // 이미지
            return 'uil-file'; // 기본 파일
        }
        /* [수정] handleGeneralUpload: 루트 경로(undefined) 예외 처리 */
        window.handleGeneralUpload = async function (input) {
            const file = input.files[0];
            if (!file) return;

            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                alert("파일 크기가 너무 큽니다. 최대 50MB까지 업로드 가능합니다.");
                input.value = "";
                return;
            }

            // [수정] 현재 경로가 없는(루트) 경우 안전하게 처리
            const last = state.currentPath.length > 0 ? state.currentPath[state.currentPath.length - 1] : null;
            const folderId = last ? last.folderId : '';
            const companyId = last ? last.companyId : '';

            const fd = new FormData();
            fd.append('file', file);
            fd.append('folder_id', folderId);
            fd.append('company_id', companyId);
            fd.append('section', state.activeTab);

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/files/upload`, {
                    method: 'POST',
                    body: fd
                });
                if (res.ok) {
                    alert("업로드 완료!");
                    refreshCurrentView();
                } else {
                    alert("업로드 실패");
                }
            } catch (e) {
                alert("서버 연결 오류");
            }
            // 입력창 초기화 (같은 파일 연속 업로드 가능하게)
            input.value = '';
        };
        window.selectItem = function (el, event) {
            const id = el.dataset.id;

            if (event && event.ctrlKey) {
                // Ctrl 키 누른 채 클릭: 다중 선택 토글
                if (state.selectedIds.has(id)) {
                    state.selectedIds.delete(id);
                    el.classList.remove('selected');
                } else {
                    state.selectedIds.add(id);
                    el.classList.add('selected');
                }
            } else {
                // 일반 클릭: 단일 선택
                document.querySelectorAll('.folder-item.selected').forEach(item => item.classList.remove('selected'));
                state.selectedIds.clear();
                state.selectedIds.add(id);
                el.classList.add('selected');
            }
            if (event) event.stopPropagation();
        };

        /* [추가] 항목 실행 처리 (더블 클릭) */
        window.handleItemDblClick = function (el) {
            const { id, name, type } = el.dataset;
            if (type === 'model') {
                // 제품 모델은 BOM/좌표 관리 화면으로 이동
                navigateTo('file_upload', { modelId: id, modelName: name });
            } else if (type === 'file') {
                // 업로드된 파일은 즉시 다운로드
                const downloadUrl = `http://127.0.0.1:5000/api/production/download/gen_${state.activeTab}_${name}`;
                window.location.href = downloadUrl;
            }
        };
        /* [전체 교체] 폴더/모델 목록 렌더링: 누락된 HTML 속성 및 내부 UI 복구 */
        async function renderRecursiveFolderView(data) {
            const { companyId, folderId, section } = data;
            const queryFolder = folderId ? folderId : '';
            const requestId = ++currentRequestId;
            const content = document.getElementById('sub-view-content');

            // [핵심] 데이터 로딩 전 화면 초기화
            content.innerHTML = '';

            try {
                // API 호출
                const res = await fetch(`http://127.0.0.1:5000/api/production/directory?company_id=${companyId}&folder_id=${queryFolder}&section=${section}`);
                if (requestId !== currentRequestId) return;
                if (!res.ok) throw new Error("Failed to fetch");

                const result = await res.json();
                let html = '';

                if (result.folders.length === 0 && result.models.length === 0) {
                    html += `<div style="text-align:center; color:#666; margin-top:50px;">비어 있음</div>`;
                } else {
                    html += `<div class="folder-grid">`;

                    // 1. 폴더 렌더링 (누락된 속성 및 디자인 복구)
                    result.folders.forEach(folder => {
                        const safeName = escapeHtml(folder.name);
                        html += `
                <div class="folder-item filter-target" onclick="enterSubFolder(this)" 
                     draggable="true" 
                     ondragstart="handleDragStart(event)" 
                     ondragend="handleDragEnd(event)" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)" 
                     ondrop="handleDrop(event)"
                     data-name="${safeName}" 
                     data-id="${folder.id}" 
                     data-type="folder" 
                     data-company-id="${companyId}" 
                     data-section="${section}">
                    <div class="folder-3d">
                        <div class="folder-back"></div>
                        <div class="paper"></div>
                        <div class="folder-front"></div>
                    </div>
                    <div class="folder-name">${safeName}</div>
                </div>`;
                    });

                    // 2. 모델/파일 렌더링 (누락된 속성 및 디자인 복구)
                    result.models.forEach(model => {
                        const safeName = escapeHtml(model.name);
                        const itemType = model.type;
                        // 파일 확장자에 맞는 아이콘 가져오기
                        const iconClass = (itemType === 'file') ? getFileIcon(safeName) : 'uil-layer-group';

                        html += `
                <div class="folder-item filter-target" onclick="selectItem(this, event)" ondblclick="handleItemDblClick(this)"
                     draggable="true" 
                     ondragstart="handleDragStart(event)"
                     ondragend="handleDragEnd(event)"
                     data-name="${safeName}" 
                     data-id="${model.id}" 
                     data-type="${itemType}" 
                     data-company-id="${companyId}" 
                     data-section="${section}">
                    <div class="file-icon-wrapper">
                        <i class="uil ${iconClass} file-type-icon"></i>
                    </div>
                    <div class="folder-name">${safeName}</div>
                </div>`;
                    });
                    html += `</div>`;
                }
                content.innerHTML = html;

                // 애니메이션 효과 적용
                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(".folder-item",
                        { opacity: 0, y: 20 },
                        { opacity: 1, y: 0, stagger: 0.05, ease: "power2.out", clearProps: "transform" }
                    );
                }
            } catch (e) {
                if (requestId === currentRequestId) {
                    content.innerHTML = `<div style="text-align:center; padding:20px; color:#ff6b6b;">로드 실패</div>`;
                }
            }
        }
        /* [신규 추가] Drag & Drop 핸들러 로직 */
        window.handleDragEnd = function (e) {
            document.querySelectorAll('.folder-item').forEach(el => {
                el.classList.remove('dragging');
                el.style.opacity = '';
            });
        };

        window.handleDragStart = function (e) {
            const item = e.currentTarget;
            const itemId = item.dataset.id;

            // 만약 선택되지 않은 아이템을 드래그 시작하면, 기존 선택을 다 풀고 얘만 선택
            if (!state.selectedIds.has(itemId)) {
                document.querySelectorAll('.folder-item.selected').forEach(i => i.classList.remove('selected'));
                state.selectedIds.clear();
                state.selectedIds.add(itemId);
                item.classList.add('selected');
            }

            const dragData = {
                ids: Array.from(state.selectedIds), // 다중 ID 리스트
                type: item.dataset.type,
                count: state.selectedIds.size
            };

            e.dataTransfer.setData("text/plain", JSON.stringify(dragData));
            e.dataTransfer.effectAllowed = "move";

            // 드래그 중인 원본 아이템들 반투명 처리 (지연 실행)
            setTimeout(() => {
                document.querySelectorAll('.folder-item.selected').forEach(i => i.classList.add('dragging'));
            }, 0);
        };
        // 폴더 위로 드래그 중일 때 (Drop 허용)
        window.handleDragOver = function (e) {
            e.preventDefault(); // 필수: 브라우저 기본 동작 방지
            const folder = e.currentTarget;
            if (folder.dataset.type === 'folder') {
                folder.classList.add('drag-over'); // 폴더 강조 표시
                e.dataTransfer.dropEffect = "move";
            }
        };

        // 폴더 영역을 벗어날 때
        window.handleDragLeave = function (e) {
            e.currentTarget.classList.remove('drag-over');
        };

        window.handleDrop = async function (e) {
            e.preventDefault();
            e.stopPropagation();

            const targetFolder = e.currentTarget;
            targetFolder.classList.remove('drag-over');

            const dataRaw = e.dataTransfer.getData("text/plain");
            if (!dataRaw) return;

            const dragData = JSON.parse(dataRaw);
            const targetFolderId = targetFolder.dataset.id;

            if (dragData.type === 'folder') return;

            // [중요] 확인창에서 취소 시, 아무것도 하지 않고 함수 종료 (새로고침 금지)
            if (!confirm(`${dragData.count}개의 항목을 '${targetFolder.dataset.name}' 폴더로 이동하시겠습니까?`)) {
                return;
            }

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'move',
                        model_ids: dragData.ids,
                        target_folder_id: targetFolderId
                    })
                });

                if (res.ok) {
                    state.selectedIds.clear(); // 성공 시에만 선택 초기화
                    refreshCurrentView();      // 성공 시에만 목록 갱신
                } else {
                    alert("이동 처리 중 오류가 발생했습니다.");
                }
            } catch (err) {
                alert("서버 통신 오류");
            }
        };

        /* [추가/수정] 클릭 시 모델 뷰 진입 또는 파일 다운로드 분기 */
        window.handleItemClick = function (el) {
            const { id, name, type, companyId } = el.dataset;

            if (type === 'model') {
                // 제품 모델: 기존처럼 BOM/좌표 등록 화면으로 이동
                navigateTo('file_upload', { modelId: id, modelName: name });
            } else {
                // 일반 파일: BOM/좌표 등록 없이 바로 다운로드 실행
                // 파일 업로드 시 저장된 실제 파일명을 서버 API를 통해 호출 (예시 규칙 적용)
                const downloadUrl = `http://127.0.0.1:5000/api/production/download/gen_${state.activeTab}_${name}`;
                window.location.href = downloadUrl;
            }
        };

        window.enterSubFolder = (el) => {
            const compId = el.dataset.companyId;
            const folderId = el.dataset.id;
            const name = el.dataset.name;
            const section = el.dataset.section;
            navigateTo('folder_view', { companyId: compId, folderId: folderId, name: name, section: section });
        };

        window.enterModel = (el) => {
            const modelId = el.dataset.id;
            const modelName = el.dataset.name;
            navigateTo('file_upload', { modelId: modelId, modelName: modelName });
        };

        function renderFileUploadUI(modelId, modelName) {
            const content = document.getElementById('sub-view-content');
            const safeModelName = escapeHtml(modelName);
            content.innerHTML = `
            <div style="text-align:center; margin-bottom:20px; font-size:1.2rem; color:var(--point-gold);">${safeModelName} 데이터 관리</div>
            <div class="file-manage-container">
                <div class="file-drop-zone" id="zone-bom">
                    <i class="uil uil-list-ul zone-icon"></i><div class="zone-title">BOM 파일</div>
                    <div class="zone-desc">엑셀(.xlsx) 또는 CSV 파일을 등록하세요.</div>
                    <input type="file" id="file-bom" hidden onchange="handleFileSelect(this, 'bom', ${modelId})">
                    <button class="action-btn" onclick="document.getElementById('file-bom').click()">파일 선택</button>
                    <div class="current-file-info" id="info-bom">로딩 중...</div>
                </div>
                <div class="file-drop-zone" id="zone-coord">
                    <i class="uil uil-crosshair zone-icon"></i><div class="zone-title">좌표 데이터</div>
                    <div class="zone-desc">마운터 좌표 데이터를 등록하세요.</div>
                    <input type="file" id="file-coord" hidden onchange="handleFileSelect(this, 'coord', ${modelId})">
                    <button class="action-btn" onclick="document.getElementById('file-coord').click()">파일 선택</button>
                    <div class="current-file-info" id="info-coord">로딩 중...</div>
                </div>
            </div>`;
            loadFileInfo(modelId, 'BOM'); loadFileInfo(modelId, 'COORDINATE');
        }

        /* [전체 교체] 담당자 목록 렌더링: 잔상 제거 */
        async function renderManagerList() {
            const content = document.getElementById('sub-view-content');
            if (!content) return;

            // [핵심] API 호출 전 컨텐츠 비우기
            content.innerHTML = '';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/managers`);
                if (!res.ok) throw new Error("API 응답 오류");
                const items = await res.json();

                const groups = {};
                items.forEach(item => {
                    const dept = item.department || "기타";
                    if (!groups[dept]) groups[dept] = [];
                    groups[dept].push(item);
                });

                let html = `<div class="dept-columns-container" style="display: flex; gap: 20px; align-items: flex-start; padding: 10px 0; width: 100%; overflow-x: auto; overflow-y: hidden;">`;
                const deptOrder = ["생산", "품질", "기능", "관리"];

                deptOrder.forEach(dept => {
                    const managers = groups[dept] || [];
                    html += `
            <div class="dept-column" style="flex: 1; min-width: 220px; background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px; border: 1px solid rgba(255,235,167,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <div class="dept-header" style="width: 100%; margin-bottom: 15px; border-bottom: 2px solid var(--point-gold); padding-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--point-gold); font-weight: bold; font-size: 0.95rem;">
                    <i class="uil uil-label"></i> ${dept} 부서
                </div>
                <div class="dept-manager-list" style="display: flex; flex-direction: column; gap: 10px;">`;

                    if (managers.length === 0) {
                        html += `<div style="text-align:center; color:#555; font-size:0.8rem; padding:20px;">인원 없음</div>`;
                    } else {
                        managers.forEach((item, index) => {
                            const rank = item.position || "사원";
                            const safeName = escapeHtml(item.name);
                            const isDeptTop = (index === 0);
                            let gradient = (dept === '생산') ? 'linear-gradient(135deg, #6a89cc, #4a69bd)' :
                                (dept === '품질') ? 'linear-gradient(135deg, #00e676, #00c853)' :
                                    (dept === '기능') ? 'linear-gradient(135deg, #f0932b, #edae49)' :
                                        (dept === '관리') ? 'linear-gradient(135deg, #a29bfe, #6c5ce7)' : 'linear-gradient(135deg, #636e72, #2d3436)';
                            const borderStyle = isDeptTop ? 'outline: 2px solid var(--point-gold); outline-offset: 2px;' : '';

                            html += `
                    <div class="folder-item filter-target" onclick="openManagerModal(${item.id})" 
                         data-id="${item.id}" data-name="${safeName}" data-type="manager" 
                         style="width: 100%; display: flex; flex-direction: row; gap: 12px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 8px; justify-content: flex-start; align-items: center; transition: all 0.2s;">
                        <div style="position: relative; flex-shrink: 0;">
                            ${isDeptTop ? `<div class="rank-badge" style="position: absolute; top: -5px; right: -5px; background: var(--point-gold); color: #1a1b21; font-size: 0.55rem; padding: 1px 4px; border-radius: 3px; font-weight: 800; z-index: 10;"><i class="uil uil-star"></i></div>` : ''}
                            <div class="file-icon-wrapper manager-circle-wrapper" 
                                 style="background: ${gradient}; border-radius: 50%; width: 40px; height: 40px; 
                                        display: flex; align-items: center; justify-content: center; margin-bottom: 0; 
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.3); ${borderStyle}">
                                <i class="uil uil-user" style="font-size: 1.4rem; color: #fff;"></i>
                            </div>
                        </div>
                        <div style="text-align: left; overflow: hidden; flex: 1;">
                            <div class="folder-name" style="text-align: left; font-size: 0.9rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; color: #fff; text-shadow: none;">${safeName}</div>
                            <div style="font-size: 0.7rem; color: #aaa;">${rank}</div>
                        </div>
                    </div>`;
                        });
                    }
                    html += `</div></div>`;
                });
                html += `</div>`;
                content.innerHTML = html;

                if (typeof gsap !== 'undefined') {
                    gsap.fromTo(".dept-column",
                        { opacity: 0, y: 15 },
                        { duration: 0.5, opacity: 1, y: 0, stagger: 0.1, ease: "power2.out", clearProps: "transform" }
                    );
                    gsap.fromTo(".dept-column .folder-item",
                        { opacity: 0 },
                        { duration: 0.4, opacity: 1, delay: 0.1, stagger: 0.05, clearProps: "transform" }
                    );
                }
            } catch (e) {
                content.innerHTML = `<div style="text-align:center; padding:50px; color:#ff4444;">데이터 로드 오류</div>`;
            }
        }

        /* [전체 교체] 부서별 역할 데이터 정의 */
        function updateRoleOptions(selectedRoles = "") {
            const dept = document.getElementById('mgr-dept').value;
            const container = document.getElementById('mgr-role-container');

            // [순서 수정] 생산 -> 품질 -> 기능 -> 관리
            const roleData = {
                '생산': ['SMT', 'DIP'],
                '품질': ['육안검사', '비전검사', '기능검사', '불량수리'],
                '기능': ['IMG/MAC', '기능검사', '출하검사'],
                '관리': ['생산관리', '품질관리', '경영관리']
            };

            const selectedArray = selectedRoles.split(',').map(r => r.trim());

            if (roleData[dept]) {
                container.innerHTML = roleData[dept].map(role => `
            <label class="check-item">
                <input type="checkbox" name="mgr-role" value="${role}" ${selectedArray.includes(role) ? 'checked' : ''}> ${role}
            </label>
        `).join('');
            } else {
                container.innerHTML = '<span style="color:#666; font-size:0.8rem;">부서를 먼저 선택하세요.</span>';
            }
        }

        /* [전체 교체] 담당자 모달 열기 (추가/수정 통합) */
        async function openManagerModal(id = null) {
            const modal = document.getElementById('manager-info-modal');
            const title = modal.querySelector('.modal-header h3');
            const nameInput = document.getElementById('mgr-name');
            const idInput = document.getElementById('mgr-edit-id');

            // 초기화
            idInput.value = id || "";
            nameInput.value = "";
            document.getElementById('mgr-position').value = "";
            document.getElementById('mgr-dept').value = "";
            document.getElementById('mgr-contact').value = "";
            document.getElementById('mgr-email').value = "";
            updateRoleOptions(""); // 역할 선택박스 초기화

            if (id) {
                // [수정 모드] 데이터 로드
                title.textContent = "담당자 정보 수정";
                try {
                    const res = await fetch(`http://127.0.0.1:5000/api/production/managers`);
                    const managers = await res.json();
                    const mgr = managers.find(m => m.id == id);
                    if (!mgr) return;

                    nameInput.value = mgr.name;
                    document.getElementById('mgr-position').value = mgr.position || "";
                    document.getElementById('mgr-dept').value = mgr.department || "";
                    document.getElementById('mgr-contact').value = mgr.contact || "";
                    document.getElementById('mgr-email').value = mgr.email || "";
                    updateRoleOptions(mgr.roles || "");
                } catch (e) { console.error("Load Error:", e); }
            } else {
                // [추가 모드]
                title.textContent = "새 담당자 등록";
            }

            modal.classList.add('visible');
        }
        let isMarqueeDrawing = false;
        let marqueeStart = { x: 0, y: 0 };
        let marqueeEl = null;

        document.addEventListener('mousedown', function (e) {
            if (e.button !== 0 || e.target.closest('.folder-item') || e.target.closest('.modal-window')) return;
            if (!e.target.closest('#view-container')) return;

            isMarqueeDrawing = true;
            marqueeStart = { x: e.pageX, y: e.pageY };

            // [윈도우 방식] 새로운 드래그 시작 시 기존 선택을 모두 해제 (Persistence의 시작)
            state.selectedIds.clear();
            document.querySelectorAll('.folder-item.selected').forEach(el => el.classList.remove('selected'));

            marqueeEl = document.createElement('div');
            marqueeEl.className = 'selection-marquee';
            document.body.appendChild(marqueeEl);
        });

        // [Persisted Logic] 마우스가 움직일 때만 실시간으로 class를 붙임
        document.addEventListener('mousemove', function (e) {
            if (!isMarqueeDrawing || !marqueeEl) return;
            updateMarqueeBox(e.pageX, e.pageY);

            const boxRect = marqueeEl.getBoundingClientRect();
            const items = document.querySelectorAll('.folder-item');

            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const id = item.dataset.id;

                const isIntersecting = !(
                    boxRect.right < itemRect.left ||
                    boxRect.left > itemRect.right ||
                    boxRect.bottom < itemRect.top ||
                    boxRect.top > itemRect.bottom
                );

                if (isIntersecting) {
                    state.selectedIds.add(id);
                    item.classList.add('selected'); // 하이라이트 적용
                } else {
                    state.selectedIds.delete(id);
                    item.classList.remove('selected'); // 범위 벗어나면 제거
                }
            });
        });

        // 마우스 이동
        document.addEventListener('mousemove', function (e) {
            if (!isMarqueeDrawing || !marqueeEl) return;
            updateMarqueeBox(e.pageX, e.pageY);
            checkMarqueeCollision(); // 실시간 선택 반영
        });

        // 마우스 업
        document.addEventListener('mouseup', function (e) {
            if (isMarqueeDrawing) {
                isMarqueeDrawing = false;
                if (marqueeEl) {
                    marqueeEl.remove();
                    marqueeEl = null;
                }
            }
        });

        function updateMarqueeBox(currentX, currentY) {
            const width = Math.abs(currentX - marqueeStart.x);
            const height = Math.abs(currentY - marqueeStart.y);
            const left = Math.min(currentX, marqueeStart.x);
            const top = Math.min(currentY, marqueeStart.y);

            marqueeEl.style.width = `${width}px`;
            marqueeEl.style.height = `${height}px`;
            marqueeEl.style.left = `${left}px`;
            marqueeEl.style.top = `${top}px`;
        }

        // 충돌 감지 및 선택 처리
        function checkMarqueeCollision() {
            if (!marqueeEl) return;
            const boxRect = marqueeEl.getBoundingClientRect();
            const items = document.querySelectorAll('.folder-item');

            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const id = item.dataset.id;

                // 교차 여부 확인
                const isIntersecting = !(
                    boxRect.right < itemRect.left ||
                    boxRect.left > itemRect.right ||
                    boxRect.bottom < itemRect.top ||
                    boxRect.top > itemRect.bottom
                );

                if (isIntersecting) {
                    if (!state.selectedIds.has(id)) {
                        state.selectedIds.add(id);
                        item.classList.add('selected');
                    }
                } else {
                    // 박스 밖으로 나가면 선택 해제 (윈도우 탐색기 방식)
                    if (state.selectedIds.has(id)) {
                        state.selectedIds.delete(id);
                        item.classList.remove('selected');
                    }
                }
            });
        }

        function closeMgrModal() { document.getElementById('manager-info-modal').classList.remove('visible'); }

        /* [전체 교체] 담당자 정보 저장 (추가/수정 통합) */
        async function saveManagerInfo() {
            const id = document.getElementById('mgr-edit-id').value;
            const name = document.getElementById('mgr-name').value.trim();
            const position = document.getElementById('mgr-position').value;
            const department = document.getElementById('mgr-dept').value;
            const contact = document.getElementById('mgr-contact').value;
            const email = document.getElementById('mgr-email').value;

            const roleElements = document.querySelectorAll('input[name="mgr-role"]:checked');
            const roles = Array.from(roleElements).map(el => el.value).join(', ');

            if (!name) {
                alert("성명을 입력해 주세요.");
                return;
            }

            // ID 유무에 따라 POST(추가) 또는 PUT(수정) 결정
            const method = id ? 'PUT' : 'POST';
            const url = id
                ? `http://127.0.0.1:5000/api/production/managers/${id}`
                : `http://127.0.0.1:5000/api/production/managers`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, position, department, roles, contact, email })
                });

                if (res.ok) {
                    alert(id ? "정보가 수정되었습니다." : "새 담당자가 등록되었습니다.");
                    closeMgrModal();
                    renderManagerList();
                } else {
                    const err = await res.json();
                    alert(`실패: ${err.error || '알 수 없는 오류'}`);
                }
            } catch (e) { alert("서버 통신 오류"); }
        }
        // ================= Action Functions =================
        async function addCompany() {
            const v = document.getElementById('new-comp-name').value;
            if (!v) return;
            try {
                await fetch(`http://127.0.0.1:5000/api/production/companies`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: v }) });
                renderCompanyFolderList('common');
            } catch (e) { alert('추가 실패'); }
        }

        /* [전체 교체] 중복 정의 금지 - 매개변수 name을 받는 버전 하나만 사용 */
        async function addManager(name) {
            if (!name) return;
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/managers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                if (res.ok) {
                    renderManagerList();
                } else {
                    const err = await res.json();
                    alert(`추가 실패: ${err.error || '알 수 없는 오류'}`);
                }
            } catch (e) { alert("서버 통신 오류"); }
        }

        async function handleFileSelect(input, typeCode, modelId) {
            const file = input.files[0]; if (!file) return;
            const fd = new FormData(); fd.append('file', file); fd.append('type', typeCode === 'bom' ? 'BOM' : 'COORDINATE');
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/${modelId}/data`, { method: 'POST', body: fd });
                if (res.ok) { alert('업로드 완료'); loadFileInfo(modelId, typeCode === 'bom' ? 'BOM' : 'COORDINATE'); } else alert('실패');
            } catch (e) { alert('에러'); }
        }

        async function loadFileInfo(modelId, type) {
            const typeCode = type === 'BOM' ? 'bom' : 'coord';
            const infoDiv = document.getElementById(`info-${typeCode}`);
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/${modelId}/data?type=${type}`);
                const data = await res.json();
                if (data.length > 0) {
                    const safeFileName = escapeHtml(data[0].fileName);
                    infoDiv.innerHTML = `<div style="font-size:0.8rem; color:#fff;"><i class="uil uil-check-circle" style="color:#00e676;"></i> ${safeFileName}</div>
                <a href="http://127.0.0.1:5000/api/production/download/${data[0].content}" class="small-btn" style="background:rgba(255,255,255,0.1); color:#ccc; text-decoration:none; display:flex; align-items:center;"><i class="uil uil-download-alt"></i></a>`;
                } else infoDiv.innerHTML = `<span style="color:#666; font-size:0.8rem;">파일 없음</span>`;
            } catch (e) {
                infoDiv.innerHTML = `<span style="color:#ff6b6b; font-size:0.8rem;">Error</span>`;
            }
        }

        function formatContact(el) {
            let val = el.value.replace(/[^0-9]/g, ''); // 숫자만 남기기
            let result = '';

            if (val.length < 4) {
                result = val;
            } else if (val.length < 7) {
                result = val.substr(0, 3) + '-' + val.substr(3);
            } else if (val.length < 11) {
                result = val.substr(0, 3) + '-' + val.substr(3, 3) + '-' + val.substr(6);
            } else {
                result = val.substr(0, 3) + '-' + val.substr(3, 4) + '-' + val.substr(7);
            }
            el.value = result;
        }
        document.addEventListener('input', (e) => {
            if (e.target.id === 'mgr-contact') formatContact(e.target);
        });

        /* [전체 교체] 우클릭 이벤트 리스너: 감지 범위를 view-container로 확장 */
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();

            // 1. 개별 아이템(폴더, 모델, 담당자 등) 위에서 우클릭했는지 확인
            const folderItem = e.target.closest('.folder-item');

            // 2. [수정] 감지 범위를 .view-section에서 #view-container로 확장
            const viewArea = e.target.closest('#view-container');

            if (folderItem) {
                // 아이템 우클릭 모드
                const { id, name, type, companyId, section } = folderItem.dataset;
                targetItemData = { id, name, type, companyId, section };
                showContextMenu(e.pageX, e.pageY, 'item');
            } else if (viewArea) {
                // [수정] 배경 우클릭 모드: view-container 내부 어디서든 발동
                targetItemData = null;
                // 메뉴 표시 여부는 showContextMenu 내부의 html 생성 로직에 따라 결정됨
                showContextMenu(e.pageX, e.pageY, 'bg');
            } else {
                // 영역 밖 클릭 시 메뉴 숨김
                if (contextMenu) contextMenu.style.display = 'none';
            }
        });

        document.addEventListener('click', () => { if (contextMenu) contextMenu.style.display = 'none'; });
        /* [전체 교체] 컨텍스트 메뉴: 자유 탭 루트 지원 */
        function showContextMenu(x, y, mode) {
            let html = '';
            const lastPath = state.currentPath.length > 0 ? state.currentPath[state.currentPath.length - 1] : null;
            const isFreeTabRoot = state.activeTab !== 'management' && state.currentPath.length === 0;

            if (mode === 'item') {
                const isManager = targetItemData.type === 'manager';
                const isModel = targetItemData.type === 'model';
                const canRename = ['company', 'folder', 'model', 'file'].includes(targetItemData.type); // file 추가
                const openLabel = isManager ? '정보 수정' : '열기';

                html = `<div class="ctx-item" onclick="handleCtxOpen()"><i class="uil uil-pen"></i> ${openLabel}</div>`;
                if (canRename) html += `<div class="ctx-item" onclick="handleCtxRename()"><i class="uil uil-edit"></i> 이름 변경</div>`;

                if (isModel || targetItemData.type === 'file') {
                    html += `<div class="ctx-item" onclick="handleCtxCopy()"><i class="uil uil-copy"></i> 복사</div>
                     <div class="ctx-item" onclick="handleCtxCut()"><i class="uil uil-scissors-line"></i> 잘라내기</div>`;
                }
                html += `<div class="ctx-divider"></div><div class="ctx-item" style="color:#ff4444;" onclick="handleCtxDelete()"><i class="uil uil-trash-alt"></i> 삭제</div>`;

            } else if (mode === 'bg') {
                // 1. 통합 관리 탭의 업체 목록 화면
                if (state.activeTab === 'management' && lastPath && lastPath.id === 'company_manager') {
                    html = `<div class="ctx-item" onclick="handleCtxAdd('company')"><i class="uil uil-building"></i> 새 업체 추가</div>`;
                }
                // 2. 통합 관리 - 담당자 관리 화면
                else if (state.activeTab === 'management' && lastPath && lastPath.id === 'manager_manager') {
                    html = `<div class="ctx-item" onclick="handleCtxAdd('manager')"><i class="uil uil-user-plus"></i> 새 담당자 추가</div>`;
                }
                // 3. [수정] 일반 폴더 내부 또는 자유 탭의 루트 화면 (업체 ID 없어도 됨)
                else if ((lastPath && lastPath.folderId !== undefined) || isFreeTabRoot) {
                    html = `
                <div class="ctx-item" onclick="handleCtxAdd('folder')"><i class="uil uil-folder-plus"></i> 새 폴더 추가</div>
                <div class="ctx-item" onclick="handleCtxAdd('model')"><i class="uil uil-file-plus-alt"></i> 새 모델/파일 추가</div>
                <div class="ctx-item" onclick="document.getElementById('general-upload-input').click()">
                    <i class="uil uil-upload"></i> 파일 업로드 (MAX 50MB)
                </div>
                <input type="file" id="general-upload-input" style="display:none" onchange="handleGeneralUpload(this)">`;

                    if (state.clipboard.id) {
                        html += `<div class="ctx-divider"></div>
                         <div class="ctx-item" onclick="handleCtxPaste()"><i class="uil uil-clipboard-notes"></i> 붙여넣기 (${state.clipboard.name})</div>`;
                    }
                }
            }

            if (html && contextMenu) {
                contextMenu.innerHTML = html;
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
            } else if (contextMenu) {
                contextMenu.style.display = 'none';
            }
        }

        window.handleCtxAdd = async function (addType) {
            if (addType === 'manager') {
                openManagerModal();
                return;
            }

            const labelMap = { 'folder': '폴더', 'model': '모델', 'company': '업체' };
            const label = labelMap[addType] || '항목';
            const name = prompt(`새 ${label} 이름을 입력하세요:`);
            if (!name) return;

            // 현재 경로 확인
            const last = state.currentPath.length > 0 ? state.currentPath[state.currentPath.length - 1] : null;

            // [핵심 수정] 현재 경로에 지정된 섹션이 있다면 그것을 사용 ('common' 등), 없으면 탭 이름 사용
            const currentSection = (last && last.section) ? last.section : state.activeTab;

            const companyId = last ? last.companyId : null;
            const folderId = last ? last.folderId : null;

            let url = '';
            let body = { name: name, section: currentSection }; // 수정된 섹션 사용

            if (addType === 'company') {
                url = `http://127.0.0.1:5000/api/production/companies`;
            } else if (addType === 'folder') {
                url = `http://127.0.0.1:5000/api/production/folders`;
                body.company_id = companyId;
                body.parent_folder_id = folderId;
            } else if (addType === 'model') {
                url = `http://127.0.0.1:5000/api/production/models`;
                body.company_id = companyId;
                body.folder_id = folderId;
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    // 성공 시 새로고침
                    if (addType === 'company') {
                        renderCompanyFolderList(currentSection);
                    } else {
                        refreshCurrentView();
                    }
                } else {
                    const err = await res.json();
                    alert(`생성 실패: ${err.error || '알 수 없는 오류'}`);
                }
            } catch (e) {
                alert('서버와 통신 중 오류가 발생했습니다.');
            }
        };

        /* [전체 교체] 컨텍스트 메뉴에서 열기/수정 액션 실행 */
        window.handleCtxOpen = function () {
            if (!targetItemData) return;
            const sec = targetItemData.section || 'production';

            if (targetItemData.type === 'manager') {
                // 기존 openManagerInfoModal 대신 통합된 openManagerModal 호출
                openManagerModal(targetItemData.id);
            } else if (targetItemData.type === 'company') {
                navigateTo('folder_view', { companyId: targetItemData.id, folderId: null, name: targetItemData.name, section: sec });
            } else if (targetItemData.type === 'folder') {
                navigateTo('folder_view', { companyId: targetItemData.companyId, folderId: targetItemData.id, name: targetItemData.name, section: sec });
            } else if (targetItemData.type === 'model') {
                navigateTo('file_upload', { modelId: targetItemData.id, modelName: targetItemData.name });
            }
        };

        window.handleCtxRename = async function () {
            if (!targetItemData) return;
            const newName = prompt('새 이름을 입력하세요:', targetItemData.name);
            if (!newName || newName === targetItemData.name) return;

            let endpoint = '';
            if (targetItemData.type === 'company') endpoint = 'companies';
            else if (targetItemData.type === 'folder') endpoint = 'folders';
            else if (targetItemData.type === 'model') endpoint = 'models';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/${endpoint}/${targetItemData.id}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newName })
                });
                if (res.ok) refreshCurrentView(); else alert('수정 실패');
            } catch (e) { alert('오류 발생'); }
        };

        /* [수정] refreshCurrentView: 루트 경로에서도 새로고침 동작하도록 수정 */
        function refreshCurrentView() {
            const lastPath = state.currentPath.length > 0 ? state.currentPath[state.currentPath.length - 1] : null;

            if (lastPath) {
                // 기존: 하위 폴더나 특정 화면에 들어가 있는 경우
                if (lastPath.id === 'company_manager') {
                    renderCompanyFolderList(lastPath.section);
                }
                else if (lastPath.id === 'manager_manager') {
                    renderManagerList();
                }
                else {
                    renderRecursiveFolderView(lastPath);
                }
            } else {
                // [추가] 경로가 없는 루트 화면인 경우 (생산/검사/기능 탭의 최상위)
                if (state.activeTab !== 'management') {
                    // 현재 탭의 루트 폴더 다시 렌더링
                    renderRecursiveFolderView({ section: state.activeTab, folderId: null, companyId: null });
                } else {
                    // 통합 관리 탭 루트는 대시보드이므로 필요시 초기화 (일반적으로는 불필요)
                    // renderRootView(); 
                }
            }
        }

        /* [수정] handleCtxDelete: 삭제 완료 알림 추가 및 새로고침 보장 */
        window.handleCtxDelete = async function () {
            if (!targetItemData) return;
            if (!confirm(`'${targetItemData.name}'을(를) 삭제하시겠습니까?`)) return;

            let endpoint = '';
            if (targetItemData.type === 'company') endpoint = 'companies';
            else if (targetItemData.type === 'folder') endpoint = 'folders';
            else if (targetItemData.type === 'model') endpoint = 'models';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/${endpoint}/${targetItemData.id}`, { method: 'DELETE' });

                if (res.ok) {
                    // 클립보드 정리
                    if (state.clipboard.id === targetItemData.id) {
                        state.clipboard = { action: null, type: null, id: null, name: null };
                    }
                    alert('삭제되었습니다.'); // [추가] 삭제 완료 알림
                    refreshCurrentView();     // [확인] 위에서 수정한 함수가 호출됨
                } else {
                    alert('삭제 실패');
                }
            } catch (e) { alert('오류 발생'); }
        };

        // [추가] 복사/잘라내기/붙여넣기 로직
        window.handleCtxCopy = function () {
            state.clipboard = { action: 'copy', type: 'model', id: targetItemData.id, name: targetItemData.name };
            alert(`'${targetItemData.name}' 모델을 복사했습니다.`);
        };

        window.handleCtxCut = function () {
            state.clipboard = { action: 'cut', type: 'model', id: targetItemData.id, name: targetItemData.name };
            alert(`'${targetItemData.name}' 모델을 잘라냈습니다.`);
        };

        window.handleCtxPaste = async function () {
            // 1. 클립보드가 비어있는지 먼저 확인
            if (!state.clipboard.id) {
                alert("붙여넣을 항목이 없습니다. 원본 파일이 삭제되었을 수 있습니다.");
                return;
            }

            const last = state.currentPath[state.currentPath.length - 1];
            const targetFolderId = last.folderId;

            const body = {
                action: state.clipboard.action === 'copy' ? 'copy' : 'move',
                model_id: state.clipboard.id,
                target_folder_id: targetFolderId
            };

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert('작업이 완료되었습니다.');
                    if (state.clipboard.action === 'cut') {
                        state.clipboard = { action: null, type: null, id: null, name: null };
                    }
                    refreshCurrentView();
                } else {
                    // [보정] 서버 에러 발생 시 처리
                    const errData = await res.json();
                    if (res.status === 404) {
                        alert("원본 파일을 찾을 수 없습니다. 이미 삭제되었거나 이동된 파일입니다.");
                        state.clipboard = { action: null, type: null, id: null, name: null }; // 클립보드 강제 초기화
                    } else {
                        alert(`실패: ${errData.error || '알 수 없는 오류'}`);
                    }
                }
            } catch (e) {
                alert('서버 통신 오류');
            }
        };



        // [수정] 탭 전체 대상 전역 검색 기능
        let searchTimer;
        window.filterFolderItems = function () {
            clearTimeout(searchTimer);
            const query = document.getElementById('folder-search').value.trim();

            // 검색어가 없으면 현재 폴더 뷰로 복구
            if (query.length === 0) {
                refreshCurrentView();
                return;
            }

            // 성능을 위해 타이핑 멈춤 감지 후 검색 (300ms)
            searchTimer = setTimeout(async () => {
                const content = document.getElementById('sub-view-content');
                content.innerHTML = '<div style="text-align:center; padding:50px; color:#666;"><i class="uil uil-search uil-spin" style="font-size:2rem;"></i><br>탭 전체 검색 중...</div>';

                try {
                    const res = await fetch(`http://127.0.0.1:5000/api/production/search?section=${state.activeTab}&query=${encodeURIComponent(query)}`);
                    const result = await res.json();

                    // 검색 결과 렌더링 (기존 렌더링 로직 재활용)
                    renderSearchResults(result, query);
                } catch (e) {
                    content.innerHTML = '<div style="text-align:center; color:#ff4444;">검색 중 오류가 발생했습니다.</div>';
                }
            }, 300);
        };

        // [추가] 검색 결과 전용 렌더링 함수
        function renderSearchResults(result, query) {
            const content = document.getElementById('sub-view-content');
            let html = `<div style="margin-bottom:20px; color:var(--point-gold); font-size:0.9rem;"><i class="uil uil-search"></i> '${query}' 검색 결과</div>`;

            if (result.folders.length === 0 && result.models.length === 0) {
                html += `<div style="text-align:center; color:#666; margin-top:50px;">검색 결과가 없습니다.</div>`;
            } else {
                html += `<div class="folder-grid">`;
                result.folders.forEach(f => {
                    html += `
            <div class="folder-item" onclick="enterSubFolder(this)" data-id="${f.id}" data-name="${f.name}" data-type="folder" data-company-id="${f.company_id}" data-section="${f.section}">
                <div class="folder-3d"><div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div></div>
                <div class="folder-name">${escapeHtml(f.name)}</div>
            </div>`;
                });
                result.models.forEach(m => {
                    html += `
            <div class="folder-item" onclick="enterModel(this)" data-id="${m.id}" data-name="${m.name}" data-type="model" data-company-id="${m.company_id}">
                <div class="file-icon-wrapper"><i class="uil uil-layer-group file-type-icon"></i></div>
                <div class="folder-name">${escapeHtml(m.name)}</div>
            </div>`;
                });
                html += `</div>`;
            }
            content.innerHTML = html;
            gsap.from(".folder-item", { scale: 0.8, opacity: 0, stagger: 0.05 });
        }

        function setupEvents() {
            document.getElementById('back-btn').addEventListener('click', () => { if (state.currentPath.length > 0) goBackLevel(); else history.back(); });
            document.getElementById('home-btn').addEventListener('click', () => location.href = 'index.html');
            document.getElementById('forward-btn').addEventListener('click', () => history.forward());
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
    </script>
    <div id="manager-info-modal" class="modal-overlay">
        <div class="modal-window manager-fit-modal">
            <div class="modal-header">
                <h3>담당자 정보</h3>
                <button class="close-btn" onclick="closeMgrModal()">&times;</button>
            </div>
            <div class="modal-body center-align-body">
                <input type="hidden" id="mgr-edit-id">

                <div class="input-group" style="width:100%">
                    <label>성명</label>
                    <input type="text" id="mgr-name" class="luxury-input" placeholder="성명을 입력하세요">
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>직급</label>
                        <select id="mgr-position" class="luxury-input">
                            <option value="">선택</option>
                            <option value="사원">사원</option>
                            <option value="주임">주임</option>
                            <option value="대리">대리</option>
                            <option value="과장">과장</option>
                            <option value="차장">차장</option>
                            <option value="부장">부장</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>부서</label>
                        <select id="mgr-dept" class="luxury-input" onchange="updateRoleOptions()">
                            <option value="">선택</option>
                            <option value="생산">생산</option>
                            <option value="품질">품질</option>
                            <option value="기능">기능</option>
                            <option value="관리">관리</option>
                        </select>
                    </div>
                </div>

                <div class="input-group" style="width:100%">
                    <label>역할 (중복 선택)</label>
                    <div id="mgr-role-container" class="checkbox-grid">
                        <span style="color:#666; font-size:0.8rem;">부서를 먼저 선택하세요.</span>
                    </div>
                </div>

                <div class="input-group" style="width:100%">
                    <label>연락처</label>
                    <input type="text" id="mgr-contact" class="luxury-input" placeholder="010-0000-0000">
                </div>
                <div class="input-group" style="width:100%">
                    <label>이메일</label>
                    <input type="email" id="mgr-email" class="luxury-input" placeholder="example@email.com">
                </div>
                <div class="modal-footer center-footer">
                    <button class="action-btn cancel" onclick="closeMgrModal()">
                        <i class="uil uil-times"></i> 취소
                    </button>
                    <button class="action-btn save" onclick="saveManagerInfo()">
                        <i class="uil uil-check"></i> 저장하기
                    </button>
                </div>
            </div>
        </div>
</body>

</html>
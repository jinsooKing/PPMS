<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - 공정 기준정보 관리</title>
    
    <link rel="stylesheet" href="common.css">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/bmdohyeon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="auth.js"></script>
    <script src="logo.js"></script>

    <style>
        /* [Global] */
        * { font-weight: bold !important; box-sizing: border-box; }
        body { overflow: hidden; background-color: #1a1b21; font-family: 'BMDOHYEON', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        .page-container { position: relative; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .content-area { flex: 1; padding: 0 !important; position: relative; overflow: hidden; background-color: #1a1b21; background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px); background-size: 20px 20px; }

        /* [Views] */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 40px; overflow-y: auto; display: none; }
        #main-dashboard-view { display: block; }

        /* [Nav Bar] */
        .folder-nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-left-group { display: flex; align-items: center; gap: 15px; }
        .breadcrumb { display: flex; align-items: center; gap: 10px; font-size: 1.2rem; color: #888; }
        .breadcrumb-item { cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .breadcrumb-item:hover { color: #fff; }
        .breadcrumb-item.active { color: var(--point-gold); cursor: default; }
        .breadcrumb-separator { color: #555; font-size: 0.8rem; }
        .nav-back-btn { width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .nav-back-btn:hover { background: var(--accent-blue); color: #fff; transform: translateY(-2px); }
        .folder-actions { display: flex; gap: 10px; }
        .search-box { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 5px 15px; color: #fff; font-family: 'BMDOHYEON'; width: 250px; transition: 0.2s; }
        .search-box:focus { border-color: var(--point-gold); width: 300px; outline: none; }

        /* [Input UI] */
        .luxury-input-wrapper { display: flex; align-items: center; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50px; padding: 5px 5px 5px 25px; width: 100%; max-width: 500px; margin: 0 0 40px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: all 0.3s; }
        .luxury-input-wrapper:focus-within { background: rgba(255, 255, 255, 0.08); border-color: var(--point-gold); transform: translateY(-2px); }
        .luxury-input { flex: 1; border: none; background: transparent; color: #fff; font-size: 1rem; font-family: 'BMDOHYEON'; outline: none; height: 40px; }
        .luxury-add-btn { background: linear-gradient(135deg, #1a1b21, #2d2d2d); color: #ccc; border: 1px solid #444; border-radius: 50px; padding: 0 25px; height: 40px; font-family: 'BMDOHYEON'; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; margin-left: 10px; }
        .luxury-add-btn:hover { background: #000; color: var(--point-gold); border-color: var(--point-gold); transform: scale(1.05); }

        /* [Folder/Grid] */
        .grid-section-title { color: #888; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 20px; font-size: 1rem; display: flex; align-items: center; gap: 8px; margin-top: 20px; }
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 25px; justify-items: center; align-items: start; }
        .folder-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 120px; padding: 10px; border-radius: 6px; transition: background 0.2s; position: relative; }
        .folder-item:hover { background-color: rgba(255, 255, 255, 0.08); }
        .folder-item:active .folder-3d { transform: scale(0.95); }
        
        .folder-3d { position: relative; width: 90px; height: 65px; perspective: 600px; margin-bottom: 10px; }
        .folder-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #d8a044; border-radius: 4px; border-top-right-radius: 4px; }
        .folder-back::after { content: ''; position: absolute; bottom: 98%; left: 0; width: 35px; height: 8px; background: #d8a044; border-radius: 4px 4px 0 0; }
        .paper { position: absolute; top: 5px; left: 5px; width: 80px; height: 55px; background: white; border-radius: 2px; transition: transform 0.3s; transform-origin: bottom; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .folder-front { position: absolute; bottom: 0; left: 0; width: 100%; height: 55px; background: linear-gradient(to bottom, #fddb72, #f3c256); border-radius: 0 0 4px 4px; border-top-right-radius: 4px; transform-origin: bottom; transition: transform 0.3s; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .folder-front::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px; background: rgba(255,255,255,0.4); }
        
        .folder-item:hover .folder-front { transform: rotateX(-25deg); }
        .folder-item:hover .paper { transform: translateY(-5px) scale(0.95); }
        
        .folder-name { color: #ddd; font-size: 0.85rem; text-align: center; line-height: 1.3; text-shadow: 0 1px 2px rgba(0,0,0,0.8); word-break: break-word; max-width: 100%; }
        .folder-count { position: absolute; top: 0; right: 0; background: var(--danger-red); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* Model Icon */
        .file-icon-wrapper { width: 80px; height: 90px; background: #eee; border-radius: 4px; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 3px 3px 5px rgba(0,0,0,0.3); margin-bottom: 10px; }
        .file-icon-wrapper::after { content: ''; position: absolute; top: 0; right: 0; border-top: 20px solid #1a1b21; border-left: 20px solid transparent; width: 0; }
        .file-type-icon { font-size: 2.5rem; color: #555; }

        /* [File Upload] */
        .file-manage-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1000px; margin: 0 auto; }
        .file-drop-zone { background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.1); border-radius: 15px; padding: 40px; text-align: center; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; }
        .file-drop-zone:hover { border-color: var(--point-gold); background: rgba(255,255,255,0.05); }
        .zone-icon { font-size: 3rem; color: #666; margin-bottom: 15px; }
        .zone-title { font-size: 1.2rem; color: #fff; margin-bottom: 5px; }
        .zone-desc { color: #888; font-size: 0.9rem; margin-bottom: 20px; font-weight: normal !important; }
        .action-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-family: 'BMDOHYEON'; transition: 0.2s; }
        .action-btn:hover { background: #1a3b8e; transform: scale(1.05); }
        .current-file-info { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; width: 100%; display: flex; justify-content: space-between; align-items: center; }

        /* [Footer] */
        .main-footer { height: 70px; background: rgba(31, 32, 41, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.15); display: flex; justify-content: space-between; align-items: center; padding: 0 30px; z-index: 100; }
        .footer-center { display: flex; gap: 20px; }
        .footer-btn { width: 45px; height: 45px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); color: #ccc; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; transition: 0.2s; }
        .footer-btn:hover { background: var(--accent-blue); color: #fff; transform: translateY(-2px); }

        /* [Context Menu] */
        #context-menu { position: absolute; z-index: 10000; width: 150px; background: #2b2c3b; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; overflow: hidden; }
        .ctx-item { padding: 10px 15px; color: #ccc; font-size: 0.9rem; cursor: pointer; transition: 0.1s; display: flex; align-items: center; gap: 8px; }
        .ctx-item:hover { background: var(--accent-blue); color: #fff; }
        .ctx-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }
    </style>
</head>

<body>
    <div id="context-menu"></div>

    <div class="page-container">
        <header class="main-header">
            <div class="header-left"><a href="index.html" class="ppms-logo-placeholder"></a></div>
            <div class="header-center"><div class="common-box">공정 기준정보 관리</div></div>
            <div class="header-right"><div class="common-box time-display" id="current-time"></div></div>
        </header>

        <main class="content-area">
            <div id="main-dashboard-view" class="view-section">
                <div class="icon-grid-container">
                    <div class="grid-section-title"><i class="uil uil-layer-group"></i> 생산 (Production)</div>
                    <div class="folder-grid">
                        <div class="folder-item" onclick="navigateTo('company_manager', {section:'production'})">
                            <div class="folder-3d"><div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div></div>
                            <div class="folder-name">업체/모델<br>통합 관리</div>
                        </div>
                        <div class="folder-item" onclick="navigateTo('manager_manager')">
                            <div class="folder-3d"><div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div></div>
                            <div class="folder-name">담당자<br>관리</div>
                        </div>
                    </div>
                    <div class="grid-section-title"><i class="uil uil-search-alt"></i> 검사 (Inspection)</div>
                    <div class="folder-grid">
                        <div class="folder-item" onclick="navigateTo('company_manager', {section:'inspection'})">
                            <div class="folder-3d"><div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div></div>
                            <div class="folder-name">BOM / 좌표<br>데이터 관리</div>
                        </div>
                    </div>
                    <div class="grid-section-title"><i class="uil uil-setting"></i> 기능 (Functions)</div>
                    <div class="folder-grid">
                        <div class="folder-item folder-gray" style="cursor:default;">
                            <div class="folder-3d"><div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div></div>
                            <div class="folder-name">시스템<br>설정</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sub-detail-view" class="view-section">
                <div class="folder-nav-bar">
                    <div class="nav-left-group">
                        <div class="breadcrumb" id="breadcrumb-container"></div>
                        <button class="nav-back-btn" onclick="goBackLevel()" title="상위 폴더로"><i class="uil uil-arrow-up"></i></button>
                    </div>
                    <div class="folder-actions">
                        <input type="text" class="search-box" id="folder-search" placeholder="검색..." onkeyup="filterFolderItems()">
                    </div>
                </div>
                <div id="sub-view-content"></div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-left"></div>
            <div class="footer-center">
                <div class="footer-btn" id="back-btn"><i class="uil uil-arrow-left"></i></div>
                <div class="footer-btn" id="home-btn"><i class="uil uil-home"></i></div>
                <div class="footer-btn" id="forward-btn"><i class="uil uil-arrow-right"></i></div>
            </div>
            <div class="footer-right"></div>
        </footer>
    </div>

    <script>
        const state = {
            currentPath: [],
            viewMode: 'dashboard'
        };
        let contextMenu = null;
        let targetItemData = null;

        document.addEventListener('DOMContentLoaded', () => {
            contextMenu = document.getElementById('context-menu');
            setupEvents(); 
            setInterval(updateTime, 1000); updateTime();
            gsap.from(".folder-item", { duration: 0.6, scale: 0.5, opacity: 0, stagger: 0.05, ease: "back.out(1.5)" });
        });

        // ================= Navigation =================
        async function navigateTo(target, data = {}) {
            const mainView = document.getElementById('main-dashboard-view');
            const subView = document.getElementById('sub-detail-view');
            const content = document.getElementById('sub-view-content');

            if (target === 'root') state.currentPath = [];
            else {
                if (target === 'company_manager') {
                    // Root 진입 시: 섹션 정보 포함
                    state.currentPath = [{ id: 'company_manager', name: '업체 목록', section: data.section }];
                } else if (target === 'manager_manager') {
                    state.currentPath = [{ id: target, name: '담당자 관리' }];
                } else if (target === 'folder_view') {
                    state.currentPath.push(data); // data contains { companyId, folderId, section... }
                } else if (target === 'file_upload') {
                    state.currentPath.push({ id: 'file_view', name: data.modelName });
                }
            }

            // View Transition
            if (target === 'root') {
                gsap.to(subView, { opacity: 0, duration: 0.3, onComplete: () => {
                    subView.style.display = 'none'; mainView.style.display = 'block';
                    gsap.fromTo(mainView, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.4 });
                }});
                return;
            }

            updateBreadcrumb();
            content.innerHTML = '<div style="text-align:center; padding:50px; color:#666;"><i class="uil uil-spinner-alt uil-spin" style="font-size:2rem;"></i><br>Loading...</div>';
            
            if (mainView.style.display !== 'none') {
                gsap.to(mainView, { opacity: 0, scale: 1.1, duration: 0.3, onComplete: () => {
                    mainView.style.display = 'none'; subView.style.display = 'block';
                    gsap.fromTo(subView, { opacity: 0 }, { opacity: 1, duration: 0.3 });
                }});
            }

            // Router
            if (target === 'company_manager') {
                await renderCompanyFolderList(data.section);
            } else if (target === 'manager_manager') {
                await renderManagerList();
            } else if (target === 'folder_view') {
                await renderRecursiveFolderView(data);
            } else if (target === 'file_upload') {
                renderFileUploadUI(data.modelId, data.modelName);
            }
        }

        function updateBreadcrumb() {
            const container = document.getElementById('breadcrumb-container');
            let html = `<div class="breadcrumb-item" onclick="navigateTo('root')"><i class="uil uil-home"></i> Home</div>`;
            state.currentPath.forEach((step, index) => {
                html += `<div class="breadcrumb-separator"><i class="uil uil-angle-right"></i></div>`;
                if (index === state.currentPath.length - 1) html += `<div class="breadcrumb-item active">${step.name}</div>`;
                else html += `<div class="breadcrumb-item" onclick="handleBreadcrumbClick(${index})">${step.name}</div>`;
            });
            container.innerHTML = html;
        }

        function handleBreadcrumbClick(index) {
            const targetStep = state.currentPath[index];
            state.currentPath = state.currentPath.slice(0, index);
            
            if (index === 0) navigateTo(targetStep.id, { section: targetStep.section });
            else navigateTo('folder_view', targetStep);
        }

        function goBackLevel() {
            if (state.currentPath.length <= 1) navigateTo('root');
            else handleBreadcrumbClick(state.currentPath.length - 2);
        }

        // ================= Rendering Logic =================

        async function renderCompanyFolderList(section) {
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/companies`);
                if (!res.ok) throw new Error("Server Error");
                const companies = await res.json();
                const content = document.getElementById('sub-view-content');
                let html = '';
                
                // [수정] 생산 섹션에서만 업체 추가 버튼 표시 (검사 섹션은 목록만)
                if (section === 'production') {
                    html += `
                        <div class="luxury-input-wrapper">
                            <input type="text" id="new-comp-name" class="luxury-input" placeholder="새 업체명 입력...">
                            <button class="luxury-add-btn" onclick="addCompany()">
                                <i class="uil uil-plus-circle"></i> 업체 추가
                            </button>
                        </div>`;
                } else {
                    html += `<div style="margin-bottom:20px; color:#888; font-size:0.9rem; text-align:center;"><i class="uil uil-info-circle"></i> 업체를 선택하여 검사 데이터를 관리하세요.</div>`;
                }

                if (companies.length === 0) {
                    html += `<div style="text-align:center; color:#666; margin-top:50px;">등록된 업체가 없습니다.</div>`;
                } else {
                    html += `<div class="folder-grid">`;
                    companies.forEach(comp => {
                        html += `
                            <div class="folder-item filter-target" onclick="enterCompany(${comp.id}, '${comp.name}', '${section}')" 
                                 data-name="${comp.name}" data-id="${comp.id}" data-type="company" data-company-id="${comp.id}">
                                <div class="folder-3d">
                                    <div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div>
                                    <span class="folder-count">${comp.model_count || 0}</span>
                                </div>
                                <div class="folder-name">${comp.name}</div>
                            </div>`;
                    });
                    html += `</div>`;
                }
                content.innerHTML = html;
                gsap.from(".folder-item", { scale: 0.5, opacity: 0, stagger: 0.05, ease: "back.out(1.5)" });
            } catch (e) { content.innerHTML = '<div style="text-align:center; padding:20px;">서버 연결 오류</div>'; }
        }

        window.enterCompany = (id, name, section) => {
            // folderId: null -> 해당 섹션의 최상위 폴더 조회
            navigateTo('folder_view', { companyId: id, folderId: null, name: name, section: section }); 
        };

        async function renderRecursiveFolderView(data) {
            const { companyId, folderId, section } = data;
            try {
                const queryFolder = folderId ? folderId : '';
                const res = await fetch(`http://127.0.0.1:5000/api/production/directory?company_id=${companyId}&folder_id=${queryFolder}&section=${section}`);
                const result = await res.json();
                const content = document.getElementById('sub-view-content');
                let html = '';

                if (result.folders.length === 0 && result.models.length === 0) {
                    html += `<div style="text-align:center; color:#666; margin-top:50px;">비어 있음</div>`;
                } else {
                    html += `<div class="folder-grid">`;
                    
                    // 폴더
                    result.folders.forEach(folder => {
                        html += `
                            <div class="folder-item filter-target" onclick="enterSubFolder(${companyId}, ${folder.id}, '${folder.name}', '${section}')"
                                 data-name="${folder.name}" data-id="${folder.id}" data-type="folder" data-company-id="${companyId}" data-section="${section}">
                                <div class="folder-3d">
                                    <div class="folder-back"></div><div class="paper"></div><div class="folder-front"></div>
                                </div>
                                <div class="folder-name">${folder.name}</div>
                            </div>`;
                    });

                    // 모델
                    result.models.forEach(model => {
                        html += `
                            <div class="folder-item filter-target" onclick="navigateTo('file_upload', {modelId:${model.id}, modelName:'${model.name}'})" 
                                 data-name="${model.name}" data-id="${model.id}" data-type="model" data-company-id="${companyId}" data-section="${section}">
                                <div class="file-icon-wrapper"><i class="uil uil-file-alt file-type-icon"></i></div>
                                <div class="folder-name">${model.name}</div>
                            </div>`;
                    });
                    html += `</div>`;
                }
                content.innerHTML = html;
                gsap.from(".folder-item", { y: 20, opacity: 0, stagger: 0.05 });
            } catch (e) { console.error(e); }
        }

        window.enterSubFolder = (compId, folderId, name, section) => {
            navigateTo('folder_view', { companyId: compId, folderId: folderId, name: name, section: section });
        };

        function renderFileUploadUI(modelId, modelName) {
            const content = document.getElementById('sub-view-content');
            content.innerHTML = `
                <div class="file-manage-container">
                    <div class="file-drop-zone" id="zone-bom">
                        <i class="uil uil-list-ul zone-icon"></i><div class="zone-title">BOM 파일</div>
                        <div class="zone-desc">엑셀(.xlsx) 또는 CSV 파일을 등록하세요.</div>
                        <input type="file" id="file-bom" hidden onchange="handleFileSelect(this, 'bom', ${modelId})">
                        <button class="action-btn" onclick="document.getElementById('file-bom').click()">파일 선택</button>
                        <div class="current-file-info" id="info-bom">로딩 중...</div>
                    </div>
                    <div class="file-drop-zone" id="zone-coord">
                        <i class="uil uil-crosshair zone-icon"></i><div class="zone-title">좌표 데이터</div>
                        <div class="zone-desc">마운터 좌표 데이터를 등록하세요.</div>
                        <input type="file" id="file-coord" hidden onchange="handleFileSelect(this, 'coord', ${modelId})">
                        <button class="action-btn" onclick="document.getElementById('file-coord').click()">파일 선택</button>
                        <div class="current-file-info" id="info-coord">로딩 중...</div>
                    </div>
                </div>`;
            loadFileInfo(modelId, 'BOM'); loadFileInfo(modelId, 'COORDINATE');
        }

        async function renderManagerList() {
            const content = document.getElementById('sub-view-content');
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/managers`);
                const items = await res.json();
                let html = `
                    <div class="luxury-input-wrapper">
                        <input type="text" id="new-mgr-name" class="luxury-input" placeholder="새 담당자명 입력...">
                        <button class="luxury-add-btn" onclick="addManager()">
                            <i class="uil uil-user-plus"></i> 담당자 추가
                        </button>
                    </div>
                    <div class="folder-grid">`;
                items.forEach(item => {
                    html += `
                        <div class="folder-item filter-target" data-name="${item.name}" onclick="deleteManager(${item.id})">
                            <i class="uil uil-times-circle" style="color:#ff4444; position:absolute; top:0; right:0; font-size:1.2rem; z-index:10;"></i>
                            <div class="folder-3d">
                                <div class="folder-back" style="background:#4a69bd;"></div><div class="paper"></div><div class="folder-front" style="background:linear-gradient(#6a89cc, #4a69bd);"></div>
                            </div>
                            <div class="folder-name">${item.name}</div>
                        </div>`;
                });
                html += `</div>`; content.innerHTML = html;
            } catch (e) { }
        }

        // ================= Action Functions =================
        async function addCompany() {
            const v = document.getElementById('new-comp-name').value;
            if (!v) return;
            await fetch(`http://127.0.0.1:5000/api/production/companies`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: v }) });
            renderCompanyFolderList('production');
        }
        async function addManager() {
            const v = document.getElementById('new-mgr-name').value;
            if (!v) return;
            await fetch(`http://127.0.0.1:5000/api/production/managers`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: v }) });
            renderManagerList();
        }
        async function deleteManager(id) {
            if (confirm('삭제?')) {
                await fetch(`http://127.0.0.1:5000/api/production/managers/${id}`, { method: 'DELETE' });
                renderManagerList();
            }
        }
        async function handleFileSelect(input, typeCode, modelId) {
            const file = input.files[0]; if (!file) return;
            const fd = new FormData(); fd.append('file', file); fd.append('type', typeCode === 'bom' ? 'BOM' : 'COORDINATE');
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/${modelId}/data`, { method: 'POST', body: fd });
                if (res.ok) { alert('업로드 완료'); loadFileInfo(modelId, typeCode === 'bom' ? 'BOM' : 'COORDINATE'); } else alert('실패');
            } catch (e) { alert('에러'); }
        }
        async function loadFileInfo(modelId, type) {
            const typeCode = type === 'BOM' ? 'bom' : 'coord';
            const infoDiv = document.getElementById(`info-${typeCode}`);
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/models/${modelId}/data?type=${type}`);
                const data = await res.json();
                if (data.length > 0) {
                    infoDiv.innerHTML = `<div style="font-size:0.8rem; color:#fff;"><i class="uil uil-check-circle" style="color:#00e676;"></i> ${data[0].fileName}</div>
                    <a href="http://127.0.0.1:5000/api/production/download/${data[0].content}" class="small-btn" style="background:rgba(255,255,255,0.1); color:#ccc; text-decoration:none; display:flex; align-items:center;"><i class="uil uil-download-alt"></i></a>`;
                } else infoDiv.innerHTML = `<span style="color:#666; font-size:0.8rem;">파일 없음</span>`;
            } catch (e) { }
        }

        // ================= Context Menu Logic =================
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const folderItem = e.target.closest('.folder-item');
            const bgArea = e.target.closest('.view-section');

            if (folderItem) {
                const { id, name, type, companyId, section } = folderItem.dataset;
                targetItemData = { id, name, type, companyId, section };
                showContextMenu(e.pageX, e.pageY, 'item');
            } else if (bgArea) {
                targetItemData = null;
                if (state.currentPath.length > 0) showContextMenu(e.pageX, e.pageY, 'bg');
            } else {
                if(contextMenu) contextMenu.style.display = 'none';
            }
        });

        document.addEventListener('click', () => { if(contextMenu) contextMenu.style.display = 'none'; });

        // [수정] 우클릭 메뉴 조건 엄격화
        function showContextMenu(x, y, mode) {
            let html = '';
            const lastPath = state.currentPath[state.currentPath.length - 1];

            if (mode === 'item') {
                html = `<div class="ctx-item" onclick="handleCtxOpen()"><i class="uil uil-folder-open"></i> 열기</div>
                        <div class="ctx-item" onclick="handleCtxRename()"><i class="uil uil-pen"></i> 이름 변경</div>
                        <div class="ctx-divider"></div>
                        <div class="ctx-item" style="color:#ff4444;" onclick="handleCtxDelete()"><i class="uil uil-trash-alt"></i> 삭제</div>`;
            } else if (mode === 'bg') {
                
                // [조건] 회사(Company) 내부에 있을 때만(companyId가 있을 때만) 폴더/모델 추가 가능
                if (lastPath.companyId) {
                    html = `
                        <div class="ctx-item" onclick="handleCtxAdd('folder')"><i class="uil uil-folder-plus"></i> 새 폴더</div>
                        <div class="ctx-item" onclick="handleCtxAdd('model')"><i class="uil uil-file-plus-alt"></i> 새 모델</div>
                    `;
                } 
                // [조건] 최상위(Root)이면서 Production 섹션일 때만 업체 추가 가능
                else if (lastPath.id === 'company_manager' && lastPath.section === 'production') {
                    html = `<div class="ctx-item" onclick="handleCtxAdd('company')"><i class="uil uil-building"></i> 새 업체</div>`;
                }
            }

            if (html && contextMenu) {
                contextMenu.innerHTML = html;
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
            }
        }

        window.handleCtxOpen = function() {
            if (!targetItemData) return;
            const sec = targetItemData.section || 'production';
            
            if (targetItemData.type === 'company') {
                navigateTo('folder_view', { companyId: targetItemData.id, folderId: null, name: targetItemData.name, section: sec });
            } else if (targetItemData.type === 'folder') {
                navigateTo('folder_view', { companyId: targetItemData.companyId, folderId: targetItemData.id, name: targetItemData.name, section: sec });
            } else if (targetItemData.type === 'model') {
                navigateTo('file_upload', { modelId: targetItemData.id, modelName: targetItemData.name });
            }
        };

        window.handleCtxRename = async function() {
            if (!targetItemData) return;
            const newName = prompt('새 이름을 입력하세요:', targetItemData.name);
            if (!newName || newName === targetItemData.name) return;
            
            let endpoint = '';
            if (targetItemData.type === 'company') endpoint = 'companies';
            else if (targetItemData.type === 'folder') endpoint = 'folders';
            else if (targetItemData.type === 'model') endpoint = 'models';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/${endpoint}/${targetItemData.id}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: newName })
                });
                if (res.ok) refreshCurrentView(); else alert('수정 실패');
            } catch (e) { alert('오류 발생'); }
        };

        window.handleCtxDelete = async function() {
            if (!targetItemData) return;
            if (!confirm(`'${targetItemData.name}'을(를) 삭제하시겠습니까?`)) return;
            
            let endpoint = '';
            if (targetItemData.type === 'company') endpoint = 'companies';
            else if (targetItemData.type === 'folder') endpoint = 'folders';
            else if (targetItemData.type === 'model') endpoint = 'models';

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/production/${endpoint}/${targetItemData.id}`, { method: 'DELETE' });
                if (res.ok) refreshCurrentView(); else alert('삭제 실패');
            } catch (e) { alert('오류 발생'); }
        };

        window.handleCtxAdd = async function(addType) {
            const currentStep = state.currentPath[state.currentPath.length - 1];
            
            if (addType === 'company') {
                const name = prompt('새 업체명:');
                if(name) {
                    await fetch(`http://127.0.0.1:5000/api/production/companies`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
                    refreshCurrentView();
                }
                return;
            }

            const name = prompt(`새 ${addType === 'folder' ? '폴더' : '모델'} 이름:`);
            if (!name) return;

            const companyId = currentStep.companyId;
            const folderId = currentStep.folderId;
            const section = currentStep.section; 

            let url = '';
            let body = {};

            if (addType === 'folder') {
                url = `http://127.0.0.1:5000/api/production/folders`;
                body = { name: name, company_id: companyId, parent_folder_id: folderId, section: section };
            } else {
                url = `http://127.0.0.1:5000/api/production/models`;
                body = { name: name, company_id: companyId, folder_id: folderId };
            }

            try {
                await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                refreshCurrentView();
            } catch(e) { alert('생성 오류'); }
        };

        function refreshCurrentView() {
            const lastPath = state.currentPath[state.currentPath.length - 1];
            if (lastPath.id === 'company_manager') navigateTo('company_manager', { section: lastPath.section });
            else if (lastPath.id === 'manager_manager') navigateTo('manager_manager');
            else navigateTo('folder_view', lastPath);
        }

        window.filterFolderItems = function() {
            const text = document.getElementById('folder-search').value.toLowerCase();
            document.querySelectorAll('.filter-target').forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                item.style.display = name.includes(text) ? 'flex' : 'none';
            });
        };

        function setupEvents() {
            document.getElementById('back-btn').addEventListener('click', () => { if (state.currentPath.length > 0) goBackLevel(); else history.back(); });
            document.getElementById('home-btn').addEventListener('click', () => location.href = 'index.html');
            document.getElementById('forward-btn').addEventListener('click', () => history.forward());
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>